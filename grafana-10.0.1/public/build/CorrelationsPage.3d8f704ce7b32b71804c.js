"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[413],{84306:(Ce,R,r)=>{r.r(R),r.d(R,{default:()=>He});var m=r(9892),N=r(82897),e=r(66111),D=r(41818),w=r(54899),G=r(13626),S=r(31403),U=r(61744),f=r(45253),M=r(65455),C=r(72648),j=r(19985),B=r(8412),J=r(77582),H=r(76770),k=r(27876),Y=r(72080),$=r(50796),p=r(66698);const P=(0,e.createContext)(void 0);function X(t){const[a,s]=(0,e.useState)(0),{pages:i,onSubmit:n,children:l}=t;return e.createElement(P.Provider,{value:{currentPage:a,CurrentPageComponent:i[a],isLastPage:a===i.length-1,nextPage:()=>s(a+1),prevPage:()=>s(a-1),onSubmit:n}},l)}const ne=()=>{const t=(0,e.useContext)(P);if(!t)throw new Error("useWizardContext must be used within a WizardContextProvider");return t};function xe(t){const{navigation:a}=t,{handleSubmit:s}=(0,p.Gc)(),{CurrentPageComponent:i,isLastPage:n,nextPage:l,onSubmit:u}=ne(),c=a;return e.createElement("form",{onSubmit:s(v=>{n?u(v):l()})},e.createElement(i,null),e.createElement(c,null))}function oe(t){const{defaultValues:a,pages:s,onSubmit:i,navigation:n}=t,l=(0,p.cI)({defaultValues:a});return e.createElement(p.RV,{...l},e.createElement(X,{pages:s,onSubmit:i},e.createElement(xe,{navigation:n})))}var q=r(80414),_=r(13393),x=r(24799),V=r(46967),be=r(97379);const se=(0,e.createContext)({loading:!1,correlation:void 0,readOnly:!1}),le=t=>{const{data:a,children:s}=t;return e.createElement(se.Provider,{value:a},s)},Q=()=>(0,e.useContext)(se),ee=(t,a)=>a?`${t}_${a.sourceUID}-${a.uid}`:t,Ie=t=>({label:m.css`
    max-width: ${t.spacing(80)};
  `,description:m.css`
    max-width: ${t.spacing(80)};
  `}),ie=()=>{const{register:t,formState:a}=(0,p.Gc)(),s=(0,C.wW)(Ie),{correlation:i,readOnly:n}=Q();return e.createElement(e.Fragment,null,e.createElement(_.C,{label:"Define correlation name (1/3)"},e.createElement("p",null,"The name of the correlation is used as the label of the link."),e.createElement("input",{type:"hidden",...t("config.type")}),e.createElement(x.g,{label:"Label",description:"This name is be used as the label of the link button",className:s.label,invalid:!!a.errors.label,error:a.errors.label?.message},e.createElement(V.I,{id:ee("label",i),...t("label",{required:{value:!0,message:"This field is required."}}),readOnly:n,placeholder:"e.g. Tempo traces"})),e.createElement(x.g,{label:"Description",description:"Optional description with more information about the link",className:(0,m.cx)(s.description)},e.createElement(be.K,{id:ee("description",i),...t("description"),readOnly:n}))))};var ce=r(53117),F=r(72948),Se=r(91162),Te=r(41611),z=r(3281),A=r(26418),De=r(70132),Z=r(64353),K=r(61860),W=r(39904),$e=r(63619),Pe=r(8581),Fe=r(8180);const Ae=t=>({heading:m.css`
    font-size: ${t.typography.h5.fontSize};
    font-weight: ${t.typography.fontWeightRegular};
  `,removeButton:m.css`
    margin-top: 25px;
  `}),Oe=t=>{const{control:a,formState:s,register:i,setValue:n,watch:l,getValues:u}=(0,p.Gc)(),{readOnly:c}=t,[v,b]=(0,e.useState)([]),d=(0,C.wW)(Ae),h=Le();return e.createElement(e.Fragment,null,e.createElement("input",{type:"hidden",...i("id")}),e.createElement(De.F,{name:"config.transformations",control:a},({fields:y,append:E,remove:L})=>e.createElement(e.Fragment,null,e.createElement(A.Stack,{direction:"column",alignItems:"flex-start"},e.createElement("div",{className:d.heading},"Transformations"),y.length===0&&e.createElement("div",null," No transformations defined."),y.length>0&&e.createElement("div",null,y.map((g,o)=>e.createElement(A.Stack,{direction:"row",key:g.id,alignItems:"top"},e.createElement(x.g,{label:e.createElement(A.Stack,{gap:.5},e.createElement(Z._,{htmlFor:`config.transformations.${g.id}-${o}.type`},"Type"),e.createElement(K.u,{content:e.createElement("div",null,e.createElement("p",null,"The type of transformation that will be applied to the source data."))},e.createElement(W.J,{name:"info-circle",size:"sm"}))),invalid:!!s.errors?.config?.transformations?.[o]?.type,error:s.errors?.config?.transformations?.[o]?.type?.message,validationMessageHorizontalOverflow:!0},e.createElement($e.g,{render:({field:{onChange:T,ref:I,...ae}})=>e.createElement(Pe.Ph,{...ae,value:g.type,onChange:Ee=>{if(!c){const he=u().config.transformations[o];let re=(0,N.fill)(Array(o+1),{});v.forEach((_e,et)=>re[et]=_e),re[o]={expression:he.expression,mapValue:he.mapValue},b(re);const ye=O(Ee.value);ye.showExpression?n(`config.transformations.${o}.expression`,v[o]?.expression||""):n(`config.transformations.${o}.expression`,""),ye.showMapValue?n(`config.transformations.${o}.mapValue`,v[o]?.mapValue||""):n(`config.transformations.${o}.mapValue`,""),T(Ee.value)}},options:h,width:25,inputId:`config.transformations.${g.id}-${o}.type`}),control:a,name:`config.transformations.${o}.type`,rules:{required:{value:!0,message:"Please select a transformation type"}}})),e.createElement(x.g,{label:e.createElement(A.Stack,{gap:.5},e.createElement(Z._,{htmlFor:`config.transformations.${g.id}.field`},"Field"),e.createElement(K.u,{content:e.createElement("div",null,e.createElement("p",null,"Optional. The field to transform. If not specified, the transformation will be applied to the results field."))},e.createElement(W.J,{name:"info-circle",size:"sm"})))},e.createElement(V.I,{...i(`config.transformations.${o}.field`),readOnly:c,defaultValue:g.field,label:"field",id:`config.transformations.${g.id}.field`})),e.createElement(x.g,{label:e.createElement(A.Stack,{gap:.5},e.createElement(Z._,{htmlFor:`config.transformations.${g.id}.expression`},"Expression",O(l(`config.transformations.${o}.type`)).requireExpression?" *":""),e.createElement(K.u,{content:e.createElement("div",null,e.createElement("p",null,"Required for regular expression. The expression the transformation will use. Logfmt does not use further specifications."))},e.createElement(W.J,{name:"info-circle",size:"sm"}))),invalid:!!s.errors?.config?.transformations?.[o]?.expression,error:s.errors?.config?.transformations?.[o]?.expression?.message},e.createElement(V.I,{...i(`config.transformations.${o}.expression`,{required:O(l(`config.transformations.${o}.type`)).requireExpression?"Please define an expression":void 0}),defaultValue:g.expression,readOnly:c,disabled:!O(l(`config.transformations.${o}.type`)).showExpression,id:`config.transformations.${g.id}.expression`})),e.createElement(x.g,{label:e.createElement(A.Stack,{gap:.5},e.createElement(Z._,{htmlFor:`config.transformations.${g.id}.mapValue`},"Map value"),e.createElement(K.u,{content:e.createElement("div",null,e.createElement("p",null,"Optional. Defines the name of the variable. This is currently only valid for regular expressions with a single, unnamed capture group."))},e.createElement(W.J,{name:"info-circle",size:"sm"})))},e.createElement(V.I,{...i(`config.transformations.${o}.mapValue`),defaultValue:g.mapValue,readOnly:c,disabled:!O(l(`config.transformations.${o}.type`)).showMapValue,id:`config.transformations.${g.id}.mapValue`})),!c&&e.createElement("div",{className:d.removeButton},e.createElement(Fe.h,{type:"button",tooltip:"Remove transformation",name:"trash-alt",onClick:()=>{L(o);const T=[...v];T[o]=void 0,b((0,N.compact)(T))},ariaLabel:"Remove transformation"},"Remove"))))),!c&&e.createElement(S.zx,{icon:"plus",onClick:()=>E({type:void 0},{shouldFocus:!1}),variant:"secondary",type:"button"},"Add transformation")))))};function O(t){switch(t){case z.sN.Logfmt:return{label:"Logfmt",value:z.sN.Logfmt,description:"Parse provided field with logfmt to get variables",showExpression:!1,showMapValue:!1};case z.sN.Regex:return{label:"Regular expression",value:z.sN.Regex,description:"Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value.",showExpression:!0,showMapValue:!0,requireExpression:!0};default:return{label:t,value:t,showExpression:!1,showMapValue:!1}}}const Le=()=>Object.values(z.sN).map(t=>{const a=O(t);return{label:a.label,value:a.value,description:a.description}}),Ne=t=>({label:m.css`
    max-width: ${t.spacing(80)};
  `,variable:m.css`
    font-family: ${t.typography.fontFamilyMonospace};
    font-weight: ${t.typography.fontWeightMedium};
  `}),ue=()=>{const{control:t,formState:a,register:s,getValues:i}=(0,p.Gc)(),n=(0,C.wW)(Ne),l=d=>h=>d(h.uid),{correlation:u,readOnly:c}=Q(),v=i("config.target"),b=(0,Te.lt)(v,{}).variables.map(d=>d.variableName+(d.fieldPath?`.${d.fieldPath}`:""));return e.createElement(e.Fragment,null,e.createElement(_.C,{label:"Configure source data source (3/3)"},e.createElement("p",null,"Links are displayed with results of the selected origin source data. They show along with the value of the provided ",e.createElement("em",null,"results field"),"."),e.createElement(p.Qr,{control:t,name:"sourceUID",rules:{required:{value:!0,message:"This field is required."},validate:{writable:d=>!(0,Se.ak)().getInstanceSettings(d)?.readOnly||"Source can't be a read-only data source."}},render:({field:{onChange:d,value:h}})=>e.createElement(x.g,{label:"Source",description:"Results from selected source data source have links displayed in the panel",htmlFor:"source",invalid:!!a.errors.sourceUID,error:a.errors.sourceUID?.message},e.createElement(ce.q,{onChange:l(d),noDefault:!0,current:h,inputId:"source",width:32,disabled:u!==void 0}))}),e.createElement(x.g,{label:"Results field",description:"The link will be shown next to the value of this field",className:n.label,invalid:!!a.errors?.config?.field,error:a.errors?.config?.field?.message},e.createElement(V.I,{id:ee("field",u),...s("config.field",{required:"This field is required."}),readOnly:c})),b.length>0&&e.createElement(F.Z,null,e.createElement(F.Z.Heading,null,"Variables used in the target query"),e.createElement(F.Z.Description,null,"You have used following variables in the target query:"," ",b.map((d,h)=>e.createElement("span",{className:n.variable,key:h},d,h<b.length-1?", ":"")),e.createElement("br",null),"A data point needs to provide values to all variables as fields or as transformations output to make the correlation button appear in the visualization.",e.createElement("br",null),"Note: Not every variable needs to be explicitly defined below. A transformation such as"," ",e.createElement("span",{className:n.variable},"logfmt")," will create variables for every key/value pair.")),e.createElement(Oe,{readOnly:c})))};var we=r(59679),de=r(206),Me=r(75849),Ve=r(86647),me=r(52081),ze=r(57227),We=r(55935),Re=r(75434);function Ue(t){return{valid:m.css`
      color: ${t.colors.success.text};
    `}}const Be=({dsUid:t,invalid:a,error:s,name:i})=>{const[n,l]=(0,e.useState)(void 0),u=(0,C.wW)(Ue),{value:c,loading:v,error:b}=(0,we.Z)(async()=>{if(t)return(0,Ve.F)().get(t)},[t]),d=c?.components?.QueryEditor,h=y=>{const E="1s",g=(0,We.HI)(),o=[{...y,refId:"A"}],T={queries:o,request:{app:de.zj.Correlations,timezone:"utc",startTime:Date.now(),interval:E,intervalMs:1e3,targets:o,range:(0,Me.JK)(),requestId:"correlations_"+g,scopedVars:{__interval:{text:E,value:E},__interval_ms:{text:1e3,value:1e3}}},id:g,done:!1};c&&(0,Re.v7)(c,T.request).subscribe(I=>{!I||I.state==="Error"||I.state==="Done"&&I.series.length===0?l(!1):I.state==="Done"&&I.series.length>0&&Boolean(I.series.find(ae=>ae.length>0))?l(!0):l(void 0)})};return e.createElement(x.g,{label:"Query",description:e.createElement("span",null,"Define the query that is run when the link is clicked. You can use"," ",e.createElement("a",{href:"https://grafana.com/docs/grafana/latest/panels-visualizations/configure-data-links/",target:"_blank",rel:"noreferrer"},"variables")," ","to access specific field values."),invalid:a,error:s},e.createElement(p.Qr,{name:i,rules:{validate:{hasQueryEditor:()=>d!==void 0||"The selected target data source must export a query editor."}},render:({field:{value:y,onChange:E}})=>v?e.createElement(U.u,{text:"Loading query editor..."}):b?e.createElement(f.b,{title:"Error loading data source"},"The selected data source could not be loaded."):c?d?e.createElement(e.Fragment,null,e.createElement(d,{app:de.zj.Correlations,onRunQuery:()=>h(y),onChange:L=>{l(void 0),E(L)},datasource:c,query:y}),e.createElement(me.Lh,{justify:"flex-end"},n?e.createElement("div",{className:u.valid},e.createElement(W.J,{name:"check"})," This query is valid."):n===!1?e.createElement(ze.S,null,"This query is not valid."):null,e.createElement(S.zx,{variant:"secondary",icon:"check",type:"button",onClick:()=>h(y)},"Validate query"))):e.createElement(f.b,{title:"Data source does not export a query editor."}):e.createElement(f.b,{title:"No data source selected",severity:"info"},"Please select a target data source first.")}))},fe=()=>{const{control:t,formState:a}=(0,p.Gc)(),s=l=>u=>l(u.uid),{correlation:i}=Q(),n=(0,p.qo)({name:"targetUID"})||i?.targetUID;return e.createElement(e.Fragment,null,e.createElement(_.C,{label:"Setup target query (2/3)"},e.createElement("p",null,"Clicking on a link runs a provided target query."),e.createElement(p.Qr,{control:t,name:"targetUID",rules:{required:{value:!0,message:"This field is required."}},render:({field:{onChange:l,value:u}})=>e.createElement(x.g,{label:"Target",description:"Specify which data source is queried when the link is clicked",htmlFor:"target",invalid:!!a.errors.targetUID,error:a.errors.targetUID?.message},e.createElement(ce.q,{onChange:s(l),noDefault:!0,current:u,inputId:"target",width:32,disabled:i!==void 0}))}),e.createElement(Be,{name:"config.target",dsUid:n,invalid:!!a.errors?.config?.target,error:a.errors?.config?.target?.message})))},ge=()=>{const{currentPage:t,prevPage:a,isLastPage:s}=ne(),{readOnly:i,loading:n,correlation:l}=Q(),u=!i&&e.createElement(S.zx,{variant:"primary",icon:n?"fa fa-spinner":"save",type:"submit",disabled:n},l===void 0?"Add":"Save"),c=e.createElement(S.zx,{variant:"secondary",type:"submit"},"Next");return e.createElement(me.Lh,{justify:"flex-end"},t>0?e.createElement(S.zx,{variant:"secondary",onClick:a},"Back"):void 0,s?u:c)},Qe=t=>({panelContainer:m.css`
    position: relative;
    padding: ${t.spacing(1)};
    margin-bottom: ${t.spacing(2)};
  `,infoBox:m.css`
    margin-top: 20px; // give space for close button
  `}),Ze=({onClose:t,onCreated:a})=>{const s=(0,C.wW)(Qe),{create:{execute:i,loading:n,error:l,value:u}}=(0,q.K)();(0,e.useEffect)(()=>{!l&&!n&&u&&a()},[l,n,u,a]);const c={config:{type:"query",target:{},field:""}};return e.createElement(Y.l,{className:s.panelContainer},e.createElement($.P,{onClick:t}),e.createElement(le,{data:{loading:n,readOnly:!1,correlation:void 0}},e.createElement(oe,{defaultValues:c,pages:[ie,fe,ue],navigation:ge,onSubmit:i})))},Ke=({onUpdated:t,correlation:a,readOnly:s=!1})=>{const{update:{execute:i,loading:n,error:l,value:u}}=(0,q.K)(),c=v=>i({...v,sourceUID:a.sourceUID,uid:a.uid});return(0,e.useEffect)(()=>{!l&&!n&&u&&t()},[l,n,u,t]),e.createElement(le,{data:{loading:n,readOnly:s,correlation:a}},e.createElement(oe,{defaultValues:a,pages:[ie,fe,ue],onSubmit:s?v=>()=>{}:c,navigation:ge}))};var Ge=r(69142);const je=({onClick:t,canWriteCorrelations:a})=>a?e.createElement(Ge.Z,{title:"You haven't defined any correlation yet.",buttonIcon:"gf-glue",onClick:t,buttonTitle:"Add correlation",proTip:"you can also define correlations via datasource provisioning"}):e.createElement(F.Z,null,e.createElement(F.Z.Heading,null,"There are no correlations configured yet."),e.createElement(F.Z.Description,null,"Please contact your administrator to create new correlations.")),pe=(t,a,s)=>t.values[s].name.localeCompare(a.values[s].name),te=({source:t})=>t.readOnly,Je=m.css`
  display: flex;
  justify-content: center;
`;function He(){const t=(0,H.q)("correlations"),[a,s]=(0,e.useState)(!1),i=o=>{s(o),o&&(0,D.ff)("grafana_correlations_adding_started")},{remove:n,get:{execute:l,...u}}=(0,q.K)();(0,e.useEffect)(()=>{l()},[]);const c=J.Vt.hasPermission(k.AccessControlAction.DataSourcesWrite),v=(0,e.useCallback)(()=>{(0,D.ff)("grafana_correlations_added"),l(),i(!1)},[l]),b=(0,e.useCallback)(()=>{(0,D.ff)("grafana_correlations_edited"),l()},[l]),d=(0,e.useCallback)(o=>{n.execute(o)},[n]);(0,e.useEffect)(()=>{n.value&&(0,D.ff)("grafana_correlations_deleted")},[n.value]),(0,e.useEffect)(()=>{!n.error&&!n.loading&&n.value&&l()},[n.error,n.loading,n.value,l]);const h=(0,e.useCallback)(({row:{original:{source:{uid:o,readOnly:T},uid:I}}})=>!T&&e.createElement(G.m,{"aria-label":"delete correlation",onConfirm:()=>d({sourceUID:o,uid:I}),closeOnConfirm:!0}),[d]),y=(0,e.useMemo)(()=>[{id:"info",cell:qe,disableGrow:!0,visible:o=>o.some(te)},{id:"source",header:"Source",cell:ve,sortType:pe},{id:"target",header:"Target",cell:ve,sortType:pe},{id:"label",header:"Label",sortType:"alphanumeric"},{id:"actions",cell:h,disableGrow:!0,visible:o=>c&&o.some((0,N.negate)(te))}],[h,c]),E=(0,e.useMemo)(()=>u.value,[u.value]),L=E?.length===0&&!a&&!u.error,g=c&&E?.length!==0&&E!==void 0&&!a&&e.createElement(S.zx,{icon:"plus",onClick:()=>i(!0)},"Add new");return e.createElement(B.T,{navModel:t,subTitle:"Define how data living in different data sources relates to each other.",actions:g},e.createElement(B.T.Contents,null,e.createElement("div",null,!E&&u.loading&&e.createElement("div",{className:Je},e.createElement(U.u,{text:"loading..."})),L&&e.createElement(je,{canWriteCorrelations:c,onClick:()=>i(!0)}),u.error&&e.createElement(f.b,{severity:"error",title:"Error fetching correlation data",topSpacing:2},(0,w.kW)(u.error)&&u.error.data?.message||"An unknown error occurred while fetching correlation data. Please try again."),a&&e.createElement(Ze,{onClose:()=>i(!1),onCreated:v}),E&&E.length>=1&&e.createElement(M.e,{renderExpandedRow:o=>e.createElement(ke,{correlation:o,onUpdated:b,readOnly:te({source:o.source})||!c}),columns:y,data:E,getRowId:o=>`${o.source.uid}-${o.uid}`}))))}function ke({correlation:{source:t,target:a,...s},readOnly:i,onUpdated:n}){return(0,e.useEffect)(()=>(0,D.ff)("grafana_correlations_details_expanded"),[]),e.createElement(Ke,{correlation:{...s,sourceUID:t.uid,targetUID:a.uid},onUpdated:n,readOnly:i})}const Ye=t=>({root:m.css`
    display: flex;
    align-items: center;
  `,dsLogo:m.css`
    margin-right: ${t.spacing()};
    height: 16px;
    width: 16px;
  `}),ve=(0,e.memo)(function({cell:{value:a}}){const s=(0,C.wW)(Ye);return e.createElement("span",{className:s.root},e.createElement("img",{src:a.meta.info.logos.small,alt:"",className:s.dsLogo}),a.name)},({cell:{value:t}},{cell:{value:a}})=>t.type===a.type&&t.name===a.name),Xe=m.css`
  white-space: nowrap;
`,qe=(0,e.memo)(function({...a}){return a.row.original.source.readOnly?e.createElement(j.C,{text:"Read only",color:"purple",className:Xe}):null},(t,a)=>t.row.original.source.readOnly===a.row.original.source.readOnly)},80414:(Ce,R,r)=>{r.d(R,{K:()=>U});var m=r(13821),N=r(65583),e=r(86647),D=r(34177);const w=({sourceUID:f,targetUID:M,...C})=>({...C,source:(0,e.F)().getInstanceSettings(f),target:(0,e.F)().getInstanceSettings(M)}),G=f=>f.map(w);function S(f){return f.data}const U=()=>{const{backend:f}=(0,D.p)(),[M,C]=(0,m.Z)(()=>(0,N.n)(f.fetch({url:"/api/datasources/correlations",method:"GET",showErrorAlert:!1})).then(S).then(G),[f]),[j,B]=(0,m.Z)(({sourceUID:$,...p})=>f.post(`/api/datasources/uid/${$}/correlations`,p).then(P=>w(P.result)),[f]),[J,H]=(0,m.Z)(({sourceUID:$,uid:p})=>f.delete(`/api/datasources/uid/${$}/correlations/${p}`),[f]),[k,Y]=(0,m.Z)(({sourceUID:$,uid:p,...P})=>f.patch(`/api/datasources/uid/${$}/correlations/${p}`,P).then(X=>w(X.result)),[f]);return{create:{execute:B,...j},update:{execute:Y,...k},get:{execute:C,...M},remove:{execute:H,...J}}}}}]);

//# sourceMappingURL=CorrelationsPage.3d8f704ce7b32b71804c.js.map