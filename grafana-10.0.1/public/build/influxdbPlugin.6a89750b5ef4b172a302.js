"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5783],{9722:(Rr,ce,g)=>{g.r(ce),g.d(ce,{plugin:()=>Ar});var We=g(89424),f=g(82897),s=g(66111),I=g(73446),Ge=g(14835),T=g(19426),me=g(17784),k=g(8581),ze=g(45253),Ue=g(12006),He=g(81764),U=g(47694);const de="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.";var R=(r=>(r.InfluxQL="InfluxQL",r.Flux="Flux",r))(R||{});const{Input:L,SecretFormField:ge}=Ge.LegacyForms,fe=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],H=[{label:"InfluxQL",value:R.InfluxQL,description:"The InfluxDB SQL-like query language."},{label:"Flux",value:R.Flux,description:"Advanced data scripting and query language.  Supported in InfluxDB 2.x and 1.8+"}];class Ke extends s.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.onResetPassword=()=>{(0,I.Mf)(this.props,"password")},this.onResetToken=()=>{(0,I.Mf)(this.props,"token")},this.onVersionChanged=t=>{const{options:a,onOptionsChange:n}=this.props,l={...a,jsonData:{...a.jsonData,version:t.value}};t.value===R.Flux&&(l.access="proxy",l.basicAuth=!0,l.jsonData.httpMode="POST",delete l.user,delete l.database),n(l)},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,f.uniqueId)("influxdb-config")}renderInflux2x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{},{htmlPrefix:n}=this;return s.createElement(s.Fragment,null,s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{htmlFor:`${n}-org`,className:"width-10"},"Organization"),s.createElement("div",{className:"width-10"},s.createElement(L,{id:`${n}-org`,className:"width-20",value:e.jsonData.organization||"",onChange:(0,I._R)(this.props,"organization")})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(ge,{isConfigured:Boolean(t&&t.token),value:a.token||"",label:"Token","aria-label":"Token",labelWidth:10,inputWidth:20,onReset:this.onResetToken,onChange:(0,I.fi)(this.props,"token")}))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{className:"width-10"},"Default Bucket"),s.createElement("div",{className:"width-10"},s.createElement(L,{className:"width-20",placeholder:"default bucket",value:e.jsonData.defaultBucket||"",onChange:(0,I._R)(this.props,"defaultBucket")})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{className:"width-10",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},"Min time interval"),s.createElement("div",{className:"width-10"},s.createElement(L,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,I._R)(this.props,"timeInterval")})))))}renderInflux1x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{},{htmlPrefix:n}=this;return s.createElement(s.Fragment,null,s.createElement(me.v,null,s.createElement("h5",null,"Database Access"),s.createElement("p",null,"Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",s.createElement("code",null,"SHOW MEASUREMENTS ON _internal")," or",s.createElement("code",null,'SELECT * FROM "_internal".."database" LIMIT 10'),s.createElement("br",null),s.createElement("br",null),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB.")),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{htmlFor:`${n}-db`,className:"width-10"},"Database"),s.createElement("div",{className:"width-20"},s.createElement(L,{id:`${n}-db`,className:"width-20",value:e.jsonData.dbName??e.database,onChange:l=>{this.props.onOptionsChange({...e,database:"",jsonData:{...e.jsonData,dbName:l.target.value}})}})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{htmlFor:`${n}-user`,className:"width-10"},"User"),s.createElement("div",{className:"width-10"},s.createElement(L,{id:`${n}-user`,className:"width-20",value:e.user||"",onChange:(0,I.z_)(this.props,"user")})))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(ge,{isConfigured:Boolean(t&&t.password),value:a.password||"",label:"Password","aria-label":"Password",labelWidth:10,inputWidth:20,onReset:this.onResetPassword,onChange:(0,I.fi)(this.props,"password")}))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{htmlFor:`${n}-http-method`,className:"width-10",tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`},"HTTP Method"),s.createElement(k.Ph,{inputId:`${n}-http-method`,className:"width-10",value:fe.find(l=>l.value===e.jsonData.httpMode),options:fe,defaultValue:e.jsonData.httpMode,onChange:(0,I.nx)(this.props,"httpMode")}))),s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{className:"width-10",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`},"Min time interval"),s.createElement("div",{className:"width-10"},s.createElement(L,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,I._R)(this.props,"timeInterval")})))))}render(){const{options:e,onOptionsChange:t}=this.props,a=e.access==="direct";return s.createElement(s.Fragment,null,s.createElement("h3",{className:"page-heading"},"Query Language"),s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(k.Ph,{"aria-label":"Query language",className:"width-30",value:e.jsonData.version===R.Flux?H[1]:H[0],options:H,defaultValue:H[0],onChange:this.onVersionChanged})))),e.jsonData.version===R.Flux&&s.createElement(me.v,null,s.createElement("h5",null,"Support for Flux in Grafana is currently in beta"),s.createElement("p",null,"Please report any issues to: ",s.createElement("br",null),s.createElement("a",{href:"https://github.com/grafana/grafana/issues/new/choose"},"https://github.com/grafana/grafana/issues"))),a&&s.createElement(ze.b,{title:"Error",severity:"error"},de),s.createElement(Ue.E,{showAccessOptions:a,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t,secureSocksDSProxyEnabled:U.vc.secureSocksDSProxyEnabled}),s.createElement("div",{className:"gf-form-group"},s.createElement("div",null,s.createElement("h3",{className:"page-heading"},"InfluxDB Details")),e.jsonData.version===R.Flux?this.renderInflux2x():this.renderInflux1x(),s.createElement("div",{className:"gf-form-inline"},s.createElement(He._,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000."},s.createElement(L,{placeholder:"1000",type:"number",className:"width-10",value:this.state.maxSeries,onChange:n=>{this.setState({maxSeries:n.currentTarget.value});const l=parseInt(n.currentTarget.value,10);(0,I.tp)(this.props,"maxSeries",Number.isFinite(l)?l:void 0)}})))))}}const je=Ke,Ye=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],Je=r=>s.createElement("div",null,s.createElement("h2",null,"InfluxDB Cheat Sheet"),Ye.map(e=>s.createElement("div",{className:"cheat-sheet-item",key:e.title},s.createElement("div",{className:"cheat-sheet-item__title"},e.title),s.createElement("div",{className:"cheat-sheet-item__label"},e.label))));class Ze extends s.PureComponent{render(){return s.createElement(Je,{onClickExample:this.props.onClickExample})}}var C=g(9892),X=g(79086),S=g(57591);const _=[],v={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function pe(r){const e=_[r.type];if(!e)throw{message:"Could not find query part "+r.type};return new S.XN(r,e)}function E(r){_[r.type]=new S.zU(r),r.category.push(_[r.type])}const ee=[];function qe(r,e){return e+' AS "'+r.params[0]+'"'}function he(r,e){const t=r.params[0];if(t==="*")return"*";let a=`"${t}"`;return t.endsWith("::tag")&&(a=`"${t.slice(0,-5)}"::tag`),t.endsWith("::field")&&(a=`"${t.slice(0,-7)}"::field`),a}function P(r,e){for(let t=0;t<r.length;t++){const a=r[t];if(a.def.category===v.Aggregations){if(a.def.type===e.def.type)return;if(a.def.type==="count"&&e.def.type==="distinct")break;if(a.def.type==="distinct"){const n=r.length>=t+2;if(e.def.type!=="count"&&n)r[t+1].def.category===v.Aggregations&&r.splice(t+1,1);else if(e.def.type==="count"){(!n||r[t+1].def.type!=="count")&&r.splice(t+1,0,e);return}}r[t]=e;return}if(a.def.category===v.Selectors){r[t]=e;return}}r.splice(1,0,e)}function N(r,e){let t;for(t=0;t<r.length;t++){const a=r[t];if(a.def.category===v.Math||a.def.category===v.Aliasing)break}r.splice(t,0,e)}function Xe(r,e){const t=r.length;if(t>0){if(r[t-1].def.type==="math"){r[t-1]=e;return}if(t>1&&r[t-2].def.type==="math"){r[t-2]=e;return}else if(r[t-1].def.type==="alias"){r.splice(t-1,0,e);return}}r.push(e)}function _e(r,e){const t=r.length;if(t>0&&r[t-1].def.type==="alias"){r[t-1]=e;return}r.push(e)}function et(r,e,t){const a=(0,f.map)(r,n=>pe({type:n.def.type,params:(0,f.clone)(n.params)}));t.selectModels.push(a)}E({type:"field",addStrategy:et,category:v.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:he}),E({type:"count",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"distinct",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"integral",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"mean",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"median",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"mode",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"sum",addStrategy:P,category:v.Aggregations,params:[],defaultParams:[],renderer:S.D}),E({type:"derivative",addStrategy:N,category:v.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:S.D}),E({type:"spread",addStrategy:N,category:v.Transformations,params:[],defaultParams:[],renderer:S.D}),E({type:"non_negative_derivative",addStrategy:N,category:v.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:S.D}),E({type:"difference",addStrategy:N,category:v.Transformations,params:[],defaultParams:[],renderer:S.D}),E({type:"non_negative_difference",addStrategy:N,category:v.Transformations,params:[],defaultParams:[],renderer:S.D}),E({type:"moving_average",addStrategy:N,category:v.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:S.D}),E({type:"cumulative_sum",addStrategy:N,category:v.Transformations,params:[],defaultParams:[],renderer:S.D}),E({type:"stddev",addStrategy:N,category:v.Transformations,params:[],defaultParams:[],renderer:S.D}),E({type:"time",category:ee,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:S.D}),E({type:"fill",category:ee,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:S.D}),E({type:"elapsed",addStrategy:N,category:v.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:S.D}),E({type:"holt_winters",addStrategy:N,category:v.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:S.D}),E({type:"holt_winters_with_fit",addStrategy:N,category:v.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:S.D}),E({type:"bottom",addStrategy:P,category:v.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:S.D}),E({type:"first",addStrategy:P,category:v.Selectors,params:[],defaultParams:[],renderer:S.D}),E({type:"last",addStrategy:P,category:v.Selectors,params:[],defaultParams:[],renderer:S.D}),E({type:"max",addStrategy:P,category:v.Selectors,params:[],defaultParams:[],renderer:S.D}),E({type:"min",addStrategy:P,category:v.Selectors,params:[],defaultParams:[],renderer:S.D}),E({type:"percentile",addStrategy:P,category:v.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:S.D}),E({type:"top",addStrategy:P,category:v.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:S.D}),E({type:"tag",category:ee,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:he}),E({type:"math",addStrategy:Xe,category:v.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:S.C7}),E({type:"alias",addStrategy:_e,category:v.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:qe});const B={create:pe,getCategories:()=>v,replaceAggregationAdd:P};class A{constructor(e,t,a){this.selectModels=[],this.target=e,this.templateSrv=t,this.scopedVars=a,e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,f.map)(this.target.select,e=>(0,f.map)(e,B.create)),this.groupByParts=(0,f.map)(this.target.groupBy,B.create)}updatePersistedParts(){this.target.select=(0,f.map)(this.selectModels,e=>(0,f.map)(e,t=>({type:t.def.type,params:t.params})))}hasGroupByTime(){return(0,f.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,f.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const a=t[1],n=t[2],l=B.create({type:a,params:[n]}),i=this.target.groupBy.length;i===0?this.target.groupBy.push(l.part):a==="time"?this.target.groupBy.splice(0,0,l.part):a==="tag"?this.target.groupBy[i-1].type==="fill"?this.target.groupBy.splice(i-1,0,l.part):this.target.groupBy.push(l.part):this.target.groupBy.push(l.part),this.updateProjection()}removeGroupByPart(e,t){const a=B.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,f.filter)(this.target.groupBy,n=>n.type!=="fill"),this.target.select=(0,f.map)(this.target.select,n=>(0,f.filter)(n,l=>{const i=B.create(l);return!(i.def.category===a.Aggregations||i.def.category===a.Selectors)}))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if(t.def.type==="field"){if(this.selectModels.length>1){const a=(0,f.indexOf)(this.selectModels,e);this.selectModels.splice(a,1)}}else{const a=(0,f.indexOf)(e,t);e.splice(a,1)}this.updatePersistedParts()}addSelectPart(e,t){const a=B.create({type:t});a.def.addStrategy(e,a,this),this.updatePersistedParts()}renderTagCondition(e,t,a){let n="",l=e.operator,i=e.value;t>0&&(n=(e.condition||"AND")+" "),l||(/^\/.*\/$/.test(i)?l="=~":l="="),l!=="=~"&&l!=="!~"?(a&&(i=this.templateSrv.replace(i,this.scopedVars)),l!==">"&&l!=="<"&&(i="'"+i.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'")):a&&(i=this.templateSrv.replace(i,this.scopedVars,"regex"));let o=`"${e.key}"`;return e.key.endsWith("::tag")&&(o=`"${e.key.slice(0,-5)}"::tag`),e.key.endsWith("::field")&&(o=`"${e.key.slice(0,-7)}"::field`),n+o+" "+l+" "+i}getMeasurementAndPolicy(e){let t=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?e&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',`"${t}".${a}`}interpolateQueryStr(e,t,a){return!t.multi&&!t.includeAll?e:typeof e=="string"?(0,X.yI)(e):"("+(0,f.map)(e,X.yI).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let a="SELECT ",n,l;for(n=0;n<this.selectModels.length;n++){const u=this.selectModels[n];let c="";for(l=0;l<u.length;l++)c=u[l].render(c);n>0&&(a+=", "),a+=c}a+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const i=(0,f.map)(t.tags,(u,c)=>this.renderTagCondition(u,c,e));i.length>0&&(a+="("+i.join(" ")+") AND "),a+="$timeFilter";let o="";for(n=0;n<this.groupByParts.length;n++){const u=this.groupByParts[n];n>0&&(o+=u.def.type==="fill"?" ":", "),o+=u.render("")}return o.length&&(a+=" GROUP BY "+o),t.fill&&(a+=" fill("+t.fill+")"),t.orderByTime==="DESC"&&(a+=" ORDER BY time DESC"),t.limit&&(a+=" LIMIT "+t.limit),t.slimit&&(a+=" SLIMIT "+t.slimit),t.tz&&(a+=" tz('"+t.tz+"')"),a}renderAdhocFilters(e){return(0,f.map)(e,(a,n)=>this.renderTagCondition(a,n,!0)).join(" ")}}function ye(r){const e=(0,f.cloneDeep)(r);return new A(e).render(!1)}function tt(r){if(r.policy!==void 0&&r.resultFormat!==void 0&&r.orderByTime!==void 0&&r.tags!==void 0&&r.groupBy!==void 0&&r.select!==void 0)return r;const e=(0,f.cloneDeep)(r);return new A(e).target}function rt(r,e,t){const a=(0,f.cloneDeep)(r),n=new A(a);return n.addSelectPart(n.selectModels[t],e),n.target}function at(r,e,t){const a=(0,f.cloneDeep)(r),n=new A(a),l=n.selectModels[t];return n.removeSelectPart(l,l[e]),n.target}function nt(r,e,t,a){const n=[...r.select??[]];return n[e]=[...n[e]],n[e][t]={...n[e][t],params:a},{...r,select:n}}function st(r,e){const t=(0,f.cloneDeep)(r),a=new A(t);return a.addGroupBy(e),a.target}function lt(r,e){const t=(0,f.cloneDeep)(r),a=new A(t);return a.removeGroupByPart(a.groupByParts[e],e),a.target}function it(r,e,t){const a=[...r.groupBy??[]];return a[e]={...a[e],params:t},{...r,groupBy:a}}function ve(r,e){return!r||!e.includes(r)?e[0]??"":r}var Ee=g(20308),$=g(10339),ot=g(9405),te=g(31403),ut=g(70044),re=g(72648);const ct=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class mt extends s.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e}),this.props.onRunQuery()},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate(),this.props.onRunQuery()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:$.k.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:$.k.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:$.k.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:$.k.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:$.k.Property,detail:"org configured for the datsource"}],t=(0,Ee.J)();return t.getVariables().forEach(a=>{const n="${"+a.name+"}";let l=t.replace(n);l===n&&(l=""),e.push({label:n,kind:$.k.Text,detail:`(Template Variable) ${l}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:t}=this.props,a=dt(t),n=s.createElement("div",null,"Type: ",s.createElement("i",null,"ctrl+space")," to show template variable suggestions ",s.createElement("br",null),"Many queries can be copied from Chronograf");return s.createElement(s.Fragment,null,s.createElement(ot.p,{height:"100%",containerStyles:a.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),s.createElement("div",{className:(0,C.cx)("gf-form-inline",a.editorActions)},s.createElement(te.Qj,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/"},"Flux language syntax"),s.createElement(ut.X,{options:ct,value:"Sample Query",onChange:this.onSampleChange}),s.createElement("div",{className:"gf-form gf-form--grow"},s.createElement("div",{className:"gf-form-label gf-form-label--grow"})),s.createElement(T.c,{width:5,tooltip:n},"Help")))}}const dt=r=>({editorContainerStyles:C.css`
    height: 200px;
    max-width: 100%;
    resize: vertical;
    overflow: auto;
    background-color: ${r.isDark?r.colors.background.canvas:r.colors.background.primary};
    padding-bottom: ${r.spacing(1)};
  `,editorActions:C.css`
    margin-top: 6px;
  `}),ae=(0,re.HE)(mt);var gt=g(98102);const ft=({isRaw:r,onChange:e})=>{const[t,a]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{a(!1)},[r]),r?s.createElement(s.Fragment,null,s.createElement(te.zx,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{a(!0)}}),s.createElement(gt.s,{isOpen:t,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{a(!1)}})):s.createElement(te.zx,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var Se=g(97379),pt=g(52081),M=g(46967);const xe=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],Ce="time_series";var ht=g(82965);function K(r){const[e,t]=(0,s.useState)(r),a=(0,ht.Z)(r);return(0,s.useEffect)(()=>{a!==r&&e!==r&&t(r)},[r,e,a]),[e,t]}var ne=g(56991);const yt=({query:r,onChange:e,onRunQuery:t})=>{const[a,n]=K(r.query),[l,i]=K(r.alias),o=(0,ne.L)(),u=(0,ne.L)(),c=r.resultFormat??Ce,d=()=>{e({...r,query:a,alias:l,resultFormat:c}),t()};return s.createElement("div",null,s.createElement(Se.K,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:d,onChange:m=>{n(m.currentTarget.value)},value:a??""}),s.createElement(pt.Lh,null,s.createElement(T.c,{htmlFor:u},"Format as"),s.createElement(k.Ph,{inputId:u,onChange:m=>{e({...r,resultFormat:m.value}),t()},value:c,options:xe}),s.createElement(T.c,{htmlFor:o},"Alias by"),s.createElement(M.I,{id:o,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:d,onChange:m=>{i(m.currentTarget.value)},value:l??""})))};var vt=g(59679),V=g(30991),W=g(77117);function Et(r,e){let t="",a=r.operator,n=r.value;e>0&&(t=(r.condition||"AND")+" "),a||(/^\/.*\/$/.test(r.value)?a="=~":a="="),(n===""||a!=="=~"&&a!=="!~")&&(n="'"+n.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'");let l=`"${r.key}"`;return r.key.endsWith("::tag")&&(l=`"${r.key.slice(0,-5)}"::tag`),r.key.endsWith("::field")&&(l=`"${r.key.slice(0,-7)}"::field`),t+l+" "+a+" "+n}class se{constructor(e,t){this.target=e,this.database=t}buildExploreQuery(e,t,a){let n="",l,i;if(e==="TAG_KEYS")n="SHOW TAG KEYS",l=this.target.measurement,i=this.target.policy;else if(e==="TAG_VALUES")n="SHOW TAG VALUES",l=this.target.measurement,i=this.target.policy;else if(e==="MEASUREMENTS")n="SHOW MEASUREMENTS",a&&(n+=" WITH MEASUREMENT =~ /(?i)"+(0,X.yI)(a)+"/");else{if(e==="FIELDS")return l=this.target.measurement,i=this.target.policy,l.match(/^\/.*\/|^$/)||(l='"'+l+'"',i&&i!=="default"&&(i='"'+i+'"',l=i+"."+l)),l===""?"SHOW FIELD KEYS":"SHOW FIELD KEYS FROM "+l;if(e==="RETENTION POLICIES")return n='SHOW RETENTION POLICIES on "'+this.database+'"',n}if(l&&(!l.match("^/.*/")&&!l.match(/^merge\(.*\)/)&&(l='"'+l+'"'),i&&i!=="default"&&(i='"'+i+'"',l=i+"."+l),l!==""&&(n+=" FROM "+l)),t){let o=t;o.endsWith("::tag")&&(o=o.slice(0,-5)),n+=' WITH KEY = "'+o+'"'}if(this.target.tags&&this.target.tags.length>0){const o=(0,f.reduce)(this.target.tags,(u,c)=>(c.key===t||c.operator===">"||c.operator==="<"||u.push(Et(c,u.length)),u),[]);o.length>0&&(n+=" WHERE "+o.join(" "))}return e==="MEASUREMENTS"&&(n+=" LIMIT 100"),n}}const G=(r,e,t,a,n)=>{const i=new se(a,n.database).buildExploreQuery(r,e,t),o={policy:ve(a.policy,n.retentionPolicies)};return n.metricFindQuery(i,o)};async function le(r){return(await G("RETENTION POLICIES",void 0,void 0,{tags:[],measurement:void 0,policy:void 0},r)).map(a=>a.text)}async function St(r,e,t){return(await G("MEASUREMENTS",void 0,r,{tags:e,measurement:void 0,policy:void 0},t)).map(l=>l.text)}async function xt(r,e,t,a){return(await G("TAG_KEYS",void 0,void 0,{tags:t,measurement:r,policy:e},a)).map(i=>i.text)}async function Ct(r,e,t,a,n){const l={tags:a,measurement:e,policy:t};return r.endsWith("::field")?[]:(await G("TAG_VALUES",r,void 0,l,n)).map(o=>o.text)}async function be(r,e,t){return(await G("FIELDS",void 0,void 0,{tags:[],measurement:r,policy:e},t)).map(l=>l.text)}const ie=(0,C.css)({paddingRight:"4px"});function z(r){if(r==null)throw new Error("value must not be nullish");return r}const bt=(0,C.cx)("width-8",ie),Tt=({format:r,inputId:e,onChange:t})=>s.createElement(k.Ph,{inputId:e,className:bt,onChange:a=>{t(z(a.value))},value:r,options:xe});var wt=g(99151),Pt=g.n(wt),Ft=g(13821);const Te=(0,C.css)({minWidth:"160px"}),we=r=>r,It=({loadOptions:r,allowCustomValue:e,onChange:t,onClose:a})=>{const n=Pt()(r,1e3,{leading:!0});return s.createElement("div",{className:Te},s.createElement(k.qb,{formatCreateLabel:we,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:a,allowCustomValue:e,loadOptions:n,onChange:t,createOptionPosition:"first"}))},Nt=({loadOptions:r,allowCustomValue:e,onChange:t,onClose:a})=>{const[n,l]=(0,Ft.Z)(r,[r]);return(0,s.useEffect)(()=>{l("")},[l,r]),s.createElement("div",{className:Te},s.createElement(k.Ph,{isLoading:n.loading,formatCreateLabel:we,autoFocus:!0,isOpen:!n.loading,onCloseMenu:a,allowCustomValue:e,options:n.value??[],onChange:t,createOptionPosition:"first"}))},At=({loadOptions:r,filterByLoadOptions:e,allowCustomValue:t,onChange:a,onClose:n})=>e?s.createElement(It,{loadOptions:r,allowCustomValue:t,onChange:a,onClose:n}):s.createElement(Nt,{loadOptions:r,allowCustomValue:t,onChange:a,onClose:n}),Dt=({initialValue:r,onChange:e,onClose:t})=>{const[a,n]=K(r);return s.createElement(M.I,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:t,onKeyDown:l=>{l.key==="Enter"&&e(a)},onChange:l=>{n(l.currentTarget.value)},value:a})},Ot=(0,C.css)({width:"auto",cursor:"pointer"}),Q=({value:r,buttonClassName:e,loadOptions:t,filterByLoadOptions:a,allowCustomValue:n,onChange:l})=>{const[i,o]=(0,s.useState)(!1);if(i)return t!==void 0?s.createElement(At,{loadOptions:t,filterByLoadOptions:a??!1,allowCustomValue:n,onChange:u=>{o(!1),l(u)},onClose:()=>{o(!1)}}):s.createElement(Dt,{initialValue:r,onClose:()=>{o(!1)},onChange:u=>{o(!1),l({value:u,label:u})}});{const u=(0,C.cx)(Ot,e);return s.createElement(W.W,{as:"button",className:u,onClick:()=>{o(!0)}},r)}};function F(r){return{label:r,value:r}}const Rt=({policy:r,measurement:e,onChange:t,getPolicyOptions:a,getMeasurementOptions:n})=>{const l=async()=>(await a()).map(F),i=async o=>(await n(o)).map(F);return s.createElement(s.Fragment,null,s.createElement(Q,{allowCustomValue:!0,value:r??"",loadOptions:l,onChange:o=>{t(o.value,e)}}),s.createElement(Q,{allowCustomValue:!0,value:e??"select measurement",loadOptions:i,filterByLoadOptions:!0,onChange:o=>{t(r,o.value)}}))},j=({value:r,onChange:e,isWide:t,placeholder:a})=>{const[n,l]=K(r),i=()=>{e(n===""?void 0:n)};return s.createElement(s.Fragment,null,s.createElement(M.I,{placeholder:a,className:(0,C.cx)(t??!1?"width-14":"width-8",ie),type:"text",spellCheck:!1,onBlur:i,onChange:o=>{l(o.currentTarget.value)},value:n??""}))},Bt=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],Mt=(0,C.cx)("width-9",ie),Qt=({value:r,onChange:e,inputId:t})=>s.createElement(s.Fragment,null,s.createElement(k.Ph,{inputId:t,className:Mt,onChange:a=>{e(z(a.value))},value:r,options:Bt}));var kt=g(14391),Lt=g(42044),$t=g(74285);const Pe=({loadOptions:r,allowCustomValue:e,onAdd:t})=>s.createElement(Q,{value:"+",loadOptions:r,allowCustomValue:e,onChange:a=>{t(z(a.value))}}),Vt=r=>s.createElement(kt.k,{label:""},s.createElement(Lt.s,{label:"remove",onClick:r})),Wt=(0,C.css)({paddingRight:"0",marginRight:"0"}),Gt=({name:r,onRemove:e})=>s.createElement($t.z,{renderMenuItems:()=>Vt(e)},({openMenu:t})=>s.createElement("button",{className:(0,C.cx)("gf-form-label",Wt),onClick:t},r)),zt=(0,C.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),Ut=r=>(0,C.cx)("gf-form-label",(0,C.css)({paddingLeft:"0",lineHeight:r.typography.body.lineHeight,fontSize:r.typography.body.fontSize})),Ht=({name:r,params:e,onChange:t,onRemove:a})=>{const n=(0,re.l4)(),l=(0,s.useMemo)(()=>Ut(n),[n]),i=(o,u)=>{const c=e.map(d=>d.value);c[u]=o,t(c)};return s.createElement("div",{className:l},s.createElement(Gt,{name:r,onRemove:a}),"(",e.map((o,u)=>{const{value:c,options:d}=o,m=u===e.length-1,h=d!==null?()=>d().then(y=>y.map(F)):void 0;return s.createElement(s.Fragment,{key:u},s.createElement(Q,{allowCustomValue:!0,value:c,buttonClassName:zt,loadOptions:h,onChange:y=>{i(z(y.value),u)}}),!m&&",")}),")")},Fe=({parts:r,getNewPartOptions:e,onAddNewPart:t,onRemovePart:a,onChange:n})=>s.createElement(s.Fragment,null,r.map((l,i)=>s.createElement(Ht,{key:i,name:l.name,params:l.params,onRemove:()=>{a(i)},onChange:o=>{n(i,o)}})),s.createElement(Pe,{loadOptions:e,onAdd:t}));function Ie(r){return/^\/.*\/$/.test(r)}function Ne(r){return r.operator??(Ie(r.value)?"=~":"=")}function Ae(r,e){return e?void 0:r.condition??"AND"}function Kt(r,e){const t=r==="=~"||r==="!~";return Ie(e)?t?r:"=~":t?"=":r}const jt=["=","!=","<>","<",">","=~","!~"],Yt=["AND","OR"],Jt=jt.map(F),Zt=Yt.map(F),qt=()=>Promise.resolve(Zt),Xt=()=>Promise.resolve(Jt),_t=({tag:r,isFirst:e,onRemove:t,onChange:a,getTagKeyOptions:n,getTagValueOptions:l})=>{const i=Ne(r),o=Ae(r,e),u=()=>n().catch(d=>(console.error(d),[])).then(d=>[{label:"-- remove filter --",value:void 0},...d.map(F)]),c=()=>l(r.key).then(d=>d.map(F));return s.createElement("div",{className:"gf-form"},o!=null&&s.createElement(Q,{value:o,loadOptions:qt,onChange:d=>{a({...r,condition:d.value})}}),s.createElement(Q,{allowCustomValue:!0,value:r.key,loadOptions:u,onChange:d=>{const{value:m}=d;m===void 0?t():a({...r,key:m??""})}}),s.createElement(Q,{value:i,loadOptions:Xt,onChange:d=>{a({...r,operator:d.value})}}),s.createElement(Q,{allowCustomValue:!0,value:r.value,loadOptions:c,onChange:d=>{const m=d.value??"";a({...r,value:m,operator:Kt(i,m)})}}))},er=({tags:r,onChange:e,getTagKeyOptions:t,getTagValueOptions:a})=>{const n=(u,c)=>{const d=r.map((m,h)=>c===h?u:m);e(d)},l=u=>{const c=r.filter((d,m)=>m!==u);e(c)},i=()=>t().then(u=>u.map(F)),o=(u,c)=>{const d={key:u,value:"select tag value"},m={key:d.key,value:d.value,operator:Ne(d),condition:Ae(d,c)};e([...r,m])};return s.createElement(s.Fragment,null,r.map((u,c)=>s.createElement(_t,{tag:u,isFirst:c===0,key:c,onChange:d=>{n(d,c)},onRemove:()=>{l(c)},getTagKeyOptions:t,getTagValueOptions:a})),s.createElement(Pe,{allowCustomValue:!0,loadOptions:i,onAdd:u=>{o(u,r.length===0)}}))};function tr(){const r=B.getCategories(),e=[];return Object.keys(r).forEach(a=>{const n=r[a].map(l=>F(l.type));e.push({label:a,options:n})}),e}async function rr(r,e){const t=await e(),a={...r},n=new A(a),l=[];return n.hasFill()||l.push(F("fill(null)")),n.hasGroupByTime()||l.push(F("time($interval)")),t.forEach(i=>{l.push(F(`tag(${i})`))}),l}function ar(r,e){const t=B.create(r).def,a=(r.params??[]).map(n=>n.toString());if(a.length!==t.params.length)throw new Error("Invalid query-segment");return a.map((n,l)=>{const i=t.params[l];return i.dynamicLookup?{value:n,options:z(e.get(`${t.type}_${l}`))}:i.options!=null?{value:n,options:()=>Promise.resolve(i.options)}:{value:n,options:null}})}function De(r,e){return r.map(t=>({name:t.type,params:ar(t,e)}))}function Oe(r){return`/^$${r.name}$/`}function nr(r){return`$${r.name}`}function sr(r){return(0,Ee.J)().getVariables().map(r)}function oe(r,e,t){let a=sr(e);return t&&(a=a.filter(n=>n.indexOf(t)>-1)),r.then(n=>[...a,...n])}function Re(r,e){return r.filter(t=>t.key.endsWith("::tag")||e.has(t.key+"::tag"))}const lr=r=>{const e=(0,ne.L)(),t=`influxdb-qe-format-as-${e}`,a=`influxdb-qe-order-by${e}`,n=(0,re.wW)(ir),l=tt(r.query),{datasource:i}=r,{measurement:o,policy:u}=l,c=(0,vt.Z)(()=>le(i),[i]),d=c.error?[]:c.value??[],m=(0,s.useMemo)(async()=>{const p=(await xt(o,u,[],i)).map(D=>`${D}::tag`),x=(await be(o||"",u,i)).map(D=>`${D}::field`);return new Set([...p,...x])},[o,u,i]),h=(0,s.useMemo)(()=>{const p=new Map([["field_0",()=>o!==void 0?be(o,u,i):Promise.resolve([])]]);return(l.select??[]).map(x=>De(x,p))},[o,u,l.select,i]),y=(0,s.useMemo)(()=>async()=>{const p=new Set(l.tags?.map(x=>x.key));return[...await m].filter(x=>!p.has(x))},[l.tags,m]),w=(0,s.useMemo)(()=>{const p=new Map([["tag_0",y]]);return De(l.groupBy??[],p)},[y,l.groupBy]),b=p=>{r.onChange(p),r.onRunQuery()},Z=(p,x)=>{b({...l,policy:p,measurement:x})},q=p=>{b({...l,tags:p.length===0?void 0:p})};return s.createElement("div",null,s.createElement(V.f,{label:"FROM",fill:!0},s.createElement(Rt,{policy:u??d[0],measurement:o,getPolicyOptions:()=>oe(m.then(p=>le(i)),nr),getMeasurementOptions:p=>oe(m.then(x=>St(p===""?void 0:p,Re(l.tags??[],x),i)),Oe,p),onChange:Z}),s.createElement(W.W,{width:"auto",className:n.inlineLabel},"WHERE"),s.createElement(er,{tags:l.tags??[],onChange:q,getTagKeyOptions:y,getTagValueOptions:p=>oe(m.then(x=>Ct(p,o,u,Re(l.tags??[],x),i)),Oe)})),h.map((p,x)=>s.createElement(V.f,{key:x,label:x===0?"SELECT":"",fill:!0},s.createElement(Fe,{parts:p,getNewPartOptions:()=>Promise.resolve(tr()),onChange:(D,Dr)=>{const Or=nt(l,x,D,Dr);b(Or)},onAddNewPart:D=>{b(rt(l,D,x))},onRemovePart:D=>{b(at(l,D,x))}}))),s.createElement(V.f,{label:"GROUP BY",fill:!0},s.createElement(Fe,{parts:w,getNewPartOptions:()=>rr(l,y),onChange:(p,x)=>{const D=it(l,p,x);b(D)},onAddNewPart:p=>{b(st(l,p))},onRemovePart:p=>{b(lt(l,p))}})),s.createElement(V.f,{label:"TIMEZONE",fill:!0},s.createElement(j,{placeholder:"(optional)",value:l.tz,onChange:p=>{b({...l,tz:p})}}),s.createElement(W.W,{htmlFor:a,width:"auto",className:n.inlineLabel},"ORDER BY TIME"),s.createElement(Qt,{inputId:a,value:l.orderByTime==="DESC"?"DESC":"ASC",onChange:p=>{b({...l,orderByTime:p})}})),s.createElement(V.f,{label:"LIMIT",fill:!0},s.createElement(j,{placeholder:"(optional)",value:l.limit?.toString(),onChange:p=>{b({...l,limit:p})}}),s.createElement(W.W,{width:"auto",className:n.inlineLabel},"SLIMIT"),s.createElement(j,{placeholder:"(optional)",value:l.slimit?.toString(),onChange:p=>{b({...l,slimit:p})}})),s.createElement(V.f,{htmlFor:t,label:"FORMAT AS",fill:!0},s.createElement(Tt,{inputId:t,format:l.resultFormat??Ce,onChange:p=>{b({...l,resultFormat:p})}}),l.resultFormat!=="table"&&s.createElement(s.Fragment,null,s.createElement(W.W,{width:"auto",className:n.inlineLabel},"ALIAS"),s.createElement(j,{isWide:!0,placeholder:"Naming pattern",value:l.alias,onChange:p=>{b({...l,alias:p})}}))))};function ir(r){return{inlineLabel:C.css`
      color: ${r.colors.primary.text};
    `}}const or=({query:r,onChange:e,onRunQuery:t,datasource:a,range:n,data:l})=>a.isFlux?s.createElement("div",{className:"gf-form-query-content"},s.createElement(ae,{query:r,onChange:e,onRunQuery:t,datasource:a})):s.createElement("div",{className:(0,C.css)({display:"flex"})},s.createElement("div",{className:(0,C.css)({flexGrow:1})},r.rawQuery?s.createElement(yt,{query:r,onChange:e,onRunQuery:t}):s.createElement(lr,{query:r,onChange:e,onRunQuery:t,datasource:a})),s.createElement(ft,{isRaw:r.rawQuery??!1,onChange:i=>{e({...r,query:ye(r),rawQuery:i}),t()}}));class ur extends s.PureComponent{constructor(){super(...arguments),this.onRefresh=()=>{}}render(){let{query:e,datasource:t,onChange:a}=this.props;return t.isFlux?s.createElement(ae,{datasource:t,query:{refId:"A",query:e},onRunQuery:this.onRefresh,onChange:n=>a(n.query)}):s.createElement("div",{className:"gf-form-inline"},s.createElement(T.c,{width:10},"Query"),s.createElement("div",{className:"gf-form-inline gf-form--grow"},s.createElement(Se.K,{defaultValue:e||"",placeholder:"metric name or tags query",rows:1,className:"gf-form-input",onBlur:n=>a(n.currentTarget.value)})))}}var Be=g(85850),cr=g(63468),mr=g(39859),dr=g(84946),gr=g(12877),ue=g(59980),Y=g(65583),J=g(9471),fr=g(59724),O=g(99098),pr=g(83881),hr=g(47406),yr=g(22069),Me=g(54899),Qe=g(32689),vr=g(28674);const Er=r=>{const{query:e,onChange:t}=r,[a,n]=(0,s.useState)(e.query??""),[l,i]=(0,s.useState)(e.textColumn??""),[o,u]=(0,s.useState)(e.tagsColumn??""),[c,d]=(0,s.useState)(e?.timeEndColumn??""),[m]=(0,s.useState)(e?.titleColumn??""),h=(y,w)=>{t({...e,[y]:w,fromAnnotations:!0,textEditor:!0})};return s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{width:12},"InfluxQL Query"),s.createElement(M.I,{value:a,onChange:y=>n(y.currentTarget.value??""),onBlur:()=>h("query",a),placeholder:"select text from events where $timeFilter limit 1000"})),s.createElement(T.c,{width:12,tooltip:s.createElement("div",null,"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage.")},"Field mappings"),s.createElement("div",{className:"gf-form-group"},s.createElement("div",{className:"gf-form-inline"},s.createElement("div",{className:"gf-form"},s.createElement(T.c,{width:12},"Text"),s.createElement(M.I,{value:l,onChange:y=>i(y.currentTarget.value??""),onBlur:()=>h("textColumn",l)})),s.createElement("div",{className:"gf-form"},s.createElement(T.c,{width:12},"Tags"),s.createElement(M.I,{value:o,onChange:y=>u(y.currentTarget.value??""),onBlur:()=>h("tagsColumn",o)})),s.createElement("div",{className:"gf-form"},s.createElement(T.c,{width:12},"TimeEnd"),s.createElement(M.I,{value:c,onChange:y=>d(y.currentTarget.value??""),onBlur:()=>h("timeEndColumn",c)})),s.createElement("div",{className:"gf-form ng-hide"},s.createElement(T.c,{width:12},"Title"),s.createElement(M.I,{defaultValue:m})))))};var ke=g(37219);class Le{constructor(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let t,a;return this.series.length===0||(0,f.each)(this.series,n=>{const l=n.columns.length,i=(0,f.map)(n.tags,(o,u)=>u+": "+o);for(a=1;a<l;a++){let o=n.name;const u=n.columns[a];u!=="value"&&(o=o+"."+u),this.alias?o=this._getSeriesName(n,a):n.tags&&(o=o+" {"+i.join(", ")+"}");const c=[];if(n.values)for(t=0;t<n.values.length;t++)c[t]=[n.values[t][a],n.values[t][0]];e.push({title:o,target:o,datapoints:c,tags:n.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,t){const a=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,n=e.name.split(".");return this.alias.replace(a,(l,i,o)=>{const u=i||o,c=parseInt(u,10);if(u==="m"||u==="measurement")return e.name;if(u==="col")return e.columns[t];if(!isNaN(c))return n[c]??l;if(u.indexOf("tag_")!==0)return l;const d=u.replace("tag_","");return e.tags?e.tags[d]:l})}getAnnotations(){const e=[];return(0,f.each)(this.series,t=>{let a=null,n=null,l=null;const i=[];let o=null;(0,f.each)(t.columns,(u,c)=>{if(u==="time"){n=c;return}if(u!=="sequence_number"){if(u===this.annotation.titleColumn){a=c;return}if((0,f.includes)((this.annotation.tagsColumn||"").replace(" ","").split(","),u)){i.push(c);return}if(u===this.annotation.textColumn){o=c;return}if(u===this.annotation.timeEndColumn){l=c;return}!a&&o!==c&&(a=c)}}),(0,f.each)(t.values,u=>{const c={annotation:this.annotation,time:+new Date(u[n]),title:u[a],timeEnd:u[l],tags:(0,f.flatten)(i.filter(d=>u[d]).map(d=>u[d].split(","))),text:u[o]};e.push(c)})}),e}getTable(){const e=new ke.Z;let t,a;return e.refId=this.refId,e.meta=this.meta,this.series.length===0||(0,f.each)(this.series,(n,l)=>{if(l===0){const i=n.columns[0],o=i==="time"?{text:"Time",type:O.fS.time}:{text:i};for(e.columns.push(o),(0,f.each)((0,f.keys)(n.tags),u=>{e.columns.push({text:u})}),a=1;a<n.columns.length;a++)e.columns.push({text:n.columns[a]})}if(n.values)for(t=0;t<n.values.length;t++){const i=n.values[t],o=[i[0]];if(n.tags)for(const u in n.tags)n.tags.hasOwnProperty(u)&&o.push(n.tags[u]);for(a=1;a<i.length;a++)o.push(i[a]);e.rows.push(o)}}),e}}const Sr=r=>{const e={refId:"",query:r.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:r.tagsColumn??"",textColumn:r.textColumn??"",timeEndColumn:r.timeEndColumn??"",titleColumn:r.titleColumn??"",name:r.name??""};return r.target&&r.target.limit&&(e.limit=r.target.limit),r.target&&r.target.matchAny&&(e.matchAny=r.target.matchAny),r.target&&r.target.tags&&(e.tags=r.target.tags),r.target&&r.target.type&&(e.type=r.target.type),e},xr=r=>(r.target=r.target&&!r.target?.query?Sr(r):r.target,r);class Cr{parse(e,t){if(!t?.results||t.results.length===0)return[];const a=t.results[0];if(!a.series)return[];const n=e.toLowerCase(),l=n.indexOf("show retention policies")>=0,i=n.indexOf("show field keys")>=0||l,o=new Set;return(0,f.each)(a.series,u=>{(0,f.each)(u.values,c=>{if((0,f.isArray)(c))if(i)if(l&&c[c.length-1]===!0){const d=[c[0].toString(),...Array.from(o)];o.clear(),d.forEach(m=>o.add(m))}else o.add(c[0].toString());else c[1]!==void 0?o.add(c[1].toString()):o.add(c[0].toString());else o.add(c.toString())})}),Array.from(o).map(u=>({text:u}))}getTable(e,t,a){let n=new ke.Z;if(e.length>0)if(n.meta={...a,executedQueryString:e[0].meta?.executedQueryString},n.refId=t.refId,n=Tr(e,n,t),e[0].fields[1]&&e[0].fields[1].labels){let l=(0,f.groupBy)(e,o=>o.fields[1].labels?Object.values(o.fields[1].labels):null);const i=Object.keys(l);l=Object.values(l);for(let o=0;o<l.length;o++)n=$e(l[o],n,[...i[o].split(",")])}else n=$e(e,n,[]);return n}async transformAnnotationResponse(e,t,a){const n=(0,Qe.z1)(t,[a]);if(n){const l=this.getTable(n.data,a,{}),i=[];let o=null,u=null,c=null;const d=[];let m=null;return(0,f.each)(l.columns,(h,y)=>{if(h.text.toLowerCase()==="time"){u=y;return}if(h.text===e.titleColumn){o=y;return}if(br(h.text,e.tagsColumn)){d.push(y);return}if(h.text.includes(e.textColumn)){m=y;return}if(h.text===e.timeEndColumn){c=y;return}!o&&m!==y&&(o=y)}),(0,f.each)(l.rows,h=>{const y={annotation:e,time:+new Date(h[u]),title:h[o],timeEnd:h[c],tags:(0,f.flatten)(d.filter(w=>h[w]).map(w=>h[w].split(","))),text:h[m]};i.push(y)}),i}return[]}}function br(r,e){const t=(e||"").replace(" ","").split(",");for(const a of t)if(a!==""&&r.includes(a))return!0;return!1}function Tr(r,e,t){const a=wr(t);r[0].fields.forEach(n=>{n.name==="time"?e.columns.push({text:"Time",type:O.fS.time}):n.name==="value"&&n.labels&&Object.keys(n.labels).forEach(l=>{e.columns.push({text:l})})}),r[0].refId==="metricFindQuery"&&r.forEach(n=>{n.name&&e.columns.push({text:n.name})});for(let n=0;n<a.length;n++)e.columns.push({text:a[n]});return t.rawQuery&&a.length===0&&Pr(t.query,r)&&r[0].refId!=="metricFindQuery"&&r.map(n=>{n.name&&e.columns.push({text:n.name})}),e}function $e(r,e,t){const a=r[0].fields[0].values;for(let n=0;n<a.length;n++){const l=a[n],i=r.map(o=>o.fields[1]?o.fields[1].values[n]:null);i.indexOf(null)<0&&e.rows.push([l,...t,...i])}return e}function wr(r){let e=[];r.select?.forEach(a=>{const n=a.filter(l=>l.type!=="field");n.length>0?e.push(n[0].type):a[0]&&a[0].params&&a[0].params[0]&&e.push(a[0].params[0].toString())});let t=[];return e.forEach(a=>{t.push(Ve(a,a,t,0))}),t}function Ve(r,e,t,a){return t.indexOf(e)>-1?(a++,Ve(r,r+"_"+a,t,a)):e}function Pr(r,e){const a=e.map(i=>i.name).every(i=>i&&r?i.split(".").every(u=>r.toLowerCase().includes(u.toLowerCase())):!1),l=["*","SHOW"].some(i=>r?r.toLowerCase().includes(i.toLowerCase()):!1);return a||l}function Fr(r){const e=r.find(a=>a!==null);if(e===void 0)return O.fS.number;const t=typeof e;switch(t){case"string":return O.fS.string;case"boolean":return O.fS.boolean;case"number":return O.fS.number;default:throw new Error(`InfluxQL: invalid value type ${t}`)}}function Ir(r){const e=[],t=[],a=r.datapoints;for(const o of a)t.push(o[0]),e.push(o[1]);const n={name:O.Ls,type:O.fS.time,config:{},values:e},l={name:O.M5,type:Fr(t),config:{displayNameFromDS:r.title},values:t,labels:r.tags},i=[n,l];return{name:r.target,refId:r.refId,meta:r.meta,fields:i,length:t.length}}class Nr extends yr.CK{constructor(e,t=(0,vr.J)()){super(e),this.templateSrv=t,this.type="influxdb",this.urls=(e.url??"").split(",").map(n=>n.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const a=e.jsonData||{};this.database=a.dbName??e.database,this.interval=a.timeInterval,this.httpMode=a.httpMode||"GET",this.responseParser=new Cr,this.isFlux=a.version===R.Flux,this.isProxyAccess=e.access==="proxy",this.retentionPolicies=[],this.isFlux?this.annotations={QueryEditor:ae}:this.annotations={QueryEditor:Er,prepareAnnotation:xr}}async getRetentionPolicies(){return this.isFlux||this.retentionPolicies.length?Promise.resolve(this.retentionPolicies):le(this).catch(e=>(console.error("Unable to fetch retention policies. Queries will be run without specifying retention policy.",e),Promise.resolve(this.retentionPolicies)))}query(e){if(!this.isProxyAccess){const t=new Error(de);return(0,Be._)(()=>t)}return(0,cr.P)(()=>this.getRetentionPolicies()).pipe((0,mr.z)(t=>{this.retentionPolicies=t;const a={...e,targets:e.targets.map(n=>(n.policy=n.policy?this.templateSrv.replace(n.policy,{},"regex"):"",{...n,policy:ve(n.policy,this.retentionPolicies)}))};return this._query(a)}))}_query(e){const t={...e,targets:e.targets.filter(a=>a.hide!==!0)};return this.isFlux?super.query(t):this.isMigrationToggleOnAndIsAccessProxy()?super.query(t).pipe((0,J.U)(a=>{if(a.error)throw{message:"InfluxDB Error: "+a.error.message,res:a};const n=[],l=(0,f.groupBy)(a.data,i=>i.refId);return Object.keys(l).length>0&&t.targets.forEach(i=>{const o=l[i.refId]??[];switch(i.resultFormat){case"logs":case"table":n.push(this.responseParser.getTable(o,i,{preferredVisualisationType:i.resultFormat}));break;default:{for(let u=0;u<o.length;u++)n.push(o[u]);break}}}),{data:n}})):this.classicQuery(e)}getQueryDisplayText(e){return this.isFlux?e.query:new A(e).render(!1)}filterQuery(e){return this.isFlux?!!e.query:!0}applyTemplateVariables(e,t){const{__interval:a,__interval_ms:n,...l}=t||{};return this.isFlux?{...e,query:this.templateSrv.replace(e.query??"",l)}:(U.ZP.featureToggles.influxdbBackendMigration&&this.access==="proxy"&&(e=this.applyVariables(e,t,l)),e)}classicQuery(e){if(e.targets.some(m=>m.fromAnnotations)){const m=[];for(const h of e.targets)h.query&&m.push(new dr.y(y=>{this.annotationEvents(e,h).then(w=>y.next({data:[(0,pr.g0)(w)]})).catch(w=>y.error(new Error(w))).finally(()=>y.complete())}));return(0,gr.T)(...m)}let t=this.getTimeFilter(e);const a=e.scopedVars,n=(0,f.cloneDeep)(e.targets),l=[];let i,o,u=(0,f.map)(n,m=>m.hide?"":(l.push(m),a.interval=a.__interval,new A(m,this.templateSrv,a).render(!0))).reduce((m,h)=>(h!==""&&(m+=";"+h),m));if(u==="")return(0,ue.of)({data:[]});const c=this.templateSrv.getAdhocFilters(this.name),d=e.targets.flatMap(m=>m.adhocFilters??[]);if(c?.length||d?.length){const m=c?.length?c:d,h=new A({refId:"A"},this.templateSrv,a);t+=" AND "+h.renderAdhocFilters(m)}return a.timeFilter={value:t},u=this.templateSrv.replace(u,a),this._seriesQuery(u,e).pipe((0,J.U)(m=>{if(!m||!m.results)return{data:[]};const h=[];for(i=0;i<m.results.length;i++){const y=m.results[i];if(!y||!y.series)continue;const w=l[i];let b=w.alias;b&&(b=this.templateSrv.replace(w.alias,e.scopedVars));const Z={executedQueryString:m.executedQueryString},q=new Le({refId:w.refId,series:m.results[i].series,alias:b,meta:Z});switch(w.resultFormat){case"logs":Z.preferredVisualisationType="logs";case"table":{h.push(q.getTable());break}default:{const p=q.getTimeSeries();for(o=0;o<p.length;o++)h.push(Ir(p[o]));break}}}return{data:h}}))}async annotationEvents(e,t){if(this.isFlux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!t.query)return Promise.reject({message:"Query missing in annotation definition"});if(U.ZP.featureToggles.influxdbBackendMigration&&this.access==="proxy"){const l={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(t.query,void 0,"regex"),rawQuery:!0};return(0,Y.n)((0,Me.i)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[l]},requestId:t.name}).pipe((0,J.U)(async i=>await this.responseParser.transformAnnotationResponse(t,i,l))))}const a=this.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone});let n=t.query.replace("$timeFilter",a);return n=this.templateSrv.replace(n,void 0,"regex"),(0,Y.n)(this._seriesQuery(n,e)).then(l=>{if(!l||!l.results||!l.results[0])throw{message:"No results in response from InfluxDB"};return new Le({series:l.results[0].series,annotation:t}).getAnnotations()})}targetContainsTemplate(e){const t=this.isFlux?e.query:ye(e);return this.templateSrv.containsTemplate(t)}interpolateVariablesInQueries(e,t){return!e||e.length===0?[]:e.map(a=>this.isFlux?{...a,datasource:this.getRef(),query:this.templateSrv.replace(a.query??"",t,"regex")}:{...a,datasource:this.getRef(),...this.applyVariables(a,t,t)})}applyVariables(e,t,a){const n={...e};return e.groupBy&&(n.groupBy=e.groupBy.map(l=>({...l,params:l.params?.map(i=>this.templateSrv.replace(i.toString(),void 0,"regex"))}))),e.select&&(n.select=e.select.map(l=>l.map(i=>({...i,params:i.params?.map(o=>this.templateSrv.replace(o.toString(),void 0,"regex"))})))),e.tags&&(n.tags=e.tags.map(l=>({...l,value:this.templateSrv.replace(l.value,t,"regex")}))),{...n,adhocFilters:this.templateSrv.getAdhocFilters(this.name)??[],query:this.templateSrv.replace(e.query??"",a,"regex"),alias:this.templateSrv.replace(e.alias??"",t),limit:this.templateSrv.replace(e.limit?.toString()??"",t,"regex"),measurement:this.templateSrv.replace(e.measurement??"",t,"regex"),policy:this.templateSrv.replace(e.policy??"",t,"regex"),slimit:this.templateSrv.replace(e.slimit?.toString()??"",t,"regex"),tz:this.templateSrv.replace(e.tz??"",t)}}async metricFindQuery(e,t){if(this.isFlux||this.isMigrationToggleOnAndIsAccessProxy()){const n={refId:"metricFindQuery",query:e,rawQuery:!0};return(0,Y.n)(super.query({...t,targets:[n]})).then(l=>l.data?.length?(0,Qe.S9)(l.data[0]):[])}const a=new A({refId:"metricFindQuery",query:e,rawQuery:!0},this.templateSrv,t.scopedVars).render(!0);return(0,Y.n)(this._seriesQuery(a,t)).then(n=>this.responseParser.parse(e,n))}getTagKeys(e={}){const a=new se({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(a,e)}getTagValues(e={}){const a=new se({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",e.key);return this.metricFindQuery(a,e)}_seriesQuery(e,t){if(!e)return(0,ue.of)({results:[]});if(t&&t.range){const a=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",a)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?(0,f.reduce)(e,(t,a,n)=>(a==null||t.push(encodeURIComponent(n)+"="+encodeURIComponent(a)),t),[]).join("&"):""}_influxRequest(e,t,a,n){const l=this.urls.shift();this.urls.push(l);const i={};this.username&&(i.u=this.username,i.p=this.password),n&&n.database?i.db=n.database:this.database&&(i.db=this.database),n?.policy&&(i.rp=n.policy);const{q:o}=a;e==="POST"&&(0,f.has)(a,"q")?((0,f.extend)(i,(0,f.omit)(a,["q"])),a=this.serializeParams((0,f.pick)(a,["q"]))):(e==="GET"||e==="POST")&&((0,f.extend)(i,a),a=null);const u={method:e,url:l+t,params:i,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,Me.i)().fetch(u).pipe((0,J.U)(c=>{const{data:d}=c;if(d&&(d.executedQueryString=o,d.results)){const m=c.data.results.filter(h=>h.error);if(m.length>0)throw{message:"InfluxDB Error: "+m[0].error,data:d}}return d}),(0,fr.K)(c=>c.cancelled?(0,ue.of)(c):(0,Be._)(this.handleErrors(c))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){const t=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),a=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+t+" and time <= "+a}getInfluxTime(e,t,a){if((0,f.isString)(e)){if(e==="now")return"now()";const n=/^now-(\d+)([dhms])$/.exec(e);if(n){const l=parseInt(n[1],10),i=n[2];return"now() - "+l+i}e=hr.parse(e,t,a)}return e.valueOf()+"ms"}isMigrationToggleOnAndIsAccessProxy(){return U.ZP.featureToggles.influxdbBackendMigration&&this.access==="proxy"}}const Ar=new We.hf(Nr).setConfigEditor(je).setQueryEditor(or).setVariableQueryEditor(ur).setQueryEditorHelp(Ze)}}]);

//# sourceMappingURL=influxdbPlugin.6a89750b5ef4b172a302.js.map