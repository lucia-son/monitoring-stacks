"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9704],{61674:(O,y,l)=>{l.r(y),l.d(y,{plugin:()=>De});var E=l(89424),n=l(66111),x=l(13821),h=l(93006),b=l(86647),Q=l(12006),v=l(14835),T=l(97291),V=l(45253),W=l(47694),k=l(57706),$=l.n(k),j=l(59980),U=l(22069),Z=l(20308),C=l(51649),K=l(82897),N=l(59679),A=l(206),G=l(19974);const ze=Object.freeze([0,0]),H="both",J={groupBy:[],labelSelector:"{}"};var p=l(9892),f=l(72648);function S(t){const e=(0,f.wW)((0,n.useCallback)(a=>X(a,t),[t]));return n.createElement("div",{className:e.root},t.children)}const X=(t,e)=>({root:(0,p.css)({display:"flex",flexDirection:e.direction??"row",flexWrap:e.wrap??!0?"wrap":void 0,alignItems:e.alignItems,gap:t.spacing(e.gap??2),flexGrow:e.flexGrow})}),w=({children:t,stackProps:e})=>{const a=(0,f.wW)(Y);return n.createElement("div",{className:a.root},n.createElement(S,{gap:2,...e},t))},Y=t=>({root:(0,p.css)({padding:t.spacing(1),backgroundColor:t.colors.background.secondary,borderRadius:t.shape.borderRadius(1)})}),q=({children:t})=>n.createElement(S,{gap:.5,direction:"column"},t);var _=l(33411),ee=l(9405);const te={id:"phlareql",extensions:[".phlareql"],aliases:["phlare","phlareql"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".phlareql",keywords:[],operators:[],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,"tag"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"]],autoClosingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};class ae{constructor(){this.triggerCharacters=["{",",","[","(","=","~"," ",'"'],this.labels=[],this.getLabelValues=()=>Promise.resolve([])}init(e,a){this.labels=e,this.getLabelValues=a}provideCompletionItems(e,a){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==e.id)return{suggestions:[]};const{range:r,offset:o}=ie(this.monaco,e,a),u=se(e.getValue(),o);return this.getCompletions(u).then(s=>{const d=s.length.toString().length;return{suggestions:s.map((c,g)=>({kind:ne(c.type,this.monaco),label:c.label,insertText:c.insertText,sortText:g.toString().padStart(d,"0"),range:r}))}})}async getCompletions(e){switch(e.type){case"UNKNOWN":return[];case"EMPTY":return this.labels.map(r=>({label:r,insertText:`{${r}="`,type:"LABEL_NAME"}));case"IN_LABEL_NAME":return this.labels.map(r=>({label:r,insertText:r,type:"LABEL_NAME"}));case"IN_LABEL_VALUE":return(await this.getLabelValues(e.labelName)).map(r=>({label:r,insertText:e.betweenQuotes?r:`"${r}"`,type:"LABEL_VALUE"}));default:throw new Error(`Unexpected situation ${e}`)}}}function ne(t,e){switch(t){case"LABEL_NAME":return e.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return e.languages.CompletionItemKind.EnumMember;default:throw new Error(`Unexpected CompletionType: ${t}`)}}const P=/[a-zA-Z_][a-zA-Z0-9_]*/,R=/[^"]*/,re=new RegExp(`(${P.source})="(${R.source})"`,"g"),oe=new RegExp(`(${P.source})=("?)${R.source}$`),le=new RegExp(/[{,]\s*[a-zA-Z0-9_]*$/);function se(t,e){if(t==="")return{type:"EMPTY"};const a=t.matchAll(re),r=Array.from(a).reduce((s,d)=>{const[i,c,g]=d[1];return s.push({name:c,value:g}),s},[]),o=t.substring(0,e).match(oe);return o?{type:"IN_LABEL_VALUE",labelName:o[1],betweenQuotes:!!o[2],otherLabels:r}:t.substring(0,e).match(le)?{type:"IN_LABEL_NAME",otherLabels:r}:{type:"UNKNOWN"}}function ie(t,e,a){const r=e.getWordAtPosition(a),o=r!=null?t.Range.lift({startLineNumber:a.lineNumber,endLineNumber:a.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):t.Range.fromPositions(a),u={column:a.column,lineNumber:a.lineNumber};return{offset:e.getOffsetAt(u),range:o}}function ce(t){const e=de(t.getLabelValues,t.labels),a=(0,f.wW)(pe),r=(0,_.Z)(t.onRunQuery),o=(0,n.useRef)(null);return n.createElement("div",{className:a.wrapper,ref:o},n.createElement(ee.p,{value:t.value,language:m,onBlur:t.onChange,containerStyles:a.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on",padding:{top:5,bottom:6}},onBeforeEditorMount:ge,onEditorDidMount:(u,s)=>{e(u,s);const d=()=>{const i=o.current;if(i!==null){const c=u.getContentHeight();i.style.height=`${c+ue}px`,i.style.width="100%";const g=i.clientWidth;u.layout({width:g,height:c})}};u.onDidContentSizeChange(d),d(),u.addCommand(s.KeyMod.Shift|s.KeyCode.Enter,()=>{r.current(u.getValue())})}}))}const ue=2;function de(t,e){const a=(0,n.useRef)();a.current===void 0&&(a.current=new ae),(0,N.Z)(async()=>{a.current&&a.current.init(e||[],t)},[e,t]);const r=(0,n.useRef)(null);return(0,n.useEffect)(()=>()=>{r.current?.()},[]),(o,u)=>{if(a.current){a.current.editor=o,a.current.monaco=u;const{dispose:s}=u.languages.registerCompletionItemProvider(m,a.current);r.current=s}}}let F=!1;const m="phlareql";function ge(t){if(F===!1){F=!0;const{aliases:e,extensions:a,mimetypes:r,def:o}=te;t.languages.register({id:m,aliases:e,extensions:a,mimetypes:r}),t.languages.setMonarchTokensProvider(m,o.language),t.languages.setLanguageConfiguration(m,o.languageConfiguration)}}const pe=()=>({queryField:p.css`
      flex: 1;
      // Not exactly sure but without this the editor does not shrink after resizing (so you can make it bigger but not
      // smaller). At the same time this does not actually make the editor 100px because it has flex 1 so I assume
      // this should sort of act as a flex-basis (but flex-basis does not work for this). So yeah CSS magic.
      width: 100px;
    `,wrapper:p.css`
      display: flex;
      flex: 1;
      border: 1px solid rgba(36, 41, 46, 0.3);
      border-radius: 2px;
    `});var fe=l(95831),I=l(39904),me=l(2594),ye=l(8581),he=l(46967),be=l(61970),ve=l(61860),Ee=l(24799),xe=l(7804);const L=t=>{const{label:e,optional:a,tooltip:r,children:o,width:u,...s}=t,d=(0,f.l4)(),i=Se(d,u),c=s?.htmlFor||be?.getChildId(o),g=n.createElement(n.Fragment,null,n.createElement("label",{className:i.label,htmlFor:c},e,a&&n.createElement("span",{className:i.optional}," - optional"),r&&n.createElement(ve.u,{placement:"top",content:r,theme:"info"},n.createElement(I.J,{name:"info-circle",size:"sm",className:i.icon}))),n.createElement("span",{className:i.space}));return n.createElement("div",{className:i.root},n.createElement(Ee.g,{className:i.field,label:g,...s},o))},Se=(0,xe.B)((t,e)=>({space:(0,p.css)({paddingRight:t.spacing(0),paddingBottom:t.spacing(.5)}),root:(0,p.css)({minWidth:t.spacing(e??0)}),label:(0,p.css)({fontSize:12,fontWeight:t.typography.fontWeightMedium}),optional:(0,p.css)({fontStyle:"italic",color:t.colors.text.secondary}),field:(0,p.css)({marginBottom:0}),icon:(0,p.css)({color:t.colors.text.secondary,marginLeft:t.spacing(1),":hover":{color:t.colors.text.primary}})})),B=[{value:"metrics",label:"Metric",description:"Return aggregated metrics"},{value:"profile",label:"Profile",description:"Return profile"},{value:"both",label:"Both",description:"Return both metric and profile data"}];function Le(t){return t===A.zj.Explore?B:B.filter(e=>e.value!=="both")}function Te({query:t,onQueryChange:e,app:a,labels:r}){const[o,u]=(0,fe.Z)(!1),s=(0,f.wW)(Ce),d=Le(a),i=r?r.map(c=>({label:c,value:c})):[];return n.createElement(S,{gap:0,direction:"column"},n.createElement("div",{className:s.header,onClick:u,title:"Click to edit options"},n.createElement("div",{className:s.toggle},n.createElement(I.J,{name:o?"angle-down":"angle-right"})),n.createElement("h6",{className:s.title},"Options"),!o&&n.createElement("div",{className:s.description},[`Type: ${t.queryType}`,t.groupBy?.length?`Group by: ${t.groupBy.join(", ")}`:void 0].filter(c=>c).map((c,g)=>n.createElement("span",{key:g},c)))),o&&n.createElement("div",{className:s.body},n.createElement(L,{label:"Query Type"},n.createElement(me.S,{options:d,value:t.queryType,onChange:c=>e({...t,queryType:c})})),n.createElement(L,{label:"Group by",tooltip:n.createElement(n.Fragment,null,"Used to group the metric result by a specific label or set of labels. Does not apply to profile query.")},n.createElement(ye.NU,{placeholder:"Label",value:t.groupBy,allowCustomValue:!0,options:i,onChange:c=>{const g=c.map(Me=>Me.value);e({...t,groupBy:g})}})),n.createElement(L,{label:"Max Nodes",tooltip:n.createElement(n.Fragment,null,"Sets the maximum number of nodes to return in the flamegraph.")},n.createElement(he.I,{value:t.maxNodes||"",type:"number",placeholder:"16384",onChange:c=>{let g=parseInt(c.currentTarget.value,10);g=isNaN(g)?0:g,e({...t,maxNodes:g})}}))))}const Ce=t=>({switchLabel:(0,p.css)({color:t.colors.text.secondary,cursor:"pointer",fontSize:t.typography.bodySmall.fontSize,"&:hover":{color:t.colors.text.primary}}),header:(0,p.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:t.colors.text.primary,"&:hover":{background:t.colors.emphasize(t.colors.background.primary,.03)}}),title:(0,p.css)({flexGrow:1,overflow:"hidden",fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightMedium,margin:0}),description:(0,p.css)({color:t.colors.text.secondary,fontSize:t.typography.bodySmall.fontSize,paddingLeft:t.spacing(2),gap:t.spacing(2),display:"flex"}),body:(0,p.css)({display:"flex",paddingTop:t.spacing(2),gap:t.spacing(2),flexWrap:"wrap"}),toggle:(0,p.css)({color:t.colors.text.secondary,marginRight:`${t.spacing(1)}`})}),Ne={...J,queryType:H};function Ae(t){let e=D(t.query,t.app);function a(g){t.onChange({...t.query,labelSelector:g}),t.onRunQuery()}const{profileTypes:r,onProfileTypeChange:o,selectedProfileName:u}=Re(t.datasource,t.query,t.onChange,t.datasource.backendType),{labels:s,getLabelValues:d,onLabelSelectorChange:i}=we(t.range,t.datasource,t.query,t.onChange),c=Pe(r);return n.createElement(q,null,n.createElement(w,{stackProps:{wrap:!1,gap:1}},n.createElement(G.O,{onChange:o,options:c,buttonProps:{variant:"secondary"}},u),n.createElement(ce,{value:e.labelSelector,onChange:i,onRunQuery:a,labels:s,getLabelValues:d})),n.createElement(w,null,n.createElement(Te,{query:e,onQueryChange:t.onChange,app:t.app,labels:s})))}function we(t,e,a,r){const o={to:Math.ceil((t?.to.valueOf()||0)/5e3)*5e3,from:Math.floor((t?.from.valueOf()||0)/5e3)*5e3},u=(0,N.Z)(()=>e.getLabelNames(a.profileTypeId+a.labelSelector,o.from,o.to),[e,a.profileTypeId,a.labelSelector,o.to,o.from]),s=(0,n.useCallback)(i=>e.getLabelValues(a.profileTypeId+a.labelSelector,i,o.from,o.to),[a,e,o.to,o.from]),d=(0,n.useCallback)(i=>{r({...a,labelSelector:i})},[r,a]);return{labels:u.value,getLabelValues:s,onLabelSelectorChange:d}}function Pe(t){return(0,n.useMemo)(()=>{let e=new Map;for(let a of t){let r;if(a.id.indexOf(":")>-1)r=a.id.split(":");else{r=a.id.split(".");const s=r.pop();r=[r.join("."),s]}const[o,u]=r;e.has(o)||e.set(o,{label:o,value:a.id,children:[]}),e.get(o)?.children?.push({label:u,value:a.id})}return Array.from(e.values())},[t])}function Re(t,e,a,r="phlare"){const[o,u]=(0,n.useState)([]);(0,n.useEffect)(()=>{(async()=>{const i=await t.getProfileTypes();u(i)})()},[t]);const s=(0,n.useCallback)((i,c)=>{if(c.length===0)return;const g=c[c.length-1].value;if(typeof g!="string")throw new Error("id is not string");a({...e,profileTypeId:g})},[a,e]),d=Fe(o,e.profileTypeId,r);return{profileTypes:o,onProfileTypeChange:s,selectedProfileName:d}}function Fe(t,e,a){return(0,n.useMemo)(()=>{if(!t)return"Loading";const r=t.find(o=>o.id===e);return r?r.label:a==="pyroscope"?"Select application":"Select a profile type"},[e,t,a])}function D(t,e){let a=(0,K.defaults)(t,Ne);return e!==A.zj.Explore&&a.queryType==="both"&&(a.queryType="profile"),a}class M extends U.CK{constructor(e,a=(0,Z.J)()){super(e),this.templateSrv=a,this.backendType=e.jsonData.backendType??"phlare"}query(e){const a=e.targets.filter(r=>r.profileTypeId).map(r=>r.labelSelector===""?{...r,labelSelector:"{}"}:D(r,e.app));return a.length?super.query({...e,targets:a}):(0,j.of)({data:[]})}async getProfileTypes(){return await super.getResource("profileTypes")}async getLabelNames(e,a,r){return await super.getResource("labelNames",{query:e,start:a,end:r})}async getLabelValues(e,a,r,o){return await super.getResource("labelValues",{label:a,query:e,start:r,end:o})}async getBackendType(e){return await super.getResource("backendType",{url:e})}applyTemplateVariables(e,a){return{...e,labelSelector:this.templateSrv.replace(e.labelSelector??"",a)}}async importFromAbstractQueries(e){return e.map(a=>this.importFromAbstractQuery(a))}importFromAbstractQuery(e){return{refId:e.refId,labelSelector:(0,C.PL)(e),queryType:"both",profileTypeId:"",groupBy:[]}}async exportToAbstractQueries(e){return e.map(a=>this.exportToAbstractQuery(a))}exportToAbstractQuery(e){const a=e.labelSelector;if(!a||a.length===0)return{refId:e.refId,labelMatchers:[]};const r=$().tokenize(a,Ie);return{refId:e.refId,labelMatchers:(0,C.UO)(r)}}}const Ie={"context-labels":{pattern:/\{[^}]*(?=}?)/,greedy:!0,inside:{comment:{pattern:/#.*/},"label-key":{pattern:/[a-zA-Z_]\w*(?=\s*(=|!=|=~|!~))/,alias:"attr-name",greedy:!0},"label-value":{pattern:/"(?:\\.|[^\\"])*"/,greedy:!0,alias:"attr-value"},punctuation:/[{]/}},punctuation:/[{}(),.]/},Be=t=>{const{options:e,onOptionsChange:a}=t,[r,o]=n.useState(),u=(0,b.F)(),[,s]=(0,x.Z)(async()=>{if(!e.url)return;const d=await u.get({type:e.type,uid:e.uid});if(!(d instanceof M))throw new Error("Datasource is not a PhlareDataSource");const{backendType:i}=await d.getBackendType(e.url);if(i==="unknown"){o(void 0);return}if(e.jsonData.backendType){i!==e.jsonData.backendType?o(i):o(void 0);return}a({...e,jsonData:{...e.jsonData,backendType:i}})},[e]);return(0,h.Z)(s,500,[e]),n.createElement(n.Fragment,null,n.createElement(Q.E,{defaultUrl:"http://localhost:4100",dataSourceConfig:e,showAccessOptions:!1,onChange:a,secureSocksDSProxyEnabled:W.vc.secureSocksDSProxyEnabled}),n.createElement("h3",{className:"page-heading"},"Querying"),n.createElement("div",{className:"gf-form-group"},n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(v.LegacyForms.FormField,{label:"Minimal step",labelWidth:13,inputEl:n.createElement(v.LegacyForms.Input,{className:"width-6",value:e.jsonData.minStep,spellCheck:!1,placeholder:"15s",onChange:d=>{a({...e,jsonData:{...e.jsonData,minStep:d.currentTarget.value}})},validationEvents:{[T.JU.onBlur]:[(0,T.FE)(/^$|^\d+(ms|[Mwdhmsy])$/,"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s")]}}),tooltip:"Minimal step used for metric query. Should be the same or higher as the scrape interval setting in the Phlare database."}))),n.createElement("div",{className:"gf-form-inline"},n.createElement("div",{className:"gf-form"},n.createElement(v.LegacyForms.FormField,{label:"Backend type",labelWidth:13,inputEl:n.createElement(v.LegacyForms.Select,{allowCustomValue:!1,value:e.jsonData.backendType?z[e.jsonData.backendType]:void 0,options:Object.values(z),onChange:d=>{a({...e,jsonData:{...e.jsonData,backendType:d.value}})}}),tooltip:"Select what type of backend you use. This datasource supports both Phlare and Pyroscope backends."}))),r&&n.createElement(V.b,{title:`"${e.jsonData.backendType}" option is selected but it seems like you are using "${r}" backend.`,severity:"warning"})))},z={phlare:{label:"Phlare",value:"phlare"},pyroscope:{label:"Pyroscope",value:"pyroscope"}},De=new E.hf(M).setConfigEditor(Be).setQueryEditor(Ae)},33411:(O,y,l)=>{l.d(y,{Z:()=>x});var E=l(66111),n=function(h){var b=(0,E.useRef)(h);return b.current=h,b};const x=n}}]);

//# sourceMappingURL=phlarePlugin.20b48e20f2b2f13a74ae.js.map