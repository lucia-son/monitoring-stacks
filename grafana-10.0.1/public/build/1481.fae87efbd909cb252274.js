"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1481],{46081:(P,I,n)=>{n.d(I,{_:()=>S});var g=n(9892),d=n(66111),e=n(26418),L=n(72648),N=n(39904);const S=({label:m,value:$,icon:T})=>{const O=(0,L.wW)(R);return d.createElement("div",{className:O.meta().wrapper},d.createElement(e.Stack,{direction:"row",gap:0,alignItems:"stretch"},d.createElement("div",{className:O.meta().label},d.createElement(e.Stack,{direction:"row",gap:.5,alignItems:"center"},T&&d.createElement(N.J,{name:T})," ",m??"")),d.createElement("div",{className:O.meta().value},$)))},R=m=>({meta:$=>({wrapper:g.css`
      font-size: ${m.typography.bodySmall.fontSize};
    `,label:g.css`
      display: flex;
      align-items: center;

      padding: ${m.spacing(.33)} ${m.spacing(1)};
      background: ${m.colors.secondary.transparent};

      border: solid 1px ${m.colors.border.medium};
      border-top-left-radius: ${m.shape.borderRadius(2)};
      border-bottom-left-radius: ${m.shape.borderRadius(2)};
    `,value:g.css`
      padding: ${m.spacing(.33)} ${m.spacing(1)};
      font-weight: ${m.typography.fontWeightBold};

      border: solid 1px ${m.colors.border.medium};
      border-left: none;
      border-top-right-radius: ${m.shape.borderRadius(2)};
      border-bottom-right-radius: ${m.shape.borderRadius(2)};
    `})})},81481:(P,I,n)=>{n.r(I),n.d(I,{default:()=>Ue,getStyles:()=>le});var g=n(9892),d=n(82897),e=n(66111),L=n(66698),N=n(67483),S=n(26418),R=n(72648),m=n(45253),$=n(61860),T=n(39904),O=n(34807),Q=n(31403),ie=n(24799),ce=n(64353),me=n(46967),A=n(85719),z=n(29122);function ue(t){(0,z.Z)(1,arguments);var a=(0,A.Z)(t),s=a.getTime();return s}function de(t){return(0,z.Z)(1,arguments),Math.floor(ue(t)/1e3)}var ge=n(29427);const fe=ge.C.injectEndpoints({endpoints:t=>({getRuleHistory:t.query({query:({ruleUid:a,from:s,to:r=de(new Date)})=>({url:"/api/v1/rules/history",params:{ruleUID:a,from:s,to:r}})})})});var Z=n(20194),pe=n(42042),ve=n(10929),X=n(8679),Ee=n(68900),ye=n(96529),he=n(81777),Se=n(93552),k=1e3*60,B=60*24,q=B*30,_=B*365;function be(t,a,s){var r,u,c;(0,z.Z)(2,arguments);var i=(0,ve.j)(),l=(r=(u=s?.locale)!==null&&u!==void 0?u:i.locale)!==null&&r!==void 0?r:Se.Z;if(!l.formatDistance)throw new RangeError("locale must contain localize.formatDistance property");var E=(0,Ee.Z)(t,a);if(isNaN(E))throw new RangeError("Invalid time value");var o=(0,he.Z)((0,ye.Z)(s),{addSuffix:Boolean(s?.addSuffix),comparison:E}),f,x;E>0?(f=(0,A.Z)(a),x=(0,A.Z)(t)):(f=(0,A.Z)(t),x=(0,A.Z)(a));var D=String((c=s?.roundingMethod)!==null&&c!==void 0?c:"round"),h;if(D==="floor")h=Math.floor;else if(D==="ceil")h=Math.ceil;else if(D==="round")h=Math.round;else throw new RangeError("roundingMethod must be 'floor', 'ceil' or 'round'");var p=x.getTime()-f.getTime(),y=p/k,F=(0,X.Z)(x)-(0,X.Z)(f),b=(p-F)/k,C=s?.unit,v;if(C?v=String(C):y<1?v="second":y<60?v="minute":y<B?v="hour":b<q?v="day":b<_?v="month":v="year",v==="second"){var W=h(p/1e3);return l.formatDistance("xSeconds",W,o)}else if(v==="minute"){var K=h(y);return l.formatDistance("xMinutes",K,o)}else if(v==="hour"){var j=h(y/60);return l.formatDistance("xHours",j,o)}else if(v==="day"){var G=h(b/B);return l.formatDistance("xDays",G,o)}else if(v==="month"){var U=h(b/q);return U===12&&C!=="month"?l.formatDistance("xYears",1,o):l.formatDistance("xMonths",U,o)}else if(v==="year"){var Y=h(b/_);return l.formatDistance("xYears",Y,o)}throw new RangeError("unit must be 'second', 'minute', 'hour', 'day', 'month' or 'year'")}function Te(t,a){return(0,z.Z)(1,arguments),be(t,Date.now(),a)}var xe=n(77258),Ie=n(46081),ee=n(45608),V=n(38645);const te=e.memo(({records:t,commonLabels:a,onLabelClick:s,onRecordsRendered:r})=>{const u=(0,R.wW)(H),c=t.reduce((l,E)=>{const o=l.get(E.timestamp);return o?o.push(E):l.set(E.timestamp,[E]),l},new Map),i=new Map;return(0,e.useEffect)(()=>{r&&r(i)}),e.createElement("ul",{className:u.logsScrollable,"aria-label":"State history by timestamp"},Array.from(c.entries()).map(([l,E])=>e.createElement("li",{id:l.toString(10),key:l,"data-testid":l,ref:o=>o&&i.set(l,o)},e.createElement(Re,{time:l}),e.createElement("div",{className:u.logsContainer},E.map(({line:o})=>e.createElement(e.Fragment,{key:(0,d.uniqueId)()},e.createElement(ee.l,{state:o.previous,size:"sm",muted:!0}),e.createElement(T.J,{name:"arrow-right",size:"sm"}),e.createElement(ee.l,{state:o.current}),e.createElement(S.Stack,{direction:"row"},o.values&&e.createElement(J,{record:o.values})),e.createElement("div",null,o.labels&&e.createElement(O.P,{tags:(0,V.r)(Object.entries(o.labels),a).map(([f,x])=>`${f}=${x}`),onClick:s}))))))))});te.displayName="LogRecordViewerByTimestamp";function Ve({records:t,commonLabels:a}){const s=useStyles2(H),r=groupBy(t,u=>JSON.stringify(u.line.labels));return React.createElement(React.Fragment,null,Object.entries(r).map(([u,c])=>React.createElement(Stack,{direction:"column",key:u},React.createElement("h4",null,React.createElement(TagList,{tags:omitLabels(Object.entries(c[0].line.labels??{}),a).map(([i,l])=>`${i}=${l}`)})),React.createElement("div",{className:s.logsContainer},c.map(({line:i,timestamp:l})=>React.createElement("div",{key:uniqueId()},React.createElement(AlertStateTag,{state:i.previous,size:"sm",muted:!0}),React.createElement(Icon,{name:"arrow-right",size:"sm"}),React.createElement(AlertStateTag,{state:i.current}),React.createElement(Stack,{direction:"row"},i.values&&React.createElement(J,{record:i.values})),React.createElement("div",null,dateTimeFormat(l))))))))}const Re=({time:t})=>{const a=new Date(t),s=(0,R.wW)(H);return e.createElement("div",{className:s.timestampWrapper},e.createElement(S.Stack,{direction:"row",alignItems:"center",gap:1},e.createElement(T.J,{name:"clock-nine",size:"sm"}),e.createElement("span",{className:s.timestampText},(0,xe.dq)(a)),e.createElement("small",null,"(",Te(a)," ago)")))},J=e.memo(({record:t})=>{const a=Object.entries(t);return e.createElement(e.Fragment,null,a.map(([s,r])=>e.createElement(Ie._,{key:s,label:s,value:r})))});J.displayName="AlertInstanceValues";const H=t=>({logsContainer:g.css`
    display: grid;
    grid-template-columns: max-content max-content max-content auto max-content;
    gap: ${t.spacing(2,1)};
    align-items: center;
  `,logsScrollable:g.css`
    height: 500px;
    overflow: scroll;

    flex: 1;
  `,timestampWrapper:g.css`
    color: ${t.colors.text.secondary};
    padding: ${t.spacing(1)} 0;
  `,timestampText:g.css`
    color: ${t.colors.text.primary};
    font-size: ${t.typography.bodySmall.fontSize};
    font-weight: ${t.typography.fontWeightBold};
  `});var Le=n(89050),Ne=n(924),ne=n(40538),Me=n(59420),Ce=n(97551);const ae=e.memo(({frames:t,timeRange:a,onPointerMove:s=d.noop})=>{const r=(0,R.l4)(),{setupCursorTracking:u}=Oe(s);return e.createElement(Le.Z,{disableHeight:!0},({width:c})=>e.createElement(Me.K,{frames:t,timeRange:a,timeZone:"browser",mode:Ce.KN.Changes,height:18*t.length+50,width:c,showValue:ne.Jp.Never,theme:r,rowHeight:.8,legend:{calcs:[],displayMode:ne.jK.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:r.colors.success.main,yAxis:1},{label:"Pending",color:r.colors.warning.main,yAxis:1},{label:"Alerting",color:r.colors.error.main,yAxis:1},{label:"NoData",color:r.colors.info.main,yAxis:1}]},i=>(u(i),null)))});function Oe(t){const a=(0,e.useRef)(new Ne.X({seriesIdx:0,pointIdx:0}));return(0,e.useEffect)(()=>{const r=a.current.subscribe(({seriesIdx:u,pointIdx:c})=>{t&&t(u,c)});return()=>{r.unsubscribe()}},[t]),{setupCursorTracking:r=>{r.setSync();const u=r.getTooltipInterpolator();u&&r.addHook("setCursor",c=>{u(i=>{if(i){const l=a.current.getValue();a.current.next({...l,seriesIdx:i})}},i=>{if(i){const l=a.current.getValue();a.current.next({...l,pointIdx:i})}},()=>{},c)})}}}ae.displayName="LogTimelineViewer";var re=n(99098),De=n(6194),$e=n(76152),se=n(85596);function Ae(t,a){const s=(0,R.l4)();return(0,e.useMemo)(()=>{const r=t?.data?.values[0]??[],u=Fe(r)?r:[],c=t?.data?.values[1]??[],i=u.reduce((p,y,F)=>{const b=c[F];return Pe(b)&&p.push({timestamp:y,line:b}),p},[]),l=(0,d.groupBy)(i,p=>JSON.stringify(p.line.labels)),o=Object.keys(l).map(p=>Object.entries(JSON.parse(p))),f=(0,V.z)(o),x=a?(0,Z.Zh)(a):[],h=Object.entries(l).filter(([p])=>{const y=JSON.parse(p);return(0,Z.eD)(y,x)}).map(([p,y])=>ze(p,y,f,s));return{historyRecords:i.filter(({line:p})=>p.labels&&(0,Z.eD)(p.labels,x)),dataFrames:h,commonLabels:f,totalRecordsCount:i.length}},[t,a,s])}function Fe(t){return t.every(a=>typeof a=="number")}function Pe(t){return typeof t=="object"&&t!==null&&"current"in t&&"previous"in t}function ze(t,a,s,r){const u=Object.entries(JSON.parse(t)),c={name:"time",type:re.fS.time,values:[...a.map(o=>o.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},i=c.values.map((o,f)=>f);i.sort((0,$e.Mo)(c));const l=[...a.map(o=>o.line.current),a.at(-1)?.line.current],E={fields:[{...c,values:c.values.map((o,f)=>c.values[i[f]])},{name:"state",type:re.fS.string,values:l.map((o,f)=>l[i[f]]),config:{displayName:(0,V.r)(u,s).map(([o,f])=>`${o}=${f}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:se.Hi.ValueToText,options:{Alerting:{color:r.colors.error.main},Pending:{color:r.colors.warning.main},Normal:{color:r.colors.success.main},NoData:{color:r.colors.info.main}}}],thresholds:{mode:se.H3.Absolute,steps:[]}}}],length:c.values.length,name:t};return E.fields.forEach(o=>{o.display=(0,De.U_)({field:o,theme:r})}),E}const Ze=12,Be=({ruleUID:t})=>{const a=(0,R.wW)(le),[s,r]=(0,e.useState)(""),u=(0,e.useRef)(new Map),{getValues:c,setValue:i,register:l,handleSubmit:E}=(0,L.cI)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:o}=fe,f=(0,e.useMemo)(()=>je(),[]),{currentData:x,isLoading:D,isError:h,error:p}=o({ruleUid:t,from:f.from.unix(),to:f.to.unix()}),{dataFrames:y,historyRecords:F,commonLabels:b,totalRecordsCount:C}=Ae(x,s),{frameSubset:v,frameSubsetTimestamps:W}=We(y),K=(0,e.useCallback)(M=>{const w=(0,Z.vB)(c("query"),M);r(w),i("query",w)},[r,i,c]),j=(0,e.useCallback)(()=>{r(""),i("query","")},[r,i]),G=(0,e.useCallback)((M,w)=>{const we=W[w];u.current.get(we)?.scrollIntoView({behavior:"smooth",block:"start"})},[W]);if(D)return e.createElement("div",null,"Loading...");if(h)return e.createElement(m.b,{title:"Error fetching the state history",severity:"error"},p instanceof Error?p.message:"Unable to fetch alert state history");const U=v.length<y.length,Y=C>0?`No matches were found for the given filters among the ${C} instances`:"No state transitions have occurred in the last 60 minutes";return e.createElement("div",{className:a.fullSize},e.createElement("form",{onSubmit:E(M=>r(M.query))},e.createElement(oe,{...l("query"),showClearFilterSuffix:!!s,onClearFilterClick:j}),e.createElement("input",{type:"submit",hidden:!0})),!(0,d.isEmpty)(b)&&e.createElement("div",{className:a.commonLabels},e.createElement(S.Stack,{gap:1,alignItems:"center"},e.createElement("strong",null,"Common labels"),e.createElement($.u,{content:"Common labels are the ones attached to all of the alert instances"},e.createElement(T.J,{name:"info-circle"}))),e.createElement(O.P,{tags:b.map(M=>M.join("="))})),(0,d.isEmpty)(v)?e.createElement(e.Fragment,null,e.createElement("div",{className:a.emptyState},Y,C>0&&e.createElement(Q.zx,{variant:"secondary",type:"button",onClick:j},"Clear filters"))):e.createElement(e.Fragment,null,e.createElement("div",{className:a.graphWrapper},e.createElement(ae,{frames:v,timeRange:f,onPointerMove:G})),U&&e.createElement("div",{className:a.moreInstancesWarning},e.createElement(S.Stack,{direction:"row",alignItems:"center",gap:1},e.createElement(T.J,{name:"exclamation-triangle",size:"sm"}),e.createElement("small",null,`Only showing ${v.length} out of ${y.length} instances. Click on the labels to narrow down the results`))),e.createElement(te,{records:F,commonLabels:b,onRecordsRendered:M=>u.current=M,onLabelClick:K})))};function We(t){return(0,e.useMemo)(()=>{const a=(0,d.take)(t,Ze),s=(0,d.sortBy)((0,d.uniq)(a.flatMap(r=>r.fields[0].values)));return{frameSubset:a,frameSubsetTimestamps:s}},[t])}const oe=e.forwardRef(({showClearFilterSuffix:t,onClearFilterClick:a,...s},r)=>e.createElement(ie.g,{label:e.createElement(ce._,{htmlFor:"instancesSearchInput"},e.createElement(S.Stack,{gap:.5},e.createElement("span",null,"Filter instances"),e.createElement(pe.z,{content:e.createElement(e.Fragment,null,"Use label matcher expression (like ",e.createElement("code",null,"{foo=bar}"),") or click on an instance label to filter instances")},e.createElement(T.J,{name:"info-circle",size:"sm"}))))},e.createElement(me.I,{id:"instancesSearchInput",prefix:e.createElement(T.J,{name:"search"}),suffix:t&&e.createElement(Q.zx,{fill:"text",icon:"times",size:"sm",onClick:a},"Clear"),placeholder:"Filter instances",ref:r,...s})));oe.displayName="SearchFieldInput";function je(){const t=(0,N.CQ)().subtract(1,"h"),a=(0,N.CQ)();return{from:t,to:a,raw:{from:t,to:a}}}const le=t=>({fullSize:g.css`
    min-width: 100%;
    height: 100%;

    display: flex;
    flex-direction: column;
  `,graphWrapper:g.css`
    padding: ${t.spacing()} 0;
  `,emptyState:g.css`
    color: ${t.colors.text.secondary};

    display: flex;
    flex-direction: column;
    gap: ${t.spacing(2)};
    align-items: center;
    margin: auto auto;
  `,moreInstancesWarning:g.css`
    color: ${t.colors.warning.text};
    padding: ${t.spacing()};
  `,commonLabels:g.css`
    display: grid;
    grid-template-columns: max-content auto;
  `}),Ue=Be},38645:(P,I,n)=>{n.d(I,{r:()=>e,z:()=>L});var g=n(82897),d=n.n(g);function e(N,S){return N.filter(R=>!S.find(m=>JSON.stringify(m)===JSON.stringify(R)))}function L(N){const S=N.flatMap(m=>m);return(0,g.uniqBy)(S.filter(m=>S.filter(T=>(0,g.isEqual)(m,T)).length===Object.keys(N).length),m=>JSON.stringify(m))}},81777:(P,I,n)=>{n.d(I,{Z:()=>g});function g(d,e){if(d==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var L in e)Object.prototype.hasOwnProperty.call(e,L)&&(d[L]=e[L]);return d}},96529:(P,I,n)=>{n.d(I,{Z:()=>d});var g=n(81777);function d(e){return(0,g.Z)({},e)}}}]);

//# sourceMappingURL=1481.fae87efbd909cb252274.js.map