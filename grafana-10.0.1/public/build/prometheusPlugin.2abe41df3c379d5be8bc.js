"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7004],{9903:(xe,ee,m)=>{m.d(ee,{O6:()=>u,Ql:()=>ue,ZO:()=>N,f0:()=>g,qV:()=>W,we:()=>ce,xu:()=>te,zj:()=>ge});var U=m(31075),e=m(8373),oe=m(19370),R=m(91720);function ce(y,M){const P=[Ce()],D=["$__interval"];let I;return y===R.B5.QuantileOverTime&&(D.push("0.95"),P.push({name:"Quantile",type:"number"})),M&&(P.push({name:"By label",type:"string",restParam:!0,optional:!0}),I=(0,e.ZI)(`__${y}_by`)),{id:y,name:(0,e.t7)(y),params:P,defaultParams:D,alternativesKey:"range function",category:R.Ly.RangeFunctions,orderRank:R.jK.RangeVectorFunction,renderer:he,addOperationHandler:g,paramChangedHandler:I,explainHandler:(F,K)=>{let z=oe.r8.find(ae=>ae.insertText===F.id)?.documentation??"";return F.params[0]==="$__interval"?`${z} \`$__interval\` is a variable that will be replaced with the [calculated interval](https://grafana.com/docs/grafana/latest/dashboards/variables/add-template-variables/#__interval) based on the time range and width of the graph. In Dashboards, you can affect the interval variable using **Max data points** and **Min interval**. You can find these options under **Query options** right of the data source select dropdown.`:`${z} The [range vector](https://grafana.com/docs/loki/latest/logql/metric_queries/#range-vector-aggregation) is set to \`${F.params[0]}\`.`}}}function u(y){const M=ce(y,!0),P=M.params.slice(0,-1);return[M,{id:`__${y}_by`,name:`${(0,e.t7)(y)} by`,params:[...P,{name:"Label",type:"string",restParam:!0,optional:!0,editor:U.g}],defaultParams:[...M.defaultParams,""],alternativesKey:"range function with grouping",category:R.Ly.RangeFunctions,renderer:Z(y,"by"),paramChangedHandler:(0,e.j8)(y),explainHandler:(0,e.Sp)(y,"by"),addOperationHandler:g,hideFromList:!0},{id:`__${y}_without`,name:`${(0,e.t7)(y)} without`,params:[...P,{name:"Label",type:"string",restParam:!0,optional:!0,editor:U.g}],defaultParams:[...M.defaultParams,""],alternativesKey:"range function with grouping",category:R.Ly.RangeFunctions,renderer:Z(y,"without"),paramChangedHandler:(0,e.j8)(y),explainHandler:(0,e.Sp)(y,"without"),addOperationHandler:g,hideFromList:!0}]}function Z(y,M){return function(D,I,F){const K=I.params.findIndex(Me=>Me.restParam),z=D.params.slice(0,K),ae=D.params.slice(K);return z.length===2&&y===R.B5.QuantileOverTime?`${y}(${z[1]}, ${F} [${z[0]}]) ${M} (${ae.join(", ")})`:`${y}(${F} [${z[0]}]) ${M} (${ae.join(", ")})`}}function he(y,M,P){const D=y.params??[],I=D[0]??"$__interval";if(D.length===2&&y.id===R.B5.QuantileOverTime){const F=D[1];return`${y.id}(${F}, ${P} [${I}])`}return`${y.id}(${P} [${D[0]??"$__interval"}])`}function te(y,M,P){return["<","<=",">",">="].includes(String(y.params[1]))?`${P} | ${y.params[0]} ${y.params[1]} ${y.params[2]}`:`${P} | ${y.params[0]} ${y.params[1]} \`${y.params[2]}\``}function N(y,M){const P=y.params[1].toString().startsWith("!");return M.filter(F=>F.id===R.B5.LabelFilter&&F.params[0]===y.params[0]&&F.params[2]===y.params[2]).some(F=>!!(P&&F.params[1].toString().startsWith("!")===!1||P===!1&&F.params[1].toString().startsWith("!")))}function ue(y,M,P){return`${P} | ${y.id}`}function Se(y){return y.category===R.Ly.RangeFunctions}function V(y,M,P){const D=y.findIndex(I=>{const F=M.getOperationDef(I.id);return F?P(F):!1});return D===-1?y.length:D}function g(y,M,P){const D={id:y.id,params:y.defaultParams},I=[...M.operations],F=I.find(K=>{const z=P.getOperationDef(K.id);return z?Se(z):!1});switch(y.category){case R.Ly.Aggregations:case R.Ly.Functions:if(!F){const z=V(I,P,ae=>ae.category===R.Ly.Functions);I.splice(z,0,{id:R.B5.Rate,params:["$__interval"]})}I.push(D);break;case R.Ly.RangeFunctions:if(F){const z=I.indexOf(F);I[z]=D;break}default:const K=V(I,P,z=>(y.orderRank??100)<(z.orderRank??100));I.splice(K,0,D);break}return{...M,operations:I}}function W(y,M){return{...M,binaryQueries:[...M.binaryQueries??[],{operator:"/",query:M}]}}function ge(y,M){return function(D,I,F){return M?`${F} ${y} \`(?i)${D.params[0]}\``:`${F} ${y} \`${D.params[0]}\``}}function Ce(){return{name:"Range",type:"string",options:["$__interval","$__range","1m","5m","10m","1h","24h"]}}},91720:(xe,ee,m)=>{m.d(ee,{AI:()=>ce,B5:()=>oe,Hv:()=>U,Ly:()=>e,jK:()=>R});var U=(u=>(u.Log="log",u.Metric="metric",u))(U||{}),e=(u=>(u.Aggregations="Aggregations",u.RangeFunctions="Range functions",u.Functions="Functions",u.Formats="Formats",u.LineFilters="Line filters",u.LabelFilters="Label filters",u.BinaryOps="Binary operations",u))(e||{}),oe=(u=>(u.Json="json",u.Logfmt="logfmt",u.Regexp="regexp",u.Pattern="pattern",u.Unpack="unpack",u.LineFormat="line_format",u.LabelFormat="label_format",u.Rate="rate",u.RateCounter="rate_counter",u.CountOverTime="count_over_time",u.SumOverTime="sum_over_time",u.AvgOverTime="avg_over_time",u.MaxOverTime="max_over_time",u.MinOverTime="min_over_time",u.FirstOverTime="first_over_time",u.LastOverTime="last_over_time",u.StdvarOverTime="stdvar_over_time",u.StddevOverTime="stddev_over_time",u.QuantileOverTime="quantile_over_time",u.BytesRate="bytes_rate",u.BytesOverTime="bytes_over_time",u.AbsentOverTime="absent_over_time",u.Sum="sum",u.Avg="avg",u.Min="min",u.Max="max",u.Stddev="stddev",u.Stdvar="stdvar",u.Count="count",u.TopK="topk",u.BottomK="bottomk",u.LineContains="__line_contains",u.LineContainsNot="__line_contains_not",u.LineContainsCaseInsensitive="__line_contains_case_insensitive",u.LineContainsNotCaseInsensitive="__line_contains_not_case_insensitive",u.LineMatchesRegex="__line_matches_regex",u.LineMatchesRegexNot="__line_matches_regex_not",u.LineFilterIpMatches="__line_filter_ip_matches",u.LabelFilter="__label_filter",u.LabelFilterNoErrors="__label_filter_no_errors",u.LabelFilterIpMatches="__label_filter_ip_marches",u.Unwrap="unwrap",u.SumBy="__sum_by",u.SumWithout="__sum_without",u.Addition="__addition",u.Subtraction="__subtraction",u.MultiplyBy="__multiply_by",u.DivideBy="__divide_by",u.Modulo="__modulo",u.Exponent="__exponent",u.NestedQuery="__nested_query",u.EqualTo="__equal_to",u.NotEqualTo="__not_equal_to",u.GreaterThan="__greater_than",u.LessThan="__less_than",u.GreaterOrEqual="__greater_or_equal",u.LessOrEqual="__less_or_equal",u))(oe||{}),R=(u=>(u[u.LineFilters=1]="LineFilters",u[u.LineFormats=2]="LineFormats",u[u.LabelFilters=3]="LabelFilters",u[u.Unwrap=4]="Unwrap",u[u.NoErrors=5]="NoErrors",u[u.RangeVectorFunction=5]="RangeVectorFunction",u[u.Last=6]="Last",u))(R||{});const ce={equals:{label:"=",value:"=",description:"Equals",isMultiValue:!1},doesNotEqual:{label:"!=",value:"!=",description:"Does not equal",isMultiValue:!1},matchesRegex:{label:"=~",value:"=~",description:"Matches regex",isMultiValue:!0},doesNotMatchRegex:{label:"!~",value:"!~",description:"Does not match regex",isMultiValue:!0},greaterThan:{label:">",value:">",description:"Greater than",isMultiValue:!1},greaterThanOrEqual:{label:">=",value:">=",description:"Greater than or equal to",isMultiValue:!1},lessThan:{label:"<",value:"<",description:"Less than",isMultiValue:!1},lessThanOrEqual:{label:"<=",value:"<=",description:"Less than or equal to",isMultiValue:!1},contains:{label:"|=",value:"|=",description:"Contains",isMultiValue:!1},doesNotContain:{label:"!=",value:"!=",description:"Does not contain",isMultiValue:!1}}},71682:(xe,ee,m)=>{m.r(ee),m.d(ee,{plugin:()=>Fl});var U=m(89424),e=m(66111);const oe=[{title:"Request Rate",expression:"rate(http_request_total[5m])",label:"Given an HTTP request counter, this query calculates the per-second average request rate over the last 5 minutes."},{title:"95th Percentile of Request Latencies",expression:"histogram_quantile(0.95, sum(rate(prometheus_http_request_duration_seconds_bucket[5m])) by (le))",label:"Calculates the 95th percentile of HTTP request rate over 5 minute windows."},{title:"Alerts Firing",expression:'sort_desc(sum(sum_over_time(ALERTS{alertstate="firing"}[24h])) by (alertname))',label:"Sums up the alerts that have been firing over the last 24 hours."},{title:"Step",label:"Defines the graph resolution using a duration format (15s, 1m, 3h, ...). Small steps create high-resolution graphs but can be slow over larger time ranges. Using a longer step lowers the resolution and smooths the graph by producing fewer datapoints. If no step is given the resolution is calculated automatically."}],ce=t=>e.createElement("div",null,e.createElement("h2",null,"PromQL Cheat Sheet"),oe.map((a,l)=>e.createElement("div",{className:"cheat-sheet-item",key:l},e.createElement("div",{className:"cheat-sheet-item__title"},a.title),a.expression?e.createElement("button",{type:"button",className:"cheat-sheet-item__example",onClick:r=>t.onClickExample({refId:"A",expr:a.expression})},e.createElement("code",null,a.expression)):null,e.createElement("div",{className:"cheat-sheet-item__label"},a.label))));var u=m(206),Z=m(82897),he=m(52666),te=m(68183),N=m(26418),ue=m(41818),Se=m(98102),V=m(31403),g=m(9892),W=m(72648),ge=m(35029),Ce=m(2352),y=m(99822),M=m(4252),P=m(72948),D=m(45204),I=m(21899);const F=t=>{const{pattern:a,onPatternSelect:l,hasNewQueryOption:r,hasPreviousQuery:o,selectedPatternName:i,setSelectedPatternName:p}=t,n=(0,W.wW)(K),s={grammar:I.ZP,name:"promql"};return e.createElement(P.Z,{className:n.card},e.createElement(P.Z.Heading,null,a.name),e.createElement("div",{className:n.rawQueryContainer},e.createElement(D.U,{"aria-label":`${a.name} raw query`,query:M.Z.renderQuery({labels:[],operations:a.operations,binaryQueries:a.binaryQueries}),lang:s,className:n.rawQuery})),e.createElement(P.Z.Actions,null,i!==a.name?e.createElement(V.zx,{size:"sm","aria-label":"use this query button",onClick:()=>{o?p(a.name):l(a)}},"Use this query"):e.createElement(e.Fragment,null,e.createElement("div",{className:n.spacing},`If you would like to use this query, ${r?"you can either apply this query pattern or create a new query":"this query pattern will be applied to your current query"}.`),e.createElement(V.zx,{size:"sm","aria-label":"back button",fill:"outline",onClick:()=>p(null)},"Back"),e.createElement(V.zx,{size:"sm","aria-label":"apply query starter button",onClick:()=>{l(a)}},"Apply query"),r&&e.createElement(V.zx,{size:"sm","aria-label":"create new query button",onClick:()=>{l(a,!0)}},"Create new query"))))},K=t=>({card:g.css`
      width: 49.5%;
      display: flex;
      flex-direction: column;
    `,rawQueryContainer:g.css`
      flex-grow: 1;
    `,rawQuery:g.css`
      background-color: ${t.colors.background.primary};
      padding: ${t.spacing(1)};
      margin-top: ${t.spacing(1)};
    `,spacing:g.css`
      margin-bottom: ${t.spacing(1)};
    `});var z=m(80522),ae=m(62513);const Me=t=>{const{isOpen:a,onClose:l,onChange:r,onAddQuery:o,query:i,queries:p,app:n}=t,[s,v]=(0,e.useState)([]),[h,b]=(0,e.useState)(null),w=(0,W.wW)(Dt),x=!!o,S=(0,e.useMemo)(()=>{const f=(0,z._)(i.expr??""),E=f.query.operations.length>0,d=f.query.metric,c=f.query.labels.length>0,C=f.query.binaryQueries?f.query.binaryQueries.length>0:!1;return E||d||c||C},[i.expr]),X=(f,E=!1)=>{const d=(0,z._)(E?"":i.expr);(0,ue.ff)("grafana_prom_kickstart_your_query_selected",{app:n??"",editorMode:i.editorMode,selectedPattern:f.name,preSelectedOperationsCount:d.query.operations.length,preSelectedLabelsCount:d.query.labels.length,createNewQuery:x&&E}),d.query.operations=f.operations,d.query.binaryQueries=f.binaryQueries,x&&E?o({...i,refId:(0,y.Hs)(p??[i]),expr:M.Z.renderQuery(d.query)}):r({...i,expr:M.Z.renderQuery(d.query)}),b(null),l()};return e.createElement(ge.u,{"aria-label":"Kick start your query modal",isOpen:a,title:"Kick start your query",onDismiss:l},e.createElement("div",{className:w.spacing},"Kick start your query by selecting one of these queries. You can then continue to complete your query."),Object.values(ae.Fz).map(f=>e.createElement(Ce.U,{"aria-label":`open and close ${f} query starter card`,key:f,label:`${(0,Z.capitalize)(f)} query starters`,isOpen:s.includes(f),collapsible:!0,onToggle:()=>v(E=>E.includes(f)?E.filter(d=>d!==f):[...E,f])},e.createElement("div",{className:w.cardsContainer},M.Z.getQueryPatterns().filter(E=>E.type===f).map(E=>e.createElement(F,{key:E.name,pattern:E,hasNewQueryOption:x,hasPreviousQuery:S,onPatternSelect:X,selectedPatternName:h,setSelectedPatternName:b}))))),e.createElement(V.zx,{"aria-label":"close kick start your query modal",variant:"secondary",onClick:l},"Close"))},Dt=t=>({cardsContainer:g.css`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
    `,spacing:g.css`
      margin-bottom: ${t.spacing(1)};
    `});var Ft=m(92611),At=m(61458),Oe=m(89290),k=m(58079),He=m(58379),Q=m(37462);const je="PrometheusQueryEditorModeDefault";function ke(t,a,l){t.expr===""&&He.Z.set(je,a),l({...t,editorMode:a})}function It(t,a=k.c.Builder){if(t!=null&&t!=="")return k.c.Code;const l=He.Z.get(je);switch(l){case k.c.Builder:case k.c.Code:return l;default:return a}}function zt(t,a,l){let r=t;t.editorMode||(r={...t,editorMode:It(t.expr,l)}),t.expr==null&&(r={...r,expr:"",legendFormat:Q.pD.Auto}),t.range==null&&t.instant==null&&(r={...r,range:!0},a===u.zj.Explore&&(r.instant=!0));const o=t.instant&&t.range;return a===u.zj.UnifiedAlerting&&o&&(r={...r,instant:!1,range:!0}),r}var Ue=m(62992),J=m(35645),we=m(36784),Qt=m(58439),Lt=m(41285),$t=m(19023),Rt=m(73250),Bt=m(75765),Te=m(44812),Xt=m(99151),Ne=m.n(Xt),de=m(13572),O=m(8581),Vt=m(55271),fe=m.n(Vt),Wt=m(64861),G=m(46967),Ot=m(67487),q=m(8944),L=m(81764),Ht=m(78889),jt=m(39904);function kt({feedbackUrl:t}){const a=(0,W.wW)(Ut);return e.createElement(N.Stack,{gap:1},e.createElement("a",{href:t,className:a.link,title:"The Metrics Modal is new, please let us know how we can improve it",target:"_blank",rel:"noreferrer noopener"},e.createElement(jt.J,{name:"comment-alt-message"})," Give feedback"))}function Ut(t){return{link:(0,g.css)({color:t.colors.text.secondary,fontSize:t.typography.bodySmall.fontSize,":hover":{color:t.colors.text.link}})}}const Ge=(t,a)=>({modal:g.css`
      width: 85vw;
      ${t.breakpoints.down("md")} {
        width: 100%;
      }
      ${t.breakpoints.up("xl")} {
        width: 60%;
      }
    `,inputWrapper:g.css`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: ${t.spacing(2)};
      margin-bottom: ${t.spacing(2)};
    `,inputItemFirst:g.css`
      flex-basis: 40%;
    `,inputItem:g.css`
      flex-grow: 1;
      flex-basis: 20%;
      ${t.breakpoints.down("md")} {
        min-width: 100%;
      }
    `,selectWrapper:g.css`
      margin-bottom: ${t.spacing(1)};
    `,selectItem:g.css`
      display: flex;
      flex-direction: row;
      align-items: center;
    `,selectItemLabel:g.css`
      margin: 0 0 0 ${t.spacing(1)};
      align-self: center;
      color: ${t.colors.text.secondary};
    `,resultsHeading:g.css`
      margin: 0 0 0 0;
    `,resultsData:g.css`
      margin: 0 0 ${t.spacing(1)} 0;
    `,resultsDataCount:g.css`
      margin: 0;
    `,resultsDataFiltered:g.css`
      margin: 0;
      color: ${t.colors.warning.text};
    `,alphabetRow:g.css`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      column-gap: ${t.spacing(1)};
      margin-bottom: ${t.spacing(1)};
    `,alphabetRowToggles:g.css`
      display: flex;
      flex-direction: row;
      align-items: center;
      flex-wrap: wrap;
      column-gap: ${t.spacing(1)};
    `,results:g.css`
      height: calc(80vh - 280px);
      overflow-y: scroll;
    `,pageSettingsWrapper:g.css`
      padding-top: ${t.spacing(1.5)};
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      position: sticky;
    `,pageSettings:g.css`
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: center;
    `,selAlpha:g.css`
      cursor: pointer;
      color: #6e9fff;
    `,active:g.css`
      cursor: pointer;
    `,gray:g.css`
      color: grey;
      opacity: 50%;
    `,loadingSpinner:g.css`
      display: inline-block;
      visibility: hidden;
    `,table:g.css`
      white-space: ${a?"nowrap":"normal"};
      td {
        vertical-align: baseline;
        padding: 0;
      }
    `,tableDiv:g.css`
      padding: 8px;
    `,visible:g.css`
      visibility: visible;
    `});function Gt(t){const{filteredMetrics:a,disableTextWrap:l,updateLetterSearch:r,letterSearch:o}=t,i=Zt(),p=(0,W.l4)(),n=Ge(p,l);return a.forEach((s,v)=>{const h=s.value[0].toUpperCase();Ze.includes(h)&&!i[h]&&(i[h]+=1)}),e.createElement("div",null,Object.keys(i).map(s=>{const v=i[s]>0;function h(){r(s)}const b=o===s?n.selAlpha:"",w=v?n.active:n.gray;return e.createElement("span",{onClick:v?h:()=>{},className:`${b} ${w}`,key:s,"data-testid":"letter-"+s},s+" ")}))}const Ze=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"];function Zt(){const t={};return Ze.forEach(a=>t[a]=0),t}function Kt(t){const{metrics:a,onChange:l,onClose:r,query:o,state:i,selectedIdx:p,disableTextWrap:n}=t,s=(0,W.l4)(),v=Jt(s,n),h=(0,e.useRef)(null);function b(S){return S===p}function w(S){S.value&&(l({...o,metric:S.value}),(0,ue.ff)("grafana_prom_metric_encycopedia_tracking",{metric:S.value,hasMetadata:i.hasMetadata,totalMetricCount:i.totalMetricCount,fuzzySearchQuery:i.fuzzySearchQuery,fullMetaSearch:i.fullMetaSearch,selectedTypes:i.selectedTypes,letterSearch:i.letterSearch}),r())}(0,e.useEffect)(()=>{h.current?.getElementsByClassName("selected-row")[0]?.scrollIntoView({block:"nearest",inline:"nearest"})},[p]);function x(S){return i.fullMetaSearch&&S?e.createElement(e.Fragment,null,e.createElement("td",null,e.createElement(fe(),{textToHighlight:S.type??"",searchWords:i.metaHaystackMatches,autoEscape:!0,highlightClassName:v.matchHighLight})),e.createElement("td",null,e.createElement(fe(),{textToHighlight:S.description??"",searchWords:i.metaHaystackMatches,autoEscape:!0,highlightClassName:v.matchHighLight}))):e.createElement(e.Fragment,null,e.createElement("td",null,S.type??""),e.createElement("td",null,S.description??""))}return e.createElement("table",{className:v.table,ref:h},e.createElement("thead",null,e.createElement("tr",{className:v.header},e.createElement("th",null,"Name"),i.hasMetadata&&e.createElement(e.Fragment,null,e.createElement("th",null,"Type"),e.createElement("th",null,"Description")))),e.createElement("tbody",null,e.createElement(e.Fragment,null,a&&a.map((S,X)=>e.createElement("tr",{key:S?.value??X,className:`${v.row} ${b(X)?`${v.selectedRow} selected-row`:""}`,onClick:()=>w(S)},e.createElement("td",null,e.createElement(fe(),{textToHighlight:S?.value??"",searchWords:i.fullMetaSearch?i.metaHaystackMatches:i.nameHaystackMatches,autoEscape:!0,highlightClassName:v.matchHighLight})),i.hasMetadata&&x(S))))))}const Jt=(t,a)=>{const l=t.colors.emphasize(t.colors.background.primary,.03);return{table:g.css`
      border-radius: ${t.shape.borderRadius()};
      width: 100%;
      white-space: ${a?"nowrap":"normal"};
      td {
        padding: ${t.spacing(1)};
      }

      td,
      th {
        min-width: ${t.spacing(3)};
      }
    `,header:g.css`
      border-bottom: 1px solid ${t.colors.border.weak};
    `,row:g.css`
      label: row;
      cursor: pointer;
      border-bottom: 1px solid ${t.colors.border.weak}
      &:last-child {
        border-bottom: 0;
      }
      :hover {
        background-color: ${l};
      }
    `,selectedRow:g.css`
      background-color: ${l};
    `,matchHighLight:g.css`
      background: inherit;
      color: ${t.components.textHighlight.text};
      background-color: ${t.components.textHighlight.background};
    `}},Ke=100,Je=1e3,Pe=(0,Ue.oM)({name:"metrics-modal-state",initialState:qe(),reducers:{filterMetricsBackend:(t,a)=>{t.metrics=a.payload.metrics,t.filteredMetricCount=a.payload.filteredMetricCount,t.isLoading=a.payload.isLoading},buildMetrics:(t,a)=>{t.isLoading=a.payload.isLoading,t.metrics=a.payload.metrics,t.hasMetadata=a.payload.hasMetadata,t.metaHaystackDictionary=a.payload.metaHaystackDictionary,t.nameHaystackDictionary=a.payload.nameHaystackDictionary,t.totalMetricCount=a.payload.totalMetricCount,t.filteredMetricCount=a.payload.filteredMetricCount},setIsLoading:(t,a)=>{t.isLoading=a.payload},setFilteredMetricCount:(t,a)=>{t.filteredMetricCount=a.payload},setResultsPerPage:(t,a)=>{t.resultsPerPage=a.payload},setPageNum:(t,a)=>{t.pageNum=a.payload},setFuzzySearchQuery:(t,a)=>{t.fuzzySearchQuery=a.payload,t.pageNum=1,t.letterSearch="",t.selectedIdx=0},setNameHaystack:(t,a)=>{t.nameHaystackOrder=a.payload[0],t.nameHaystackMatches=a.payload[1]},setMetaHaystack:(t,a)=>{t.metaHaystackOrder=a.payload[0],t.metaHaystackMatches=a.payload[1]},setFullMetaSearch:(t,a)=>{t.fullMetaSearch=a.payload,t.pageNum=1},setExcludeNullMetadata:(t,a)=>{t.excludeNullMetadata=a.payload,t.pageNum=1},setSelectedTypes:(t,a)=>{t.selectedTypes=a.payload,t.pageNum=1},setLetterSearch:(t,a)=>{t.letterSearch=a.payload,t.pageNum=1},setUseBackend:(t,a)=>{t.useBackend=a.payload,t.fullMetaSearch=!1,t.excludeNullMetadata=!1,t.pageNum=1},setSelectedIdx:(t,a)=>{t.selectedIdx=a.payload},setDisableTextWrap:t=>{t.disableTextWrap=!t.disableTextWrap},showAdditionalSettings:t=>{t.showAdditionalSettings=!t.showAdditionalSettings}}});function qe(t){return{isLoading:!0,metrics:[],hasMetadata:!0,metaHaystackDictionary:{},metaHaystackMatches:[],metaHaystackOrder:[],nameHaystackDictionary:{},nameHaystackOrder:[],nameHaystackMatches:[],totalMetricCount:0,filteredMetricCount:null,resultsPerPage:Ke,pageNum:1,fuzzySearchQuery:"",fullMetaSearch:t?.fullMetaSearch??!1,excludeNullMetadata:t?.excludeNullMetadata??!1,selectedTypes:[],letterSearch:"",useBackend:t?.useBackend??!1,disableTextWrap:t?.disableTextWrap??!1,selectedIdx:0,showAdditionalSettings:!1}}function qt(t){return{useBackend:t?.useBackend??!1,disableTextWrap:t?.disableTextWrap??!1,fullMetaSearch:t?.fullMetaSearch??!1,excludeNullMetadata:t.excludeNullMetadata??!1}}const{setFilteredMetricCount:Yt}=Pe.actions;async function _t(t,a,l){let r=!0;const o=t.languageProvider.metricsMetadata;o&&Object.keys(o).length===0&&(r=!1);let i={},p={},n;return n=l?.map(s=>{const v=(0,we.nW)(s,t.languageProvider.metricsMetadata),h=(0,we.ws)(s,t.languageProvider.metricsMetadata),b=`${s}\xA6${v}\xA6${h}`,w={value:s,type:v,description:h};return i[s]=w,p[b]=w,w}),{isLoading:!1,hasMetadata:r,metrics:n??[],metaHaystackDictionary:p,nameHaystackDictionary:i,totalMetricCount:n?.length??0,filteredMetricCount:n?.length??0}}function Ye(t,a){const l=De(t);return!t.isLoading&&t.filteredMetricCount!==l.length&&a(Yt(l.length)),ta(l,t.pageNum,t.resultsPerPage)}function De(t,a){let l=t.metrics;return t.fuzzySearchQuery&&!t.useBackend&&(t.fullMetaSearch?l=t.metaHaystackOrder.map(r=>t.metaHaystackDictionary[r]):l=t.nameHaystackOrder.map(r=>t.nameHaystackDictionary[r])),t.letterSearch&&!a&&(l=l.filter((r,o)=>[t.letterSearch,t.letterSearch.toLowerCase()].includes(r.value[0]))),t.selectedTypes.length>0&&!t.useBackend&&(l=l.filter((r,o)=>{const i=t.selectedTypes.some(n=>n.value===r.type),p=!r.type;return i||p&&!t.excludeNullMetadata})),t.excludeNullMetadata&&(l=l.filter(r=>r.type!==void 0&&r.description!==void 0)),l}function ea(t){if(!t.metrics.length)return[];const a=t.resultsPerPage===0?1:t.resultsPerPage,l=Math.floor(De(t).length/a)+1;return[...Array(l).keys()].map(r=>r+1)}function ta(t,a,l){const r=l===0?1:l,o=a===1?0:(a-1)*r,i=o+r;return t.slice(o,i)}const aa=(t,a,l)=>t<1?1:t>l?l:t??a;async function la(t,a,l){const r=(0,Te.Vl)(t),o=a.map(n=>`,${n.label}="${n.value}"`),i=`label_values({__name__=~".*${r}"${a?o.join():""}},__name__)`;return await l.metricFindQuery(i).then(n=>n.map(s=>({value:s.text})))}const na=[{value:"counter",description:"A cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart."},{value:"gauge",description:"A metric that represents a single numerical value that can arbitrarily go up and down."},{value:"histogram",description:"A histogram samples observations (usually things like request durations or response sizes) and counts them in configurable buckets."},{value:"summary",description:"A summary samples observations (usually things like request durations and response sizes) and can calculate configurable quantiles over a sliding time window."}],me={browse:"Search metrics by name",metadataSearchSwitch:"Search by metadata type and description in addition to name",type:"Select...",variables:"Select...",excludeNoMetadata:"Exclude results with no metadata",setUseBackend:"Use the backend to browse metrics"};var _e=m(22759);const ra=new _e.Z({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1});function sa(t,a,l){const[r,o,i]=ra.search(t,a,!1,1e5);let p=[],n=new Set;if(r&&i){const s=(v,h)=>{h&&n.add(v)};for(let v=0;v<i.length;v++){let h=i[v];_e.Z.highlight(t[o.idx[h]],o.ranges[h],s),p.push(t[o.idx[h]])}l([p,[...n]])}}const et=(0,Z.debounce)(sa,300),{setIsLoading:tt,buildMetrics:ia,filterMetricsBackend:oa,setResultsPerPage:ca,setPageNum:ua,setFuzzySearchQuery:da,setNameHaystack:ma,setMetaHaystack:pa,setFullMetaSearch:ha,setExcludeNullMetadata:ga,setSelectedTypes:fa,setLetterSearch:at,setUseBackend:va,setSelectedIdx:lt,setDisableTextWrap:ya,showAdditionalSettings:ba}=Pe.actions,Ea=t=>{const{datasource:a,isOpen:l,onClose:r,onChange:o,query:i,initialMetrics:p}=t,[n,s]=(0,e.useReducer)(Pe.reducer,qe(i)),v=(0,W.l4)(),h=Ge(v,n.disableTextWrap),b=(0,e.useCallback)(async()=>{s(tt(!0));const d=await _t(a,i,p);s(ia({isLoading:!1,hasMetadata:d.hasMetadata,metrics:d.metrics,metaHaystackDictionary:d.metaHaystackDictionary,nameHaystackDictionary:d.nameHaystackDictionary,totalMetricCount:d.metrics.length,filteredMetricCount:d.metrics.length}))},[i,a,p]);(0,e.useEffect)(()=>{b()},[b]);const w=na.map(d=>({value:d.value,label:d.value,description:d.description})),x=(0,e.useMemo)(()=>Ne()(async d=>{s(tt(!0));const c=await la(d,i.labels,a);s(oa({metrics:c,filteredMetricCount:c.length,isLoading:!1}))},a.getDebounceTimeInMilliseconds()),[a,i]);function S(d){s(ma(d))}function X(d){s(pa(d))}function f(d,c){n.useBackend&&d===""?b():n.useBackend?x(d):c?et(Object.keys(n.metaHaystackDictionary),d,X):et(Object.keys(n.nameHaystackDictionary),d,S)}function E(d){if(d.code==="ArrowDown"&&n.selectedIdx<n.resultsPerPage-1)s(lt(n.selectedIdx+1));else if(d.code==="ArrowUp"&&n.selectedIdx>0)s(lt(n.selectedIdx-1));else if(d.code==="Enter"){const c=Ye(n,s)[n.selectedIdx];o({...i,metric:c.value}),(0,ue.ff)("grafana_prom_metric_encycopedia_tracking",{metric:c.value,hasMetadata:n.hasMetadata,totalMetricCount:n.totalMetricCount,fuzzySearchQuery:n.fuzzySearchQuery,fullMetaSearch:n.fullMetaSearch,selectedTypes:n.selectedTypes,letterSearch:n.letterSearch}),r()}}return e.createElement(ge.u,{"data-testid":se.metricModal,isOpen:l,title:"Browse metrics",onDismiss:r,"aria-label":"Browse metrics",className:h.modal},e.createElement("div",{className:h.inputWrapper},e.createElement("div",{className:(0,g.cx)(h.inputItem,h.inputItemFirst)},e.createElement(N.EditorField,{label:"Search metrics"},e.createElement(G.I,{autoFocus:!0,"data-testid":se.searchMetric,placeholder:me.browse,value:n.fuzzySearchQuery,onInput:d=>{const c=d.currentTarget.value??"";s(da(c)),f(c,n.fullMetaSearch)},onKeyDown:d=>{E(d)}}))),e.createElement("div",{className:h.inputItem},e.createElement(N.EditorField,{label:"Filter by type"},e.createElement(O.NU,{"data-testid":se.selectType,inputId:"my-select",options:w,value:n.selectedTypes,disabled:!n.hasMetadata||n.useBackend,placeholder:me.type,onChange:d=>{s(fa(d))}})))),e.createElement("div",{className:h.resultsData},e.createElement("div",{className:h.resultsDataCount},"Showing ",n.filteredMetricCount," of ",n.totalMetricCount," results."," ",e.createElement(Ot.$,{className:`${h.loadingSpinner} ${n.isLoading?h.visible:""}`}),e.createElement("div",{className:h.selectWrapper},e.createElement("div",{className:h.alphabetRow},e.createElement(Gt,{filteredMetrics:De(n,!0),disableTextWrap:n.disableTextWrap,updateLetterSearch:d=>{n.letterSearch===d?s(at("")):s(at(d))},letterSearch:n.letterSearch}),e.createElement(V.zx,{variant:"secondary",fill:"text",size:"sm",onClick:()=>s(ba()),onKeyDown:d=>{E(d)},"data-testid":se.showAdditionalSettings},"Additional Settings")),n.showAdditionalSettings&&e.createElement(e.Fragment,null,e.createElement("div",{className:h.selectItem},e.createElement(q.r,{"data-testid":se.searchWithMetadata,value:n.fullMetaSearch,disabled:n.useBackend||!n.hasMetadata,onChange:()=>{const d=!n.fullMetaSearch;s(ha(d)),o({...i,fullMetaSearch:d}),f(n.fuzzySearchQuery,d)},onKeyDown:d=>{E(d)}}),e.createElement("p",{className:h.selectItemLabel},me.metadataSearchSwitch)),e.createElement("div",{className:h.selectItem},e.createElement(q.r,{value:n.excludeNullMetadata,disabled:n.useBackend||!n.hasMetadata,onChange:()=>{s(ga(!n.excludeNullMetadata)),o({...i,excludeNullMetadata:!n.excludeNullMetadata})},onKeyDown:d=>{E(d)}}),e.createElement("p",{className:h.selectItemLabel},me.excludeNoMetadata)),e.createElement("div",{className:h.selectItem},e.createElement(q.r,{value:n.disableTextWrap,onChange:()=>{s(ya()),o({...i,disableTextWrap:!n.disableTextWrap})},onKeyDown:d=>{E(d)}}),e.createElement("p",{className:h.selectItemLabel},"Disable text wrap")),e.createElement("div",{className:h.selectItem},e.createElement(q.r,{"data-testid":se.setUseBackend,value:n.useBackend,onChange:()=>{const d=!n.useBackend;s(va(d)),o({...i,useBackend:d}),d===!1?b():n.fuzzySearchQuery!==""&&x(n.fuzzySearchQuery)},onKeyDown:d=>{E(d)}}),e.createElement("p",{className:h.selectItemLabel},me.setUseBackend))))),i.labels.length>0&&e.createElement("p",{className:h.resultsDataFiltered},"These metrics have been pre-filtered by labels chosen in the label filters.")),e.createElement("div",{className:h.results},n.metrics&&e.createElement(Kt,{metrics:Ye(n,s),onChange:o,onClose:r,query:i,state:n,selectedIdx:n.selectedIdx,disableTextWrap:n.disableTextWrap})),e.createElement("div",{className:h.pageSettingsWrapper},e.createElement("div",{className:h.pageSettings},e.createElement(L._,{label:"# results per page",tooltip:"The maximum results per page is "+Je,labelWidth:20},e.createElement(G.I,{"data-testid":se.resultsPerPage,value:aa(n.resultsPerPage,Ke,Je),placeholder:"results per page",width:20,onInput:d=>{const c=+d.currentTarget.value;isNaN(c)||s(ca(c))}})),e.createElement(Ht.t,{currentPage:n.pageNum??1,numberOfPages:ea(n).length,onNavigate:d=>{s(ua(d??1))}})),e.createElement(kt,{feedbackUrl:"https://forms.gle/DEMAJHoAMpe3e54CA"})))},se={metricModal:"metric-modal",searchMetric:"search-metric",searchWithMetadata:"search-with-metadata",selectType:"select-type",metricCard:"metric-card",useMetric:"use-metric",searchPage:"search-page",resultsPerPage:"results-per-page",setUseBackend:"set-use-backend",showAdditionalSettings:"show-additional-settings"},nt=" ",le=1e3,rt=J.v.featureToggles.prometheusMetricEncyclopedia;function xa({datasource:t,query:a,onChange:l,onGetMetrics:r,labelsFilters:o,metricLookupDisabled:i}){const p=(0,W.wW)(Sa),[n,s]=(0,e.useState)({}),v=(0,e.useCallback)((f,E)=>{const d=f.label??f.value;return d?d.toLowerCase?E.split(nt).reduce((C,T)=>C&&d.toLowerCase().includes(T.toLowerCase()),!0):!0:!1},[]),h=(0,e.useCallback)((f,E)=>f.__isNew__?f.label:e.createElement(fe(),{searchWords:E.inputValue.split(nt),textToHighlight:f.label??"",highlightClassName:p.highlight}),[p.highlight]),b=(f,E)=>{const d=(0,Te.Vl)(f);return Ca(d,E)},w=f=>t.metricFindQuery(b(f,o)).then(d=>(d.length>le&&d.splice(0,d.length-le),d.map(c=>({label:c.text,value:c.text})))),x=()=>Promise.resolve([]),S=Ne()(f=>w(f),t.getDebounceTimeInMilliseconds()),X=f=>{const E=f.data;if(E.value==="BrowseMetrics"){const d=f.isFocused?p.focus:"";return e.createElement("div",{...f.innerProps,onKeyDown:c=>{c.code==="Enter"&&s({...n,metricsModalOpen:!0})}},e.createElement("div",{className:`${p.customOption} ${d}`},e.createElement("div",null,e.createElement("div",null,E.label),e.createElement("div",{className:p.customOptionDesc},E.description)),e.createElement(V.zx,{variant:"primary",fill:"outline",size:"sm",onClick:()=>s({...n,metricsModalOpen:!0}),icon:"book"},"Open")))}return(0,Wt.Qn)(f)};return e.createElement(e.Fragment,null,rt&&!t.lookupsDisabled&&n.metricsModalOpen&&e.createElement(Ea,{datasource:t,isOpen:n.metricsModalOpen,onClose:()=>s({...n,metricsModalOpen:!1}),query:a,onChange:l,initialMetrics:n.initialMetrics??[]}),e.createElement(N.EditorFieldGroup,null,e.createElement(N.EditorField,{label:"Metric"},e.createElement(O.qb,{inputId:"prometheus-metric-select",className:p.select,value:a.metric?(0,de.E)(a.metric):void 0,placeholder:"Select metric",allowCustomValue:!0,formatOptionLabel:h,filterOption:v,onOpenMenu:async()=>{if(i)return;s({isLoading:!0});const f=await r(),E=f.map(d=>d.value);f.length>le&&f.splice(0,f.length-le),J.v.featureToggles.prometheusMetricEncyclopedia?s({metrics:[...[{value:"BrowseMetrics",label:"Browse metrics",description:"Browse and filter metrics and metadata with a fuzzy search"}],...f],isLoading:void 0,initialMetrics:E}):s({metrics:f,isLoading:void 0})},loadOptions:i?x:S,isLoading:n.isLoading,defaultOptions:n.metrics,onChange:({value:f})=>{f&&(rt&&f==="BrowseMetrics"?s({...n,metricsModalOpen:!0}):l({...a,metric:f}))},components:{Option:X}}))))}const Sa=t=>({select:g.css`
    min-width: 125px;
  `,highlight:g.css`
    label: select__match-highlight;
    background: inherit;
    padding: inherit;
    color: ${t.colors.warning.contrastText};
    background-color: ${t.colors.warning.main};
  `,customOption:g.css`
    padding: 8px;
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    :hover {
      background-color: ${t.colors.emphasize(t.colors.background.primary,.03)};
    }
  `,customOptionlabel:g.css`
    color: ${t.colors.text.primary};
  `,customOptionDesc:g.css`
    color: ${t.colors.text.secondary};
    font-size: ${t.typography.size.xs};
    opacity: 50%;
  `,focus:g.css`
    background-color: ${t.colors.emphasize(t.colors.background.primary,.03)};
  `}),Ca=(t,a)=>{const l=a?Ma(a):[];return`label_values({__name__=~".*${t}"${l?l.join(""):""}},__name__)`},Ma=t=>t.map(a=>`,${a.label}="${a.value}"`);function wa({item:t,defaultOp:a,onChange:l,onDelete:r,onGetLabelNames:o,onGetLabelValues:i,invalidLabel:p,invalidValue:n,getLabelValuesAutofillSuggestions:s,debounceDuration:v}){const[h,b]=(0,e.useState)({}),[w,x]=(0,e.useState)(!1),[S,X]=(0,e.useState)(!1),f=(c=t.op)=>st.find(C=>C.label===c)?.isMultiValue,E=c=>c?c.indexOf("|")>0?c.split("|"):[c]:[],d=Ne()(c=>s(c,t.label),v);return e.createElement("div",{"data-testid":"prometheus-dimensions-filter-item"},e.createElement(N.InputGroup,null,e.createElement(O.Ph,{placeholder:"Select label","aria-label":te.wl.components.QueryBuilder.labelSelect,inputId:"prometheus-dimensions-filter-item-key",width:"auto",value:t.label?(0,de.E)(t.label):null,allowCustomValue:!0,onOpenMenu:async()=>{b({isLoadingLabelNames:!0});const c=await o(t);x(!0),b({labelNames:c,isLoadingLabelNames:void 0})},onCloseMenu:()=>{x(!1)},isOpen:w,isLoading:h.isLoadingLabelNames??!1,options:h.labelNames,onChange:c=>{c.label&&l({...t,op:t.op??a,label:c.label})},invalid:p}),e.createElement(O.Ph,{"aria-label":te.wl.components.QueryBuilder.matchOperatorSelect,className:"query-segment-operator",value:(0,de.E)(t.op??a),options:st,width:"auto",onChange:c=>{c.value!=null&&l({...t,op:c.value,value:f(c.value)?t.value:E(t?.value)[0]})}}),e.createElement(O.qb,{placeholder:"Select value","aria-label":te.wl.components.QueryBuilder.valueSelect,inputId:"prometheus-dimensions-filter-item-value",width:"auto",value:f()?E(t?.value).map(de.E):E(t?.value).map(de.E)[0],allowCustomValue:!0,onOpenMenu:async()=>{b({isLoadingLabelValues:!0});const c=await i(t);c.length>le&&c.splice(0,c.length-le),X(!0),b({...h,labelValues:c,isLoadingLabelValues:void 0})},onCloseMenu:()=>{X(!1)},isOpen:S,defaultOptions:h.labelValues,isMulti:f(),isLoading:h.isLoadingLabelValues,loadOptions:d,onChange:c=>{if(c.value)l({...t,value:c.value,op:t.op??a});else{const C=c.map(T=>T.label).join("|");l({...t,value:C,op:t.op??a})}},invalid:n}),e.createElement(N.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:r})))}const st=[{label:"=",value:"=",isMultiValue:!1},{label:"!=",value:"!=",isMultiValue:!1},{label:"<",value:"<",isMultiValue:!1},{label:">",value:">",isMultiValue:!1},{label:"=~",value:"=~",isMultiValue:!0},{label:"!~",value:"!~",isMultiValue:!0}],Ta="Select at least 1 label filter (label and value)";function Na({labelsFilters:t,onChange:a,onGetLabelNames:l,onGetLabelValues:r,labelFilterRequired:o,getLabelValuesAutofillSuggestions:i,debounceDuration:p}){const n="=",[s,v]=(0,e.useState)([{op:n}]);(0,e.useEffect)(()=>{t.length>0?v(t):v([{op:n}])},[t]);const h=w=>{v(w);const x=w.filter(S=>S.label!=null&&S.value!=null);(0,Z.isEqual)(x,t)||a(x)},b=s.some(w=>w.label&&w.value);return e.createElement(N.EditorFieldGroup,null,e.createElement(N.EditorField,{label:"Label filters",error:Ta,invalid:o&&!b},e.createElement(N.EditorList,{items:s,onChange:h,renderItem:(w,x,S)=>e.createElement(wa,{debounceDuration:p,item:w,defaultOp:n,onChange:x,onDelete:S,onGetLabelNames:l,onGetLabelValues:r,invalidLabel:o&&!w.label,invalidValue:o&&!w.value,getLabelValuesAutofillSuggestions:i})})))}var Fe=m(68668),it=m(8180),Pa=m(12530);const ot=e.memo(t=>{const{nestedQuery:a,index:l,datasource:r,onChange:o,onRemove:i,onRunQuery:p,showExplain:n}=t,s=(0,W.wW)(Fa);return e.createElement("div",{className:s.card},e.createElement("div",{className:s.header},e.createElement("div",{className:s.name},"Operator"),e.createElement(O.Ph,{width:"auto",options:Da,value:(0,de.E)(a.operator),onChange:v=>{o(l,{...a,operator:v.value})}}),e.createElement("div",{className:s.name},"Vector matches"),e.createElement("div",{className:s.vectorMatchWrapper},e.createElement(O.Ph,{width:"auto",value:a.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:v=>{o(l,{...a,vectorMatchesType:v.value})}}),e.createElement(Fe.H,{className:s.vectorMatchInput,minWidth:20,defaultValue:a.vectorMatches,onCommitChange:v=>{o(l,{...a,vectorMatches:v.currentTarget.value,vectorMatchesType:a.vectorMatchesType||"on"})}})),e.createElement(N.FlexItem,{grow:1}),e.createElement(it.h,{name:"times",size:"sm",onClick:()=>i(l)})),e.createElement("div",{className:s.body},e.createElement(N.EditorRows,null,e.createElement(Ae,{showExplain:n,query:a.query,datasource:r,onRunQuery:p,onChange:v=>{o(l,{...a,query:v})}}))))}),Da=Pa.iQ.map(t=>({label:t.sign,value:t.sign}));ot.displayName="NestedQuery";const Fa=t=>({card:(0,g.css)({label:"card",display:"flex",flexDirection:"column",gap:t.spacing(.5)}),header:(0,g.css)({label:"header",padding:t.spacing(.5,.5,.5,1),gap:t.spacing(1),display:"flex",alignItems:"center"}),name:(0,g.css)({label:"name",whiteSpace:"nowrap"}),body:(0,g.css)({label:"body",paddingLeft:t.spacing(2)}),vectorMatchInput:(0,g.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,g.css)({label:"vectorMatchWrapper",display:"flex"})});function Aa(t){const{query:a,datasource:l,onChange:r,onRunQuery:o,showExplain:i}=t,p=a.binaryQueries??[],n=(v,h)=>{const b=[...p];b.splice(v,1,h),r({...a,binaryQueries:b})},s=v=>{const h=[...p.slice(0,v),...p.slice(v+1)];r({...a,binaryQueries:h})};return e.createElement(N.Stack,{direction:"column",gap:1},p.map((v,h)=>e.createElement(ot,{key:h.toString(),nestedQuery:v,index:h,onChange:n,datasource:l,onRemove:s,onRunQuery:o,showExplain:i})))}var Ia=m(37285);const Ae=e.memo(t=>{const{datasource:a,query:l,onChange:r,onRunQuery:o,data:i,showExplain:p}=t,[n,s]=(0,e.useState)(),v=c=>{r({...l,labels:c})},h=(0,e.useCallback)(async c=>{const C=a.getVariables(),T=await c;return[...C.map(A=>({label:A,value:A})),...T.map(A=>({label:A.value,value:A.value,title:A.description}))]},[a]),b=async c=>{if(!l.metric)return await a.languageProvider.fetchLabels(),a.languageProvider.getLabelKeys().map($=>({value:$}));const C=l.labels.filter($=>$!==c);C.push({label:"__name__",op:"=",value:l.metric});const T=M.Z.renderLabels(C);let A;return a.hasLabelsMatchAPISupport()?A=await a.languageProvider.fetchSeriesLabelsMatch(T):A=await a.languageProvider.fetchSeriesLabels(T),Object.keys(A).filter($=>!C.find(ie=>ie.label===$)).map($=>({value:$}))},w=(c,C)=>{const T={label:C??"__name__",op:"=~",value:(0,Te.Vl)(`.*${c}`)},A=l.labels.filter(j=>j.label!==T.label);A.push(T),l.metric&&A.push({label:"__name__",op:"=",value:l.metric});const $=A.map(j=>({...j,label:a.interpolateString(j.label),value:a.interpolateString(j.value)})),ie=M.Z.renderLabels($);let re;return a.hasLabelsMatchAPISupport()?re=S(T,ie):re=x(T,ie),re.then(j=>(j.length>le&&j.splice(0,j.length-le),j))},x=(c,C)=>{if(!c.label)return Promise.resolve([]);const T=a.languageProvider.fetchSeries(C),A=a.interpolateString(c.label);return T.then($=>{const ie=new Set;return $.forEach(re=>{const j=re[A];ie.add(j)}),Array.from(ie).map(re=>({label:re,value:re}))})},S=(c,C)=>c.label?a.languageProvider.fetchSeriesValuesWithMatch(c.label,C).then(T=>T.map(A=>({value:A,label:A}))):Promise.resolve([]),X=async c=>{if(!c.label)return[];if(!l.metric)return(await a.languageProvider.getLabelValues(c.label)).map($=>({value:$}));const C=l.labels.filter($=>$!==c);C.push({label:"__name__",op:"=",value:l.metric});const T=C.map($=>({...$,label:a.interpolateString($.label),value:a.interpolateString($.value)})),A=M.Z.renderLabels(T);return a.hasLabelsMatchAPISupport()?S(c,A):x(c,A)},f=(0,e.useCallback)(()=>h(za(a,l)),[a,l,h]),E={grammar:I.ZP,name:"promql"},d=a.getInitHints();return e.createElement(e.Fragment,null,e.createElement(N.EditorRow,null,e.createElement(xa,{query:l,onChange:r,onGetMetrics:f,datasource:a,labelsFilters:l.labels,metricLookupDisabled:a.lookupsDisabled}),e.createElement(Na,{debounceDuration:a.getDebounceTimeInMilliseconds(),getLabelValuesAutofillSuggestions:w,labelsFilters:l.labels,onChange:v,onGetLabelNames:c=>h(b(c)),onGetLabelValues:c=>h(X(c))})),d.length?e.createElement("div",{className:"query-row-break"},e.createElement("div",{className:"prom-query-field-info text-warning"},d[0].label," ",d[0].fix?e.createElement("button",{type:"button",className:"text-warning"},d[0].fix.label):null)):null,p&&e.createElement(Qt.B,{stepNumber:1,title:e.createElement(D.U,{query:`${l.metric} ${M.Z.renderLabels(l.labels)}`,lang:E})},Ia.A),e.createElement(Rt.B,null,e.createElement(Lt.P,{queryModeller:M.Z,datasource:a,query:l,onChange:r,onRunQuery:o,highlightedOp:n}),e.createElement(Bt.L,{datasource:a,query:l,onChange:r,data:i,queryModeller:M.Z,buildVisualQueryFromString:z._})),p&&e.createElement($t.V,{lang:E,query:l,stepNumber:2,queryModeller:M.Z,onMouseEnter:c=>s(c),onMouseLeave:()=>s(void 0)}),l.binaryQueries&&l.binaryQueries.length>0&&e.createElement(Aa,{query:l,datasource:a,onChange:r,onRunQuery:o,showExplain:p}))});async function za(t,a){t.languageProvider.metricsMetadata||await t.languageProvider.loadMetricsMetadata(),t.languageProvider.metricsMetadata||(t.languageProvider.metricsMetadata={});let l;if(a.labels.length>0){const r=M.Z.renderLabels(a.labels);l=(await t.languageProvider.getSeries(r,!0)).__name__??[]}else l=await t.languageProvider.getLabelValues("__name__")??[];return l.map(r=>({value:r,description:(0,we.UQ)(r,t.languageProvider.metricsMetadata)}))}Ae.displayName="PromQueryBuilder";function Qa({query:t}){return t?e.createElement(N.EditorRow,null,e.createElement(N.EditorFieldGroup,null,e.createElement(D.U,{query:t,lang:{grammar:I.ZP,name:"promql"}}))):null}const Ie=J.v.featureToggles.prometheusMetricEncyclopedia;function La(t){const{query:a,onChange:l,onRunQuery:r,datasource:o,data:i,showExplain:p}=t,[n,s]=(0,e.useReducer)(ct.reducer,{expr:a.expr});(0,e.useEffect)(()=>{s(Ra(a.expr)),Ie&&s(Ba({useBackend:a.useBackend??!1,disableTextWrap:a.disableTextWrap??!1,fullMetaSearch:a.fullMetaSearch??!1,excludeNullMetadata:a.excludeNullMetadata??!1}))},[a]);const v=h=>{const b=M.Z.renderQuery(h);if(s($a({visQuery:h,expr:b})),Ie){const w=qt(h);l({...t.query,expr:b,...w})}else l({...t.query,expr:b})};return n.visQuery?e.createElement(e.Fragment,null,e.createElement(Ae,{query:n.visQuery,datasource:o,onChange:v,onRunQuery:r,data:i,showExplain:p}),e.createElement(Qa,{query:a.expr})):null}const ct=(0,Ue.oM)({name:"prom-builder-container",initialState:{expr:""},reducers:{visualQueryChange:(t,a)=>{t.expr=a.payload.expr,t.visQuery=a.payload.visQuery},exprChanged:(t,a)=>{if(!t.visQuery||t.expr!==a.payload){t.expr=a.payload;const l=(0,z._)(a.payload??"");t.visQuery=l.query}},setMetricsModalSettings:(t,a)=>{t.visQuery&&Ie&&(t.visQuery.useBackend=a.payload.useBackend,t.visQuery.disableTextWrap=a.payload.disableTextWrap,t.visQuery.fullMetaSearch=a.payload.fullMetaSearch,t.visQuery.excludeNullMetadata=a.payload.excludeNullMetadata)}}}),{visualQueryChange:$a,exprChanged:Ra,setMetricsModalSettings:Ba}=ct.actions;var ut=m(2594),dt=m(82965),Y=m(19426),Xa=m(77117),Va=m(61860);function Wa({datasource:t,onChange:a,query:l,...r}){const[o,i]=(0,e.useState)(null),p=(0,W.wW)(Oa),n=(0,dt.Z)(o);(0,e.useEffect)(()=>{t.exemplarsAvailable?l.instant&&!l.range?(i("Exemplars are not available for instant queries"),a(!1)):(i(null),n&&!o&&a(!0)):(i("Exemplars for this query are not available"),a(!1))},[t.exemplarsAvailable,l.instant,l.range,a,n,o]);const s=(0,g.cx)({[p.activeIcon]:!!l.exemplar},p.eyeIcon);return e.createElement(Xa.W,{width:"auto","data-testid":r["data-testid"]},e.createElement(Va.u,{content:o??""},e.createElement("div",{className:p.iconWrapper},"Exemplars",e.createElement(it.h,{name:"eye",tooltip:l.exemplar?"Disable query with exemplars":"Enable query with exemplars",disabled:!!o,className:s,onClick:()=>{a(!l.exemplar)}}))))}function Oa(t){return{eyeIcon:g.css`
      margin-left: ${t.spacing(2)};
    `,activeIcon:g.css`
      color: ${t.colors.primary.main};
    `,iconWrapper:g.css`
      display: flex;
      align-items: center;
    `}}const Ha=(0,e.memo)(({query:t,datasource:a,onChange:l,onRunQuery:r})=>{const o=mt(!0),i=(0,dt.Z)(t),p=(0,e.useCallback)(b=>{(!(0,Z.isEqual)(t,i)||b!==t.exemplar)&&l({...t,exemplar:b})},[i,t,l]);function n(b){l({...t,interval:b})}function s(b){b.currentTarget.value!==t.interval&&n(b.currentTarget.value)}function v(b){b.key==="Enter"&&b.shiftKey&&r()}const h=pt(t,l);return e.createElement("div",{"aria-label":"Prometheus extra field",className:"gf-form-inline","data-testid":ze.extraFieldEditor},e.createElement("div",{"data-testid":ze.queryTypeField,className:(0,g.cx)("gf-form explore-input-margin",g.css`
            flex-wrap: nowrap;
          `),"aria-label":"Query type field"},e.createElement(Y.c,{width:"auto"},"Query type"),e.createElement(ut.S,{options:o,value:t.range&&t.instant?"both":t.instant?"instant":"range",onChange:h})),e.createElement("div",{"data-testid":ze.stepField,className:(0,g.cx)("gf-form",g.css`
            flex-wrap: nowrap;
          `),"aria-label":"Step field"},e.createElement(Y.c,{width:6,tooltip:"Time units and built-in variables can be used here, for example: $__interval, $__rate_interval, 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: s)"},"Min step"),e.createElement("input",{type:"text",className:"gf-form-input width-4",placeholder:"auto",onChange:s,onKeyDown:v,value:t.interval??""})),e.createElement(Wa,{onChange:p,datasource:a,query:t}))});Ha.displayName="PromExploreExtraField";function mt(t){const a=[{value:"range",label:"Range",description:"Run query over a range of time"},{value:"instant",label:"Instant",description:'Run query against a single point in time. For this query, the "To" time is used'}];return t&&a.push({value:"both",label:"Both",description:"Run an Instant query and a Range query"}),a}function pt(t,a){return l=>{a(l==="instant"?{...t,instant:!0,range:!1,exemplar:!1}:l==="range"?{...t,instant:!1,range:!0}:{...t,instant:!0,range:!0})}}const ze={extraFieldEditor:"prom-editor-extra-field",stepField:"prom-editor-extra-field-step",queryTypeField:"prom-editor-extra-field-query-type"};var ja=m(38435);const Qe=[{label:"Auto",value:Q.pD.Auto,description:"Only includes unique labels"},{label:"Verbose",value:Q.pD.Verbose,description:"All label names and values"},{label:"Custom",value:Q.pD.Custom,description:"Provide a naming template"}],ht=e.memo(({legendFormat:t,onChange:a,onRunQuery:l})=>{const r=gt(t),o=(0,e.useRef)(null),i=n=>{let s=n.currentTarget.value;s.length===0&&(s=Q.pD.Auto),s!==t&&(a(s),l())},p=n=>{switch(n.value){case Q.pD.Auto:a(Q.pD.Auto);break;case Q.pD.Custom:a("{{label_name}}"),setTimeout(()=>{o.current?.focus(),o.current?.setSelectionRange(2,12,"forward")},10);break;case Q.pD.Verbose:a("");break}l()};return e.createElement(N.EditorField,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname."},e.createElement(e.Fragment,null,r===Q.pD.Custom&&e.createElement(Fe.H,{id:"legendFormat",minWidth:22,placeholder:"auto",defaultValue:t,onCommitChange:i,ref:o}),r!==Q.pD.Custom&&e.createElement(O.Ph,{inputId:"legend.mode",isSearchable:!1,placeholder:"Select legend mode",options:Qe,width:22,onChange:p,value:Qe.find(n=>n.value===r)})))});ht.displayName="PromQueryLegendEditor";function gt(t){return t===Q.pD.Auto?Q.pD.Auto:t==null||t===""?Q.pD.Verbose:Q.pD.Custom}function ka(t){const a=gt(t);return a!==Q.pD.Custom?Qe.find(l=>l.value===a)?.label:t}const ft=e.memo(({query:t,app:a,onChange:l,onRunQuery:r})=>{const o=x=>{l({...t,format:x.value}),r()},i=x=>{l({...t,interval:x.currentTarget.value}),r()},p=mt(a===u.zj.Explore||a===u.zj.PanelEditor),n=pt(t,l),s=x=>{const S=x.currentTarget.checked;l({...t,exemplar:S}),r()},v=x=>{l({...t,intervalFactor:x.value}),r()},h=Le.find(x=>x.value===t.format)||Le[0],b=Ua(t),w=p.find(x=>x.value===b).label;return e.createElement(N.EditorRow,null,e.createElement(ja.d,{title:"Options",collapsedInfo:Ga(t,h.label,w,a)},e.createElement(ht,{legendFormat:t.legendFormat,onChange:x=>l({...t,legendFormat:x}),onRunQuery:r}),e.createElement(N.EditorField,{label:"Min step",tooltip:e.createElement(e.Fragment,null,"An additional lower limit for the step parameter of the Prometheus query and for the"," ",e.createElement("code",null,"$__interval")," and ",e.createElement("code",null,"$__rate_interval")," variables.")},e.createElement(Fe.H,{type:"text","aria-label":"Set lower limit for the step parameter",placeholder:"auto",minWidth:10,onCommitChange:i,defaultValue:t.interval})),e.createElement(N.EditorField,{label:"Format"},e.createElement(O.Ph,{value:h,allowCustomValue:!0,onChange:o,options:Le})),e.createElement(N.EditorField,{label:"Type"},e.createElement(ut.S,{options:p,value:b,onChange:n})),vt(t,a)&&e.createElement(N.EditorField,{label:"Exemplars"},e.createElement(N.EditorSwitch,{value:t.exemplar||!1,onChange:s})),t.intervalFactor&&t.intervalFactor>1&&e.createElement(N.EditorField,{label:"Resolution"},e.createElement(O.Ph,{"aria-label":"Select resolution",isSearchable:!1,options:yt,onChange:v,value:yt.find(x=>x.value===t.intervalFactor)}))))});function vt(t,a){return!(a===u.zj.UnifiedAlerting||!t.range)}function Ua(t){return t.range&&t.instant?"both":t.instant?"instant":"range"}function Ga(t,a,l,r){const o=[];return o.push(`Legend: ${ka(t.legendFormat)}`),o.push(`Format: ${a}`),o.push(`Step: ${t.interval??"auto"}`),o.push(`Type: ${l}`),vt(t,r)&&(t.exemplar?o.push("Exemplars: true"):o.push("Exemplars: false")),o}ft.displayName="PromQueryBuilderOptions";var Za=m(79969);const Le=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Heatmap",value:"heatmap"}],yt=(0,Z.map)([1,2,3,4,5,10],t=>({value:t,label:"1/"+t})),bt=e.memo(t=>{const{onChange:a,onRunQuery:l,data:r,app:o,onAddQuery:i,datasource:{defaultEditor:p},queries:n}=t,[s,v]=(0,e.useState)(!1),[h,b]=(0,e.useState)(!1),[w,x]=(0,e.useState)(!1),{flag:S,setFlag:X}=(0,Oe.P5)(Oe.ar),f=zt(t.query,o,p),E=f.editorMode,d=(0,e.useCallback)(T=>{if((0,ue.ff)("user_grafana_prometheus_editor_mode_clicked",{newEditor:T,previousEditor:f.editorMode??"",newQuery:!f.expr,app:o??""}),T===k.c.Builder&&(0,z._)(f.expr||"").errors.length){v(!0);return}ke(f,T,a)},[a,f,o]);(0,e.useEffect)(()=>{x(!1)},[r]);const c=T=>{(0,Z.isEqual)(T,t.query)||x(!0),a(T)},C=T=>{X(T.currentTarget.checked)};return e.createElement(e.Fragment,null,e.createElement(Se.s,{isOpen:s,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.",confirmText:"Continue",onConfirm:()=>{ke(f,k.c.Builder,a),v(!1)},onDismiss:()=>v(!1)}),e.createElement(Me,{isOpen:h,onClose:()=>b(!1),query:f,queries:n,app:o,onChange:a,onAddQuery:i}),e.createElement(N.EditorHeader,null,e.createElement(V.zx,{"aria-label":te.wl.components.QueryBuilder.queryPatterns,variant:"secondary",size:"sm",onClick:()=>b(T=>!T)},"Kick start your query"),e.createElement(At.n,{label:"Explain",value:S,onChange:C}),e.createElement(N.FlexItem,{grow:1}),o!==u.zj.Explore&&o!==u.zj.Correlations&&e.createElement(V.zx,{variant:w?"primary":"secondary",size:"sm",onClick:l,icon:r?.state===he.Gu.Loading?"fa fa-spinner":void 0,disabled:r?.state===he.Gu.Loading},"Run queries"),e.createElement(Ft.k,{mode:E,onChange:d})),e.createElement(N.Space,{v:.5}),e.createElement(N.EditorRows,null,E===k.c.Code&&e.createElement(Za.j,{...t,query:f,showExplain:S,onChange:c}),E===k.c.Builder&&e.createElement(La,{query:f,datasource:t.datasource,onChange:c,onRunQuery:t.onRunQuery,data:r,showExplain:S}),e.createElement(ft,{query:f,app:t.app,onChange:a,onRunQuery:l})))});bt.displayName="PromQueryEditorSelector";var Ka=m(362);function Ja(t){const{datasource:a,query:l,range:r,data:o,onChange:i,onRunQuery:p}=t;return e.createElement(Ka.ZP,{datasource:a,query:l,onRunQuery:p,onChange:i,history:[],range:r,data:o,"data-testid":qa.editor})}const qa={editor:"prom-editor-cloud-alerting"};function Ya(t){const{app:a}=t;switch(a){case u.zj.CloudAlerting:return e.createElement(Ja,{...t});default:return e.createElement(bt,{...t})}}const _a=(0,e.memo)(Ya);var el=m(4761),tl=m(45253),al=m(12006),ll=m(57227),ve=m(47694);function nl({options:t,onOptionsChange:a}){const l=(0,W.l4)(),r=pe(l);return e.createElement(e.Fragment,null,e.createElement("h3",{className:"page-heading"},"Alerting"),e.createElement("div",{className:"gf-form-group"},e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(L._,{labelWidth:30,label:"Manage alerts via Alerting UI",disabled:t.readOnly,tooltip:e.createElement(e.Fragment,null,"Manage alert rules for this data source. To manage other alerting resources, add an Alertmanager data source. ",H()),interactive:!0,className:r.switchField},e.createElement(q.r,{value:t.jsonData.manageAlerts!==!1,onChange:o=>a({...t,jsonData:{...t.jsonData,manageAlerts:o.currentTarget.checked}})}))))))}var Et=m(11543),xt=(t=>(t.Public="AzureCloud",t.China="AzureChinaCloud",t.USGovernment="AzureUSGovernment",t.None="",t))(xt||{});const rl=[{value:"AzureCloud",label:"Azure"},{value:"AzureChinaCloud",label:"Azure China"},{value:"AzureUSGovernment",label:"Azure US Government"}];function sl(t){switch(t.authType){case"msi":return!0;case"clientsecret":return!!(t.azureCloud&&t.tenantId&&t.clientId&&t.clientSecret)}}const il=Symbol("Concealed client secret");function ye(){return J.v.azure.cloud||xt.Public}function ol(t){if(t.secureJsonFields.azureClientSecret)return il;{const a=t.secureJsonData?.azureClientSecret;return typeof a=="string"&&a.length>0?a:void 0}}function cl(t){return!!t.jsonData.azureCredentials}function St(){return J.v.azure.managedIdentityEnabled?{authType:"msi"}:{authType:"clientsecret",azureCloud:ye()}}function ul(t){const a=t.jsonData.azureCredentials;if(!a)return St();switch(a.authType){case"msi":return J.v.azure.managedIdentityEnabled?{authType:"msi"}:{authType:"clientsecret",azureCloud:ye()};case"clientsecret":return{authType:"clientsecret",azureCloud:a.azureCloud||ye(),tenantId:a.tenantId,clientId:a.clientId,clientSecret:ol(t)}}}function dl(t,a){switch(a.authType){case"msi":if(!J.v.azure.managedIdentityEnabled)throw new Error("Managed Identity authentication is not enabled in Grafana config.");return t={...t,jsonData:{...t.jsonData,azureCredentials:{authType:"msi"}}},t;case"clientsecret":return t={...t,jsonData:{...t.jsonData,azureCredentials:{authType:"clientsecret",azureCloud:a.azureCloud||ye(),tenantId:a.tenantId,clientId:a.clientId}},secureJsonData:{...t.secureJsonData,azureClientSecret:typeof a.clientSecret=="string"&&a.clientSecret.length>0?a.clientSecret:void 0},secureJsonFields:{...t.secureJsonFields,azureClientSecret:typeof a.clientSecret=="symbol"}},t}}function ml(t){return{jsonData:{...t.jsonData,azureCredentials:St()}}}function pl(t){return{jsonData:{...t.jsonData,azureAuth:void 0,azureCredentials:void 0,azureEndpointResourceId:void 0}}}var be=m(50869),$e=m(29418);const Ct=[{value:"msi",label:"Managed Identity"},{value:"clientsecret",label:"App Registration"}],hl=t=>{const{credentials:a,azureCloudOptions:l,onCredentialsChange:r,getSubscriptions:o,disabled:i}=t,p=sl(a),[n,s]=(0,e.useState)([]),[v,h]=(0,e.useReducer)(c=>c+1,0);(0,e.useEffect)(()=>{if(!o||!p){b([]);return}let c=!1;return o().then(C=>{c||b(C,v)}),()=>{c=!0}},[v]);const b=(c,C=!1)=>{s(c),o&&(C&&!a.defaultSubscriptionId&&c.length>0?d(c[0]):a.defaultSubscriptionId&&(c.find(A=>A.value===a.defaultSubscriptionId)||d(void 0)))},w=c=>{if(r){s([]);const C={...a,authType:c.value||"msi",defaultSubscriptionId:void 0};r(C)}},x=c=>{if(r&&a.authType==="clientsecret"){s([]);const C={...a,azureCloud:c.value,defaultSubscriptionId:void 0};r(C)}},S=c=>{if(r&&a.authType==="clientsecret"){s([]);const C={...a,tenantId:c.target.value,defaultSubscriptionId:void 0};r(C)}},X=c=>{if(r&&a.authType==="clientsecret"){s([]);const C={...a,clientId:c.target.value,defaultSubscriptionId:void 0};r(C)}},f=c=>{if(r&&a.authType==="clientsecret"){s([]);const C={...a,clientSecret:c.target.value,defaultSubscriptionId:void 0};r(C)}},E=()=>{if(r&&a.authType==="clientsecret"){s([]);const c={...a,clientSecret:"",defaultSubscriptionId:void 0};r(c)}},d=c=>{if(r){const C={...a,defaultSubscriptionId:c?.value};r(C)}};return e.createElement("div",{className:"gf-form-group"},t.managedIdentityEnabled&&e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{className:"width-12",tooltip:"Choose the type of authentication to Azure services"},"Authentication"),e.createElement($e.Ph,{className:"width-15",value:Ct.find(c=>c.value===a.authType),options:Ct,onChange:w,isDisabled:i}))),a.authType==="clientsecret"&&e.createElement(e.Fragment,null,l&&e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{className:"width-12",tooltip:"Choose an Azure Cloud"},"Azure Cloud"),e.createElement($e.Ph,{className:"width-15",value:l.find(c=>c.value===a.azureCloud),options:l,onChange:x,isDisabled:i}))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{className:"width-12"},"Directory (tenant) ID"),e.createElement("div",{className:"width-15"},e.createElement(be.I,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:a.tenantId||"",onChange:S,disabled:i})))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{className:"width-12"},"Application (client) ID"),e.createElement("div",{className:"width-15"},e.createElement(be.I,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:a.clientId||"",onChange:X,disabled:i})))),typeof a.clientSecret=="symbol"?e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{htmlFor:"azure-client-secret",className:"width-12"},"Client Secret"),e.createElement(be.I,{id:"azure-client-secret",className:"width-25",placeholder:"configured",disabled:!0})),!i&&e.createElement("div",{className:"gf-form"},e.createElement("div",{className:"max-width-30 gf-form-inline"},e.createElement(V.zx,{variant:"secondary",type:"button",onClick:E},"reset")))):e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{className:"width-12"},"Client Secret"),e.createElement("div",{className:"width-15"},e.createElement(be.I,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:a.clientSecret||"",onChange:f,disabled:i}))))),o&&e.createElement(e.Fragment,null,e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(Y.c,{className:"width-12"},"Default Subscription"),e.createElement("div",{className:"width-25"},e.createElement($e.Ph,{value:a.defaultSubscriptionId?n.find(c=>c.value===a.defaultSubscriptionId):void 0,options:n,onChange:d,isDisabled:i})))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement("div",{className:"max-width-30 gf-form-inline"},e.createElement(V.zx,{variant:"secondary",size:"sm",type:"button",onClick:h,disabled:!p},"Load Subscriptions"))))))},Al=null,gl=t=>{const{dataSourceConfig:a,onChange:l}=t,[r]=(0,e.useState)(J.v.featureToggles.prometheusAzureOverrideAudience||!!a.jsonData.azureEndpointResourceId),[o,i]=(0,e.useState)(!!a.jsonData.azureEndpointResourceId),p=(0,e.useMemo)(()=>ul(a),[a]),n=h=>{l(dl(a,h))},s=h=>{i(h.currentTarget.checked),h.currentTarget.checked||l({...a,jsonData:{...a.jsonData,azureEndpointResourceId:void 0}})},v=h=>{o&&l({...a,jsonData:{...a.jsonData,azureEndpointResourceId:h.currentTarget.value}})};return e.createElement(e.Fragment,null,e.createElement("h6",null,"Azure authentication"),e.createElement(hl,{managedIdentityEnabled:J.v.azure.managedIdentityEnabled,credentials:p,azureCloudOptions:rl,onCredentialsChange:n,disabled:a.readOnly}),r&&e.createElement(e.Fragment,null,e.createElement("h6",null,"Azure configuration"),e.createElement("div",{className:"gf-form-group"},e.createElement(Et.Z,null,e.createElement(L._,{labelWidth:26,label:"Override AAD audience",disabled:a.readOnly},e.createElement(q.x,{value:o,onChange:s}))),o&&e.createElement(Et.Z,null,e.createElement(L._,{labelWidth:26,label:"Resource ID",disabled:a.readOnly},e.createElement(G.I,{className:"width-30",value:a.jsonData.azureEndpointResourceId||"",onChange:v}))))))},Il=null;var fl=m(72097),Re=m.n(fl),Be=m(73446),vl=m(54899),yl=m(25e3),ne=m(46063),bl=m(24509),El=m(53117);function xl({value:t,onChange:a,onDelete:l,disabled:r}){const[o,i]=(0,e.useState)(Boolean(t.datasourceUid)),p=(0,W.l4)(),n=pe(p);return e.createElement("div",{className:"gf-form-group"},e.createElement(L._,{label:"Internal link",labelWidth:B,disabled:r,tooltip:e.createElement(e.Fragment,null,"Enable this option if you have an internal link. When enabled, this reveals the data source selector. Select the backend tracing data store for your exemplar data. ",H()),interactive:!0,className:n.switchField},e.createElement(e.Fragment,null,e.createElement(q.r,{value:o,"aria-label":te.wl.components.DataSource.Prometheus.configPage.internalLinkSwitch,onChange:s=>i(s.currentTarget.checked)}))),o?e.createElement(L._,{label:"Data source",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"The data source the exemplar is going to navigate to. ",H()),disabled:r,interactive:!0},e.createElement(El.q,{tracing:!0,current:t.datasourceUid,noDefault:!0,width:40,onChange:s=>a({...t,datasourceUid:s.uid,url:void 0})})):e.createElement(L._,{label:"URL",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"The URL of the trace backend the user would go to see its trace. ",H()),disabled:r,interactive:!0},e.createElement(G.I,{placeholder:"https://example.com/${__value.raw}",spellCheck:!1,width:40,value:t.url,onChange:s=>a({...t,datasourceUid:void 0,url:s.currentTarget.value})})),e.createElement(L._,{label:"URL Label",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Use to override the button label on the exemplar traceID field. ",H()),disabled:r,interactive:!0},e.createElement(G.I,{placeholder:"Go to example.com",spellCheck:!1,width:40,value:t.urlDisplayLabel,onChange:s=>a({...t,urlDisplayLabel:s.currentTarget.value})})),e.createElement(L._,{label:"Label name",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"The name of the field in the labels object that should be used to get the traceID. ",H()),disabled:r,interactive:!0},e.createElement(G.I,{placeholder:"traceID",spellCheck:!1,width:40,value:t.name,onChange:s=>a({...t,name:s.currentTarget.value})})),!r&&e.createElement(L._,{label:"Remove exemplar link",labelWidth:B,disabled:r},e.createElement(V.zx,{variant:"destructive",title:"Remove exemplar link",icon:"times",onClick:s=>{s.preventDefault(),l()}})))}function Sl({options:t,onChange:a,disabled:l}){const r=(0,W.l4)(),o=pe(r);return e.createElement("div",{className:o.sectionBottomPadding},e.createElement("h3",{className:"page-heading"},"Exemplars"),t&&t.map((i,p)=>e.createElement(xl,{key:p,value:i,onChange:n=>{const s=[...t];s.splice(p,1,n),a(s)},onDelete:()=>{const n=[...t];n.splice(p,1),a(n)},disabled:l})),!l&&e.createElement(V.zx,{variant:"secondary","aria-label":te.wl.components.DataSource.Prometheus.configPage.exemplarsAddButton,className:g.css`
            margin-bottom: 10px;
          `,icon:"plus",onClick:i=>{i.preventDefault();const p=[...t||[],{name:"traceID"}];a(p)}},"Add"),l&&!t&&e.createElement("i",null,"No exemplars configurations"))}const Ee={Prometheus:[{value:void 0,label:"Please select"},{value:"2.0.0",label:"< 2.14.x"},{value:"2.14.0",label:"2.14.x"},{value:"2.15.0",label:"2.15.x"},{value:"2.16.0",label:"2.16.x"},{value:"2.17.0",label:"2.17.x"},{value:"2.18.0",label:"2.18.x"},{value:"2.19.0",label:"2.19.x"},{value:"2.20.0",label:"2.20.x"},{value:"2.21.0",label:"2.21.x"},{value:"2.22.0",label:"2.22.x"},{value:"2.23.0",label:"2.23.x"},{value:"2.24.0",label:"2.24.x"},{value:"2.25.0",label:"2.25.x"},{value:"2.26.0",label:"2.26.x"},{value:"2.27.0",label:"2.27.x"},{value:"2.28.0",label:"2.28.x"},{value:"2.29.0",label:"2.29.x"},{value:"2.30.0",label:"2.30.x"},{value:"2.31.0",label:"2.31.x"},{value:"2.32.0",label:"2.32.x"},{value:"2.33.0",label:"2.33.x"},{value:"2.34.0",label:"2.34.x"},{value:"2.35.0",label:"2.35.x"},{value:"2.36.0",label:"2.36.x"},{value:"2.37.0",label:"2.37.x"},{value:"2.38.0",label:"2.38.x"},{value:"2.39.0",label:"2.39.x"},{value:"2.40.0",label:"2.40.x"},{value:"2.40.1",label:"> 2.40.x"}],Mimir:[{value:void 0,label:"Please select"},{value:"2.0.0",label:"2.0.x"},{value:"2.1.0",label:"2.1.x"},{value:"2.2.0",label:"2.2.x"},{value:"2.3.0",label:"2.3.x"},{value:"2.4.0",label:"> 2.3.x"}],Thanos:[{value:void 0,label:"Please select"},{value:"0.0.0",label:"< 0.16.x"},{value:"0.16.0",label:"0.16.x"},{value:"0.17.0",label:"0.17.x"},{value:"0.18.0",label:"0.18.x"},{value:"0.19.0",label:"0.19.x"},{value:"0.20.0",label:"0.20.x"},{value:"0.21.0",label:"0.21.x"},{value:"0.22.0",label:"0.22.x"},{value:"0.23.0",label:"0.23.x"},{value:"0.24.0",label:"0.24.x"},{value:"0.25.0",label:"0.25.x"},{value:"0.26.0",label:"0.26.x"},{value:"0.27.0",label:"0.27.x"},{value:"0.28.0",label:"0.28.x"},{value:"0.29.0",label:"> 0.28.x"}],Cortex:[{value:void 0,label:"Please select"},{value:"0.0.0",label:"< 1.0.0"},{value:"1.0.0",label:"1.0.0"},{value:"1.1.0",label:"1.1.x"},{value:"1.2.0",label:"1.2.x"},{value:"1.3.0",label:"1.3.x"},{value:"1.4.0",label:"1.4.x"},{value:"1.5.0",label:"1.5.x"},{value:"1.6.0",label:"1.6.x"},{value:"1.7.0",label:"1.7.x"},{value:"1.8.0",label:"1.8.x"},{value:"1.9.0",label:"1.9.x"},{value:"1.10.0",label:"1.10.x"},{value:"1.11.0",label:"1.11.x"},{value:"1.13.0",label:"1.13.x"},{value:"1.14.0",label:"> 1.13.x"}]},Mt=[{value:"POST",label:"POST"},{value:"GET",label:"GET"}],Xe=[{value:k.c.Builder,label:"Builder"},{value:k.c.Code,label:"Code"}],wt=[{value:Q.x3.Low,label:"Low"},{value:Q.x3.Medium,label:"Medium"},{value:Q.x3.High,label:"High"},{value:Q.x3.None,label:"None"}],Tt=[{value:ne.T8.Prometheus,label:ne.T8.Prometheus},{value:ne.T8.Cortex,label:ne.T8.Cortex},{value:ne.T8.Mimir,label:ne.T8.Mimir},{value:ne.T8.Thanos,label:ne.T8.Thanos}],Nt=/^$|^\d+(ms|[Mwdhmsy])$/,Cl=/(\d+)(.+)/,Ve="Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",Ml=(t,a)=>{if(!a||!Ee[a])return;const r=Ee[a]?.filter(i=>!!i.value&&Re().lte(i.value,t)).map(i=>i.value),o=r[r.length-1];if(o){const i=Re().diff(o,t);if(["patch","prepatch","prerelease",null].includes(i))return o}},Pt=t=>{console.warn("Error fetching version from buildinfo API, must manually select version!",t)},wl=(t,a,l)=>{l(t).then(r=>{(0,vl.i)().get(`/api/datasources/uid/${r.uid}/resources/version-detect`).then(o=>{const i=o.data?.version??"";if(i&&Re().valid(i)){const p=Ml(i,r.jsonData.prometheusType);p&&l({...r,jsonData:{...r.jsonData,prometheusVersion:p}}).then(n=>{a(n)})}else Pt()})}).catch(r=>{Pt(r)})},Tl=t=>{const{options:a,onOptionsChange:l}=t,r=(0,yl.qj)();a.jsonData.httpMethod||(a.jsonData.httpMethod="POST");const o=(0,W.l4)(),i=pe(o),[p,n]=(0,e.useState)({timeInterval:"",queryTimeout:"",incrementalQueryOverlapWindow:""});return e.createElement(e.Fragment,null,e.createElement("h3",{className:"page-heading"},"Interval behaviour"),e.createElement("div",{className:"gf-form-group"},e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(L._,{label:"Scrape interval",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"This interval is how frequently Prometheus scrapes targets. Set this to the typical scrape and evaluation interval configured in your Prometheus config file. If you set this to a greater value than your Prometheus config file interval, Grafana will evaluate the data according to this interval and you will see less data points. Defaults to 15s. ",H()),interactive:!0,disabled:a.readOnly},e.createElement(e.Fragment,null,e.createElement(G.I,{className:"width-20",value:a.jsonData.timeInterval,spellCheck:!1,placeholder:"15s",onChange:_("timeInterval",a,l),onBlur:s=>n({...p,timeInterval:s.currentTarget.value})}),We(p.timeInterval,Nt,Ve))))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(L._,{label:"Query timeout",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Set the Prometheus query timeout. ",H()),interactive:!0,disabled:a.readOnly},e.createElement(e.Fragment,null,e.createElement(G.I,{className:"width-20",value:a.jsonData.queryTimeout,onChange:_("queryTimeout",a,l),spellCheck:!1,placeholder:"60s",onBlur:s=>n({...p,queryTimeout:s.currentTarget.value})}),We(p.queryTimeout,Nt,Ve)))))),e.createElement("h3",{className:"page-heading"},"Query editor"),e.createElement("div",{className:"gf-form-group"},e.createElement("div",{className:"gf-form"},e.createElement(L._,{label:"Default editor",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Set default editor option for all users of this data source. ",H()),interactive:!0,disabled:a.readOnly},e.createElement(O.Ph,{"aria-label":"Default Editor (Code or Builder)",options:Xe,value:Xe.find(s=>s.value===a.jsonData.defaultEditor)??Xe.find(s=>s.value===k.c.Builder),onChange:_("defaultEditor",a,l),width:40}))),e.createElement("div",{className:"gf-form"},e.createElement(L._,{labelWidth:B,label:"Disable metrics lookup",tooltip:e.createElement(e.Fragment,null,"Checking this option will disable the metrics chooser and metric/label support in the query field's autocomplete. This helps if you have performance issues with bigger Prometheus instances. ",H()),interactive:!0,disabled:a.readOnly,className:i.switchField},e.createElement(q.r,{value:a.jsonData.disableMetricsLookup??!1,onChange:(0,Be.hz)(t,"disableMetricsLookup")})))),e.createElement("h3",{className:"page-heading"},"Performance"),!a.jsonData.prometheusType&&!a.jsonData.prometheusVersion&&a.readOnly&&e.createElement("div",{className:i.versionMargin},"For more information on configuring prometheus type and version in data sources, see the"," ",e.createElement("a",{className:i.textUnderline,href:"https://grafana.com/docs/grafana/latest/administration/provisioning/"},"provisioning documentation"),"."),e.createElement("div",{className:"gf-form-group"},e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(L._,{label:"Prometheus type",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Set this to the type of your prometheus database, e.g. Prometheus, Cortex, Mimir or Thanos. Changing this field will save your current settings, and attempt to detect the version. Certain types of Prometheus support or do not support various APIs. For example, some types support regex matching for label queries to improve performance. Some types have an API for metadata. If you set this incorrectly you may experience odd behavior when querying metrics and labels. Please check your Prometheus documentation to ensure you enter the correct type. ",H()),interactive:!0,disabled:a.readOnly},e.createElement(O.Ph,{"aria-label":"Prometheus type",options:Tt,value:Tt.find(s=>s.value===a.jsonData.prometheusType),onChange:_("prometheusType",{...a,jsonData:{...a.jsonData,prometheusVersion:void 0}},s=>(wl(s,l,r),l({...s,jsonData:{...s.jsonData,prometheusVersion:void 0}}))),width:40})))),e.createElement("div",{className:"gf-form-inline"},a.jsonData.prometheusType&&e.createElement("div",{className:"gf-form"},e.createElement(L._,{label:`${a.jsonData.prometheusType} version`,labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Use this to set the version of your ",a.jsonData.prometheusType," instance if it is not automatically configured. ",H()),interactive:!0,disabled:a.readOnly},e.createElement(O.Ph,{"aria-label":`${a.jsonData.prometheusType} type`,options:Ee[a.jsonData.prometheusType],value:Ee[a.jsonData.prometheusType]?.find(s=>s.value===a.jsonData.prometheusVersion),onChange:_("prometheusVersion",a,l),width:40})))),ve.ZP.featureToggles.prometheusResourceBrowserCache&&e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form max-width-30"},e.createElement(L._,{label:"Cache level",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Sets the browser caching level for editor queries. Higher cache settings are recommended for high cardinality data sources."),interactive:!0,disabled:a.readOnly},e.createElement(O.Ph,{width:40,onChange:_("cacheLevel",a,l),options:wt,value:wt.find(s=>s.value===a.jsonData.cacheLevel)??Q.x3.Low})))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form max-width-30"},e.createElement(L._,{label:"Incremental querying (beta)",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"This feature will change the default behavior of relative queries to always request fresh data from the prometheus instance, instead query results will be cached, and only new records are requested. Turn this on to decrease database and network load."),interactive:!0,className:i.switchField,disabled:a.readOnly},e.createElement(q.r,{value:a.jsonData.incrementalQuerying??!1,onChange:(0,Be.hz)(t,"incrementalQuerying")})))),e.createElement("div",{className:"gf-form-inline"},a.jsonData.incrementalQuerying&&e.createElement(L._,{label:"Query overlap window",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Set a duration like 10m or 120s or 0s. Default of 10 minutes. This duration will be added to the duration of each incremental request."),interactive:!0,disabled:a.readOnly},e.createElement(e.Fragment,null,e.createElement(G.I,{onBlur:s=>n({...p,incrementalQueryOverlapWindow:s.currentTarget.value}),className:"width-25",value:a.jsonData.incrementalQueryOverlapWindow??bl.Ji,onChange:_("incrementalQueryOverlapWindow",a,l),spellCheck:!1}),We(p.incrementalQueryOverlapWindow,Cl,Ve))))),e.createElement("h3",{className:"page-heading"},"Other"),e.createElement("div",{className:"gf-form-group"},e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form max-width-30"},e.createElement(L._,{label:"Custom query parameters",labelWidth:B,tooltip:e.createElement(e.Fragment,null,"Add custom parameters to the Prometheus query URL. For example timeout, partial_response, dedup, or max_source_resolution. Multiple parameters should be concatenated together with an \u2018&\u2019. ",H()),interactive:!0,disabled:a.readOnly},e.createElement(G.I,{className:"width-20",value:a.jsonData.customQueryParameters,onChange:_("customQueryParameters",a,l),spellCheck:!1,placeholder:"Example: max_source_resolution=5m&timeout=10"})))),e.createElement("div",{className:"gf-form-inline"},e.createElement("div",{className:"gf-form"},e.createElement(L._,{labelWidth:B,tooltip:e.createElement(e.Fragment,null,"You can use either POST or GET HTTP method to query your Prometheus data source. POST is the recommended method as it allows bigger queries. Change this to GET if you have a Prometheus version older than 2.1 or if POST requests are restricted in your network. ",H()),interactive:!0,label:"HTTP method",disabled:a.readOnly},e.createElement(O.Ph,{width:40,"aria-label":"Select HTTP method",options:Mt,value:Mt.find(s=>s.value===a.jsonData.httpMethod),onChange:_("httpMethod",a,l)}))))),e.createElement(Sl,{options:a.jsonData.exemplarTraceIdDestinations,onChange:s=>(0,Be.tp)({onOptionsChange:l,options:a},"exemplarTraceIdDestinations",s),disabled:a.readOnly}))},Nl=t=>t?t.hasOwnProperty("currentTarget")?t.currentTarget.value:t.value:"",_=(t,a,l)=>r=>{l({...a,jsonData:{...a.jsonData,[t]:Nl(r)}})},B=30,Pl=t=>{const{options:a,onOptionsChange:l}=t,r=(0,e.useRef)(t.options.access==="direct"),o={azureAuthSupported:ve.vc.azureAuthEnabled,getAzureAuthEnabled:n=>cl(n),setAzureAuthEnabled:(n,s)=>s?ml(n):pl(n),azureSettingsUI:gl},i=(0,W.l4)(),p=pe(i);return e.createElement(e.Fragment,null,a.access==="direct"&&e.createElement(tl.b,{title:"Error",severity:"error"},"Browser access mode in the Prometheus data source is no longer available. Switch to server access mode."),e.createElement(al.E,{defaultUrl:"http://localhost:9090",dataSourceConfig:a,showAccessOptions:r.current,onChange:l,sigV4AuthToggleEnabled:ve.vc.sigV4AuthEnabled,azureAuthSettings:o,renderSigV4Editor:e.createElement(el.IW,{...t}),secureSocksDSProxyEnabled:ve.vc.secureSocksDSProxyEnabled,urlLabel:"Prometheus server URL",urlDocs:H()}),e.createElement(e.Fragment,null,e.createElement("hr",{className:p.hrTopSpace}),e.createElement("h3",{className:p.sectionHeaderPadding},"Additional settings"),e.createElement("p",{className:`${p.secondaryGrey} ${p.subsectionText}`},"Additional settings are optional settings that can be configured for more control over your data source."),e.createElement(nl,{options:a,onOptionsChange:l}),e.createElement(Tl,{options:a,onOptionsChange:l})))};function H(t){const a="https://grafana.com/docs/grafana/latest/datasources/prometheus/#configure-the-data-source";return e.createElement("a",{href:t||a,target:"_blank",rel:"noopener noreferrer"},"Visit docs for more details here.")}const We=(t,a,l)=>{const r="Value is not valid";return t&&!t.match(a)?e.createElement(ll.S,null,l||r):!0};function pe(t){return{additionalSettings:g.css`
      margin-bottom: 25px;
    `,secondaryGrey:g.css`
      color: ${t.colors.secondary.text};
      opacity: 65%;
    `,inlineError:g.css`
      margin: 0px 0px 4px 245px;
    `,switchField:g.css`
      align-items: center;
    `,sectionHeaderPadding:g.css`
      padding-top: 32px;
    `,sectionBottomPadding:g.css`
      padding-bottom: 28px;
    `,subsectionText:g.css`
      font-size: 12px;
    `,hrBottomSpace:g.css`
      margin-bottom: 56px;
    `,hrTopSpace:g.css`
      margin-top: 50px;
    `,textUnderline:g.css`
      text-decoration: underline;
    `,versionMargin:g.css`
      margin-bottom: 12px;
    `}}var Dl=m(8366);const Fl=new U.hf(Dl.vQ).setQueryEditor(_a).setConfigEditor(Pl).setQueryEditorHelp(ce)},58079:(xe,ee,m)=>{m.d(ee,{c:()=>U});var U=(e=>(e.Code="code",e.Builder="builder",e))(U||{})}}]);

//# sourceMappingURL=prometheusPlugin.2abe41df3c379d5be8bc.js.map