"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2015],{74775:(L,p,s)=>{s.r(p),s.d(p,{plugin:()=>de});var y=s(89424),a=s(66111),h=s(12006),m=s(47694);const E=e=>{const{options:t,onOptionsChange:n}=e;return a.createElement(a.Fragment,null,a.createElement(h.E,{defaultUrl:"http://localhost:7070",dataSourceConfig:t,showAccessOptions:!1,onChange:n,secureSocksDSProxyEnabled:m.vc.secureSocksDSProxyEnabled}))};var P=s(82897),O=s(68324),C=s(206),I=s(19974);const fe=Object.freeze([0,0]),M="both",z={labelSelector:"{}"};var g=s(9892),x=s(72648);function v(e){const t=(0,x.wW)((0,a.useCallback)(n=>D(n,e),[e]));return a.createElement("div",{className:t.root},e.children)}const D=(e,t)=>({root:(0,g.css)({display:"flex",flexDirection:t.direction??"row",flexWrap:t.wrap??!0?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(t.gap??2),flexGrow:t.flexGrow})}),S=({children:e,stackProps:t})=>{const n=(0,x.wW)(B);return a.createElement("div",{className:n.root},a.createElement(v,{gap:2,...t},e))},B=e=>({root:(0,g.css)({padding:e.spacing(1),backgroundColor:e.colors.background.secondary,borderRadius:e.shape.borderRadius(1)})}),W=({children:e})=>a.createElement(v,{gap:.5,direction:"column"},e);var F=s(33411),Q=s(9405);const U={id:"parca",extensions:[".parca"],aliases:["parca"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".fireql",keywords:[],operators:[],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,"tag"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"]],autoClosingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};class ${constructor(t,n,r){this.datasource=t,this.monaco=n,this.editor=r,this.triggerCharacters=["{",",","[","(","=","~"," ",'"'],this.labels={}}async init(){const t=await this.datasource.getLabelNames();this.labels=t.reduce((n,r)=>(n[r]=[],n),{})}provideCompletionItems(t,n){if(this.editor.getModel()?.id!==t.id)return{suggestions:[]};const{range:r,offset:i}=j(this.monaco,t,n),l=H(t.getValue(),i);return this.getCompletions(l).then(c=>{const f=c.length.toString().length;return{suggestions:c.map((o,u)=>({kind:V(o.type,this.monaco),label:o.label,insertText:o.insertText,sortText:u.toString().padStart(f,"0"),range:r}))}})}async getCompletions(t){if(!Object.keys(this.labels).length)return[];switch(t.type){case"UNKNOWN":return[];case"EMPTY":return Object.keys(this.labels).map(r=>({label:r,insertText:`{${r}="`,type:"LABEL_NAME"}));case"IN_LABEL_NAME":return Object.keys(this.labels).map(r=>({label:r,insertText:r,type:"LABEL_NAME"}));case"IN_LABEL_VALUE":let n=[];return this.labels[t.labelName].length?n=this.labels[t.labelName]:(n=await this.datasource.getLabelValues(t.labelName),this.labels[t.labelName]=n),n.map(r=>({label:r,insertText:t.betweenQuotes?r:`"${r}"`,type:"LABEL_VALUE"}));default:throw new Error(`Unexpected situation ${t}`)}}}function V(e,t){switch(e){case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;default:throw new Error(`Unexpected CompletionType: ${e}`)}}const T=/[a-zA-Z_][a-zA-Z0-9_]*/,A=/[^"]*/,K=new RegExp(`(${T.source})="(${A.source})"`,"g"),k=new RegExp(`(${T.source})=("?)${A.source}$`),Z=new RegExp(/[{,]\s*[a-zA-Z0-9_]*$/);function H(e,t){if(e==="")return{type:"EMPTY"};const n=e.matchAll(K),r=Array.from(n).reduce((c,f)=>{const[d,o,u]=f[1];return c.push({name:o,value:u}),c},[]),i=e.substring(0,t).match(k);return i?{type:"IN_LABEL_VALUE",labelName:i[1],betweenQuotes:!!i[2],otherLabels:r}:e.substring(0,t).match(Z)?{type:"IN_LABEL_NAME",otherLabels:r}:{type:"UNKNOWN"}}function j(e,t,n){const r=t.getWordAtPosition(n),i=r!=null?e.Range.lift({startLineNumber:n.lineNumber,endLineNumber:n.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(n),l={column:n.column,lineNumber:n.lineNumber};return{offset:t.getOffsetAt(l),range:i}}function G(e){const t=Y(e.datasource),n=(0,x.wW)(q),r=(0,F.Z)(e.onRunQuery),i=(0,a.useRef)(null);return a.createElement("div",{className:n.wrapper,ref:i},a.createElement(Q.p,{value:e.value,language:b,onBlur:e.onChange,containerStyles:n.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on",padding:{top:5,bottom:6}},onBeforeEditorMount:J,onEditorDidMount:(l,c)=>{t(l,c);const f=()=>{const d=i.current;if(d!==null){const o=l.getContentHeight();d.style.height=`${o+X}px`,d.style.width="100%";const u=d.clientWidth;l.layout({width:u,height:o})}};l.onDidContentSizeChange(f),f(),l.addCommand(c.KeyMod.Shift|c.KeyCode.Enter,()=>{r.current(l.getValue())})}}))}const X=2;function Y(e){const t=(0,a.useRef)(null);return(0,a.useEffect)(()=>()=>{t.current?.()},[]),async(n,r)=>{const i=new $(e,r,n);await i.init();const{dispose:l}=r.languages.registerCompletionItemProvider(b,i);t.current=l}}let N=!1;const b="parca";function J(e){if(N===!1){N=!0;const{aliases:t,extensions:n,mimetypes:r,def:i}=U;e.languages.register({id:b,aliases:t,extensions:n,mimetypes:r}),e.languages.setMonarchTokensProvider(b,i.language),e.languages.setLanguageConfiguration(b,i.languageConfiguration)}}const q=()=>({queryField:g.css`
      flex: 1;
      // Not exactly sure but without this the editor doe not shrink after resizing (so you can make it bigger but not
      // smaller). At the same time this does not actually make the editor 100px because it has flex 1 so I assume
      // this should sort of act as a flex-basis (but flex-basis does not work for this). So yeah CSS magic.
      width: 100px;
    `,wrapper:g.css`
      display: flex;
      flex: 1;
      border: 1px solid rgba(36, 41, 46, 0.3);
      border-radius: 2px;
    `});var _=s(95831),ee=s(39904),te=s(24799),ne=s(2594);const w=[{value:"metrics",label:"Metric",description:"Return aggregated metrics"},{value:"profile",label:"Profile",description:"Return profile"},{value:"both",label:"Both",description:"Return both metric and profile data"}];function ae(e){return e===C.zj.Explore?w:w.filter(t=>t.value!=="both")}function re({query:e,onQueryTypeChange:t,app:n}){const[r,i]=(0,_.Z)(!1),l=(0,x.wW)(se),c=ae(n);return a.createElement(v,{gap:0,direction:"column"},a.createElement("div",{className:l.header,onClick:i,title:"Click to edit options"},a.createElement("div",{className:l.toggle},a.createElement(ee.J,{name:r?"angle-down":"angle-right"})),a.createElement("h6",{className:l.title},"Options"),!r&&a.createElement("div",{className:l.description},a.createElement("span",null,"Type: ",e.queryType))),r&&a.createElement("div",{className:l.body},a.createElement(te.g,{label:"Query Type"},a.createElement(ne.S,{options:c,value:e.queryType,onChange:t}))))}const se=e=>({switchLabel:(0,g.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}}),header:(0,g.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:e.colors.text.primary,"&:hover":{background:e.colors.emphasize(e.colors.background.primary,.03)}}),title:(0,g.css)({flexGrow:1,overflow:"hidden",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,margin:0}),description:(0,g.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,paddingLeft:e.spacing(2),gap:e.spacing(2),display:"flex"}),body:(0,g.css)({display:"flex",paddingTop:e.spacing(2),gap:e.spacing(2),flexWrap:"wrap"}),toggle:(0,g.css)({color:e.colors.text.secondary,marginRight:`${e.spacing(1)}`})}),oe={...z,queryType:M};function le(e){const[t,n]=(0,a.useState)([]);function r(o,u){if(u.length===0)return;const R=u[u.length-1].value;if(typeof R!="string")throw new Error("id is not string");e.onChange({...e.query,profileTypeId:R})}function i(o){e.onChange({...e.query,labelSelector:o})}function l(o){e.onChange({...e.query,labelSelector:o}),e.onRunQuery()}(0,O.Z)(async()=>{const o=await e.datasource.getProfileTypes();n(o)});const c=(0,a.useMemo)(()=>{let o=new Map;for(let u of t)o.has(u.name)||o.set(u.name,{label:u.name,value:u.ID,children:[]}),o.get(u.name)?.children?.push({label:u.sample_type,value:u.ID});return Array.from(o.values())},[t]),f=(0,a.useMemo)(()=>{if(!t)return"Loading";const o=t.find(u=>u.ID===e.query.profileTypeId);return o?o.name+" - "+o.sample_type:"Select a profile type"},[e.query.profileTypeId,t]);let d=ie(e.query,e.app);return a.createElement(W,null,a.createElement(S,{stackProps:{wrap:!1,gap:1}},a.createElement(I.O,{onChange:r,options:c,buttonProps:{variant:"secondary"}},f),a.createElement(G,{value:d.labelSelector,onChange:i,datasource:e.datasource,onRunQuery:l})),a.createElement(S,null,a.createElement(re,{query:d,onQueryTypeChange:o=>{e.onChange({...d,queryType:o})},app:e.app})))}function ie(e,t){let n=(0,P.defaults)(e,oe);return t!==C.zj.Explore&&n.queryType==="both"&&(n.queryType="profile"),n}var ue=s(59980),ce=s(22069);class ge extends ce.CK{constructor(t){super(t)}query(t){return t.targets.every(n=>n.profileTypeId)?super.query(t):(0,ue.of)({data:[]})}async getProfileTypes(){return await super.getResource("profileTypes")}async getLabelNames(){return await super.getResource("labelNames")}async getLabelValues(t){return await super.getResource("labelValues",{label:t})}}const de=new y.hf(ge).setConfigEditor(E).setQueryEditor(le)},33411:(L,p,s)=>{s.d(p,{Z:()=>h});var y=s(66111),a=function(m){var E=(0,y.useRef)(m);return E.current=m,E};const h=a},68324:(L,p,s)=>{s.d(p,{Z:()=>h});var y=s(49380),a=function(m){(0,y.Z)(function(){m()})};const h=a}}]);

//# sourceMappingURL=parcaPlugin.dc541f8e66bb87f77612.js.map